@(args: mdr.ISysMdrForAdTplArgs)(implicit ctx: Context)

@* Страница с модерацией одной рекламной карточки. *@

@import lk.adv.widgets._
@import views.html.sc.foc._adFullTpl
@import ctx.{messages, request}
@import helper._
@import args.adId
@import mdr.MdrSearchArgs

@* Верста кнопки подтверждения размещения. *@
@__approveBtn(call: Call) = {
  @form( CSRF(call) ) {
    <input class="fast-approve-ibtn" type="submit" value="[+]" title="@messages("Approve")" />
  }
}


@* Верстка кнопки отказа в размещении. *@
@__refuseBtn(call: Call) = {
  <a class="js-btn" href="@CSRF(call)">
    &lt;!&gt;
  </a>
}


@* Верстка контейнера куска содержимого левой колонки. *@
@__leftFrame(content: Html) = {
  <div class="node-mdr_left-bar_frame">
    @content
  </div>
}


@mdrBase(
  title     = args.brArgs.mad.guessDisplayNameOrIdOrEmpty,
  mnodeOpt  = Some(args.producer)
) {

  @* Колонка содержит item'ы, требующие модерации. *@
  <div class="mdr node-mdr_left-bar">

    @__leftFrame {
      <a href="@routes.SysMarket.showAdnNode(args.producer.id.get)">
        [Продьюсер]
      </a>
      <a href="@routes.MarketAd.editAd(args.brArgs.mad.id.get)">
        [Редактор]
      </a>
    }

    @__leftFrame {
      @if(!args.freeAdvs && !args.mitemsGrouped) {
        Карточка не нуждается в модерации.
      }
    }


    @* Отображаем бесплатные пост-модерируемые размещения. *@
    @if(args.freeAdvs) {
      @__leftFrame {
        <h2 title="Размещение у самого себя является бесплатным.">Бесплатные</h2>
        @for(medge <- args.freeAdvs) {

          @__approveBtn( routes.SysMdr.freeAdvMdrAccept(adId) )

          @messages(medge.predicate.singular)

          @for(mnode <- args.mnodesMap.get(medge.nodeId); nodeId <- mnode.id) {
            <a href="@routes.SysMarket.showAdnNode(nodeId)">
              @mnode.guessDisplayNameOrId
            </a>
          }

          @__refuseBtn( routes.SysMdr.refuseFreeAdvPopup(adId) )
        }
      }
    }


    @* Рисуем список платных премодерируемых размещений. *@
    @if(args.mitemsGrouped) {
      @__leftFrame {
        <h2 title="Платные размещения данной карточки.">Платные</h2>
        @for((itype, mitems) <- args.mitemsGrouped) {
          <div class="mdr-item-group">
            <h3>@messages( itype.nameI18n )</h3>
            @for(mitem <- mitems; itemId <- mitem.id) {
              <div class="mdr-item">
                @__approveBtn( routes.SysMdr.approveItemSubmit(itemId) )

                @* Для тега вывести название тега, завернув его в ссылку, если возможно... *@
                @for(rcvrId <- mitem.rcvrIdOpt) {
                  <a href="@routes.SysMarket.showAdnNode(rcvrId)">
                }

                @mitem.tagFaceOpt.map { tagFace =>
                  #@tagFace
                }.getOrElse {
                  @for(rcvr <- mitem.rcvrIdOpt.flatMap(args.mnodesMap.get)) {
                    @rcvr.guessDisplayNameOrId
                  }
                }

                @if(mitem.rcvrIdOpt) {
                  </a>
                }
                @__refuseBtn( routes.SysMdr.refuseItemPopup(itemId) )
              </div>
            }
          </div>
        }
      }
    }


    @* Ссылка для перехода на другую карточку, подлежащую модерации. *@
    @__leftFrame {
      <h2>Переход</h2>
      <a href="@routes.SysMdr.rdrToNextAd( MdrSearchArgs(hideAdIdOpt = args.brArgs.mad.id) )">
        Следующая карточка &gt;&gt;&gt;
      </a>
    }

  </div> @* bar-left *@


  <div class="node-mdr_right-bar">
    @* TODO Надо not-focused ad сюда ещё, если карточка отображается на шировакую... *@
    <div class="ad-full-preview">
      <div class="sio-mart-showcase __relative">
        @_adFullTpl( args )
      </div>
    </div>

  </div>

}
