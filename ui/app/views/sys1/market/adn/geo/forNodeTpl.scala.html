@(mnode: MNode, geos: Seq[MAdnNodeGeo], parentsMap: Map[String, MNode], mapStateHash: Option[String] = None)(implicit ctx: Context)

@* Вывод гео-информации по узлу. *@

@import ctx._
@import datetime._
@import stuff._

@* Отрендерить список нод на основе списка id нод. Используется карта parentsMap для доступа к инфе по узлу. *@
@_renderNodes(nodesIds: TraversableOnce[String]) = {
  @nodesIds.map { parentId =>
    <a href="@routes.SysMarket.showAdnNode(parentId)">
      @parentsMap.get(parentId).fold {
        @parentId
      } { parentNode =>
        <span title="@parentNode.meta.town / @parentId">
          @parentNode.meta.basic.name
        </span>
      }
    </a>,
  }
}

@* Рендер одного списка узлов-геородителей. *@
@_renderGeoParents(p: MPredicate, title: String, label: String) = {
  @defining( mnode.edges.withPredicateIterIds(p) ) { parentIdsIter =>
    @if( parentIdsIter.nonEmpty ) {
      <p>
        <span title="@title">
          @label
        </span>
        @_renderNodes( parentIdsIter )
      </p>
    }
  }
}


@* Рендер самой страницы. *@
@geoBase("География узла", nodeOpt = Some(mnode)) {

  <h2>
    <a href="@routes.Umap.getAdnNodeMap(mnode.id.get)@mapStateHash">Картографический редактор...</a>
    (@geos.iterator.filter(_.shape.shapeType.isGeoJsonCompatible).size отображаемых фигур)
  </h2>
  <br/>

  <h1>
    География узла
    <a href="@routes.SysMarket.showAdnNode(mnode.id.get)">
      @mnode.meta.basic.name
    </a>
  </h1>

  <p>Географическая информация узла -- это геометрические фигуры в координатах поверхности земли. Они тяжеловесные, и
     хранятся отдельно от родительского узла, в той же шарде узла, но в отдельной модели.</p>
  @if(geos.nonEmpty) {
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>URL</th>
          <th>Level</th>
          <th>Shape</th>
          <th>Last-Modified</th>
          <th>version</th>
          <th>Другое</th>
        </tr>
      </thead>
      <tbody>
        @geos.map { geo =>
          <tr>
            <td><span title="@geo.id">@geo.id.get.substring(0, 4)...</span></td>
            <td>@geo.url.map { url =><a href="@url" target="_blank">Go</a>}</td>
            <td>@geo.glevel.precision</td>
            <td>
              <a href="@routes.SysAdnGeo.showGeoJson(geo.id.get, geo.adnId)">
                <span title='@geo.shape'>@geo.shape.getClass.getSimpleName</span>
              </a>
            </td>
            <td>@_prettyDate(geo.lastModified)</td>
            <td>@geo.versionOpt</td>
            <td>
              @if(!geo.shape.shapeType.isGeoJsonCompatible) {
                <span title="Круги и прямоугольники не совместимо со стандартном GeoJSON, поэтому не отображаются в картографическом редакторе фигур.">
                  НЕ отображается на карте.
                </span>
              }
              <a href="@if(geo.isCircle){@routes.SysAdnGeo.editCircle(geo.id.get, geo.adnId)} else {@routes.SysAdnGeo.editNodeOsm(geo.id.get, geo.adnId)}">@messages("Edit")</a>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }

  <p>
    <a href="@routes.SysAdnGeo.createForNodeOsm(mnode.id.get)">Добавить OSM-контур к этому узлу...</a>
  </p>

  <p>
    <a href="@routes.SysAdnGeo.createCircle(mnode.id.get)">Добавить круг...</a>
  </p>

  <p>
    <a href="http://geojsonlint.com/">Визуальная проверка GeoJSON.</a>
  </p>


  <br/><br/>
  <h1>Геоданные узла</h1>
  <p>Геоданные узла хранятся и индексируются в самом узле.</p>

  @if(mnode.geo.isEmpty) {
    Отсутствуют.
    <a href="@routes.SysAdnGeo.editAdnNodeGeodataPropose(mnode.id.get)">Попробовать автозаполнение геоданных...</a>

  } else {

    @mnode.geo.point.map { point =>
      @* TODO Почему-то маркер точки не подсвечивается на карте, поэтому используем большое увеличение (18) и отметку по центру. *@
      <span title="Примитивная координата, до которой можно измерить расстояние или использовать при сортировки по расстоянию. Например географический центр узла.">
        Координата:
      </span>
      <a href="http://www.openstreetmap.org/#map=18/@point.lat/@point.lon" target="_blank" title="Открыть карту в новой вкладке. Цель будет в центре.">
        <span title="(lat, lon), т.е. (широта, долгота) в WGS84.">
          (@point.lat, @point.lon)
        </span>
      </a>
      <br/>
    }

    @_renderGeoParents(
      p = MPredicates.GeoParent.Direct,
      title = "Прямые родители узла в географическом плане.",
      label = "Геородительские узлы:"
    )

    @_renderGeoParents(
      p = MPredicates.GeoParent,
      title = "Все географически родительские узлы. Т.е. прямые родители и все их геородители.",
      label = "Все геородительские узлы:"
    )

  }

  <a href="@routes.SysAdnGeo.editAdnNodeGeodata(mnode.id.get)">Редактировать...</a>

}
