@(mnode: MNode, args: msys.ISysAdnNodeBillingArgs)(implicit ctx: Context)

@* Страница с информацией по биллингу указанного узла рекламной сети. *@
@import datetime._
@import io.suggest.vlines.VLines
@import ctx._
@import stuff._
@import args._
@import util.TplDataFormatUtil._
@import models.stat.AdStatActionsTpl._
@import lk.lkBlock

@billingBase("Биллинг", Some(mnode)) {

  @balanceOpt.map { balance =>
    <p class="paragraph __size-M color-light-strong">
      Текущий баланс: <strong class="color-strong">@balance.amount @balance.currencyCode</strong>
    </p>
  }

  @lkBlock( s"Контракты(${contracts.size})" ) {

    @if(contracts.isEmpty) {
      <p>Пока нет заключенных договоров.</p>
    } else {
      @contracts.map { contract =>

        <div class="paragraph __size-M">
          <p>
            Договор № <strong class="ft-M color-strong">@contract.legalContractId</strong>
          </p>
          <a class="blue-link" href="@routes.SysMarketBilling.editContractForm(contract.id.get)">Изменить...</a>
          <br/>Дата заключения договора:
              @contract.printContractDate
              (@_prettyDate(contract.contractDate, withSpan = true))
          <p>Добавлен в sio: @_prettyDate(contract.dateCreated, withSpan = true)</p>
          @if(!contract.isActive) {
            <br/><b>Не активен</b>.
          }
          @contract.hiddenInfo.map { hiddenInfo =>
            <br/>Служебная информация:
            <pre>@hiddenInfo</pre>
          }

          <br/><br/>


          @* Рендер посуточных mmp-тарификаторов *@
          <div>
          @defining(dailyMmpsMap.get(contract.id.get) getOrElse Nil) { dmmps =>
            @if( dmmps.nonEmpty ) {
              <h4>Тарифные планы размещения рекламы посуточные (@dmmps.size)</h4>
              <table>
                <tr>
                  <th>#</th>
                  <th>Валюта</th>
                  <th>Будни</th>
                  <th>Выходные</th>
                  <th>Прайм</th>
                  <th>Действия</th>
                </tr>
                @dmmps.map { dmmp =>
                  <tr>
                    <td>@dmmp.id</td>
                    <td>@dmmp.currencyCode</td>
                    <td>@dmmp.mmpWeekday</td>
                    <td>@dmmp.mmpWeekend</td>
                    <td>@dmmp.mmpPrimetime</td>
                    <td>
                        <a class="blue-link" href="@routes.SysMarketBillingMmp.editMmpDaily(dmmp.id.get)">Редактировать</a>
                    </td>
                  </tr>
                }
              </table>
            }

            <a class="blue-link" href="@routes.SysMarketBillingMmp.createMmpDaily(contract.id.get)">Создать посуточный mmp-тарифный план...</a>
          }
          </div>

          <br/><br/>


          @* Рендер тарификаций за используемую выдачу. *@
          <div>
            @defining(sinkComissionMap.getOrElse(contract.id.get, Nil)) { mscs =>
              @* Рендерим плашку, сообщающую о неисправности узла в связи с отсутствием ожидаемого тарифа. *@
              @if( mnode.extras.adn.exists(_.isReceiver) ) {
                @defining( mnode.extras.adn.fold( Set.empty[AdnSink] )(a => a.sinks -- mscs.map(_.sink)) ) { missingSinks =>
                  @missingSinks.map { sink =>
                    <p class="error">Необходимо <a href="@routes.SysMarketBilling.createSinkCom(contract.id.get)">добавить тариф</a> на выдачи: @messages("adn.sink." + sink.longName)!<p/>
                  }
                }
              }
              @if( mscs.nonEmpty ) {
                <h4>Тарифные планы выдач</h4>
                <table>
                  <tr>
                    <th>#</th>
                    <th>sink</th>
                    <th>Комиссия s.io</th>
                    <th>Другое</th>
                  </tr>
                  @mscs.map { msc =>
                    <tr>
                      <td>@msc.id</td>
                      <td>@messages("adn.sink." + msc.sink.longName)</td>
                      <td>@msc.sioComission</td>
                      <td>
                        <a href="@routes.SysMarketBilling.editSinkCom(msc.id.get)">@messages("Edit")</a>
                        @if( !mnode.extras.adn.exists(_.sinks.contains(msc.sink)) ) {
                          Это тариф НЕ используется: узел не имеет доступа к @messages("adn.sink." + msc.sink.longName).
                        }
                      </td>
                    </tr>
                  }
                </table>
              }
            }
          </div>
          <a href="@routes.SysMarketBilling.createSinkCom(contract.id.get)">Создать новый тариф поисковой выдачи...</a>

          <br/><br/>


          @defining(feeTariffsMap.get(contract.id.get).getOrElse(Nil)) { tariffs =>
            @if( !tariffs.isEmpty ) {
              <h4 title="Тарифы абон.платы используются для периодического списания денег со счета по договору.">
                Абон.плата по договору @contract.legalContractId (@tariffs.size)
              </h4>
              <table>
                <tr>
                  <th>#</th>
                  <th>Активен?</th>
                  <th>Имя</th>
                  <th>Интервал</th>
                  <th>Абон.плата</th>
                  <th>Старт</th>
                  <th>Действия</th>
                </tr>
                @tariffs.map { tariff =>
                  @defining(contract.isActive && tariff.isEnabled) { te =>
                  <tr>
                    <td>@tariff.id</td>
                    <td>@tariff.isEnabled</td>
                    <td>@tariff.name</td>
                    <td>@_maybeTagged("strike", !te) {@tariff.tintervalPretty}</td>
                    <td>@tariff.fee @tariff.feeCC</td>
                    <td>@_maybeTagged("strike", !te) {@datetime._prettyDate(tariff.dateFirst, withSpan = true)}</td>
                    <td>
                      <a class="blue-link" href="@routes.SysMarketBillingTariff.editFeeTariffForm(tariff.id.get)">@messages("Edit")</a>
                    </td>
                  </tr>
                  }
                }
              </table>
            }
          } @* defining tariffs *@
          <a class="blue-link" href="@routes.SysMarketBillingTariff.addFeeTariffForm(contract.id.get)">Добавить абонплату...</a>

          <br/><br/>


          @defining( statTariffsMap.getOrElse(contract.id.get, Nil) ) { tariffs =>
            @if( tariffs.nonEmpty ) {
              <h4 title="Схемы тарификации по просмотрам/переходам используются для освоения денег на балансе в полуреальном времени.">
                Тарификация узла за просмотры/переходы по собственным карточкам.
              </h4>
              <table>
                <tr>
                  <th>#</th>
                  <th>Активен?</th>
                  <th>Имя</th>
                  <th>Старт</th>
                  <th>Стоимость</th>
                  <th>Списано</th>
                  <th>Действия</th>
                </tr>
                @tariffs.map { tariff =>
                  @defining(contract.isActive && tariff.isEnabled) { te =>
                    <tr>
                      <td>@tariff.id</td>
                      <td>@tariff.isEnabled</td>
                      <td>@tariff.name</td>
                      <td>@_maybeTagged("strike", !te) {@datetime._prettyDate(tariff.dateFirst, withSpan = true)}</td>
                      <td>@_maybeTagged("strike", !te) {@formatPrice(tariff.debitAmount, tariff.currency) за @messages(tariff.debitFor.i18nCode)}</td>
                      <td>@tariff.debitCount.toInt / @tariff.debitedTotal @tariff.currencyCode</td>
                      <td>
                        <a class="blue-link" href="@routes.SysMarketBillingTariff.editStatTariff(tariff.id.get)">@messages("Edit")</a>
                      </td>
                    </tr>
                  }
                }
              </table>
            }
          }
          <a class="blue-link" href="@routes.SysMarketBillingTariff.addStatTariff(contract.id.get)">Добавить тарификацию за просмотры/переходы...</a>

        </div>

      } @* contract *@

    }

  }

  <div class="btn-w __between-blocks">
    <a class="siom-ac-btn __color-1 __size-M __ft-XM f-left" href="@routes.SysMarketBilling.createContractForm(mnode.id.get)">Создать контракт...</a>
  </div>

  @lkBlock("Транзакции("+txns.size+")") {

    @if( txns.nonEmpty ) {
      <table class="siom-table __size-XL">
        <tr>
          <th class="siom-cell-head __bg-head">
            <div class="siom-cell-cnt __size-S"> id </div>
            <div class="border-line"></div>
          </th>
          <th></th>
          <th class="siom-cell-head __bg-head">
            <div class="siom-cell-cnt __size-S"> Оплачен </div>
            <div class="border-line"></div>
          </th>
          <th></th>
          <th class="siom-cell-head __bg-head">
            <div class="siom-cell-cnt __size-S"> Обработан </div>
            <div class="border-line"></div>
          </th>
          <th></th>
          <th class="siom-cell-head __bg-head">
            <div class="siom-cell-cnt __size-S"> Сумма </div>
            <div class="border-line"></div>
          </th>
          <th></th>
          <th class="siom-cell-head __bg-head">
            <div class="siom-cell-cnt __size-S"> Комментарий </div>
            <div class="border-line"></div>
          </th>
        </tr>
        @txns.map { txn =>
          <tr>
            <td class="siom-table_vertical-cnt">
              <div class="siom-cell-cnt __size-L">
                @txn.txnUid
              </div>
              <div class="border-line"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="border-line __vertical @VLines.JSVL_CLASS"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="siom-cell-cnt __size-L">
                @_prettyDate(txn.datePaid, withSpan = true)
              </div>
              <div class="border-line"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="border-line __vertical @VLines.JSVL_CLASS"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="siom-cell-cnt __size-L">
                @_prettyDate(txn.dateProcessed, withSpan = true)
              </div>
              <div class="border-line"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="border-line __vertical @VLines.JSVL_CLASS"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="siom-cell-cnt __size-L">
                <strong class="@if(txn.amount < 0) {color-error} else {color-success}">
                  @txn.amount @txn.currencyCode
                </strong>
              </div>
              <div class="border-line"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="border-line __vertical @VLines.JSVL_CLASS"></div>
            </td>
            <td class="siom-table_vertical-cnt">
              <div class="siom-cell-cnt __size-L">
                @txn.paymentComment
              </div>
              <div class="border-line"></div>
            </td>
          </tr>
        }
      </table>
    } else {
      Нет транзакций.
    }

  }

  <a class="siom-ac-btn __color-1 __size-M __ft-XM f-left" href="@routes.SysMarketBilling.incomingPaymentForm">Провести платёж...</a>

}
