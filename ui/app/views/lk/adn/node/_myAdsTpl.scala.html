@(args: mlk.INodeAdsTplArgs)(implicit ctx: Context)

@* Список рекламных карточек для создателя рекламы. В нём галочки есть. *@
@import adv._
@import views.html.lk.ad._
@import ctx._
@import args._
@import ctx.api.{n2NodesUtil => n2n}

@* Флаг single переименовывает единственную галочку "Выводить". *@
@defining( mnode.extras.adn.map(_.out4render).getOrElse(Nil) ) { outLvlMap =>

  @* Раскрыть для скриптов текущую информацию о лимитах по кол-ву объяв на доступных уровнях отображения. *@
  @outLvlMap.map { msl =>
    <input id="maxShownAds_@msl.sl" type="hidden" value="@msl.limit"/>
  }

  @_adsListOuterTpl {

    @helper.javascriptRouter("jsRoutes")(
      routes.javascript.MarketAd.updateShowLevelSubmit
    )


    <a class="add-adv-btn f-left" href="@routes.MarketAd.createAd(mnode.id.get)">
      <span>@Html( messages("Create.ad", "<br/>") )</span>
    </a>

    @defining(outLvlMap.size == 1) { isSingleOutLvl =>
      @_adsListTpl(mads, coverDisableReason = true) { mad =>

        <div class="js-equal-height">

	        @* Карточку можно редактировать всегда. Раньше нельзя было редактировать размещенную. *@
          <a class="adv-item_edit-btn" href="@routes.MarketAd.editAd(mad.id.get)">
            <span></span>
          </a>

          @* Галочки для управления отображением рекламной карточки магазина.
             Отображаются, если модератор не запретил бесплатное размещение этой карточки. *@
          @n2n.mdrs(mad).toStream.headOption.fold {

            @* Бесплатное размещение не запрещено. *@
            <div class="ads-list-block__controls">
              @defining( mnode.id.flatMap(n2n.findReceiver(mad, _)).map(_.info.sls).getOrElse(Set.empty).map(_.sl) ) { adSls =>
                @* Обходим данные по out-уровня, превращая её в список галочек. *@
                @outLvlMap.map { msl =>
                  @defining(mnode.common.isEnabled && msl.allowed) { hl =>
                    <label class="@msl.sl.checkboxCssClass@if(!msl.allowed){ inactive}">
                      <input class="@if(msl.limit == 1){js-one-}checkbox" type="checkbox"
                             data-level="@msl.sl" data-adid="@mad.id" data-name="@msl.sl.checkboxCssClass"
                             @if(!msl.allowed) {disabled="disabled"}
                             @if(adSls.contains(msl.sl)) {checked="checked"}
                             />
                            <span class="styled-checkbox"></span>&nbsp;@messages(if(isSingleOutLvl) "lk.sl.enable_ad" else ("lk.sl." + msl.sl.name))
                    </label>
                  }
                }
              }
            </div>
          } { faMdr =>
            @* Модератор запретил бесплатное размещение указанное карточки. *@
            @faMdr.info.commentNi
          }

        </div> @* js-equal-height *@

        @if(canAdv) {
          <a class="btn __size-XM __radial-major" href="@routes.LkAdvExt.forAd(mad.id.get)">
            @messages("ad.Manage")
          </a>
        }


      } @* ads list*@
    }

    <div class="clear"></div>
  }
}
