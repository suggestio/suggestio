@(args: mlk.IAdsListTplArgsMy)(implicit ctx: Context)

@* Список рекламных карточек для создателя рекламы. В нём галочки есть. *@
@import adv._
@import views.html.lk.ad._
@import ctx._
@import args._

@* Флаг single переименовывает единственную галочку "Выводить". *@
@defining( mnode.extras.adn.map(_.out4render).getOrElse(Nil) ) { outLvlMap =>

  @* Раскрыть для скриптов текущую информацию о лимитах по кол-ву объяв на доступных уровнях отображения. *@
  @outLvlMap.map { msl =>
    <input id="maxShownAds_@msl.sl" type="hidden" value="@msl.limit"/>
  }

  @_adsListOuterTpl {

    @helper.javascriptRouter("jsRoutes")(
      routes.javascript.MarketAd.updateShowLevelSubmit
    )


    <a class="add-adv-btn f-left" href="@routes.MarketAd.createAd(mnode.id.get)">
      <span>@Html( messages("Create.ad", "<br/>") )</span>
    </a>

    @defining(outLvlMap.size == 1) { isSingleOutLvl =>
      @_adsListTpl(mads, coverDisableReason = true) { mad =>

        <div class="js-equal-height">
        @ad2advMap.get(mad.id.get).fold {
          <a class="adv-item_edit-btn" href="@routes.MarketAd.editAd(mad.id.get)">
            <span></span>
          </a>
        } { adv =>
            @adv match {
              case advReq: MAdvReq => {
                <a class="adv-item_status __request js-btn" href="@routes.MarketAdv.advFullWnd(mad.id.get, advId = adv.id, r = ctx.r)"></a>
              }
              case advOk: MAdvOk => {
                <a class="adv-item_status __ok js-btn" href="@routes.MarketAdv.advFullWnd(mad.id.get, advId = adv.id, r = ctx.r)"></a>
              }
              case advRefused: MAdvRefuse => {
                @* Этот код по идее никогда не должен выполняться: *@
                Отказано<br/>в размещении
              }
            }
            @* Суперюзеры могут редактировать даже опубликованные карточки. *@
            @if(ctx.isSuperuser) {
              <a class="adv-item_edit-btn" href="@routes.MarketAd.editAd(mad.id.get)">@messages("Edit")</a>
            }
        }

        @* Галочки для управления отображением рекламной карточки магазина.
           Отображаются, если модератор не запретил бесплатное размещение этой карточки. *@
        @mad.moderation.freeAdv.filter(!_.isAllowed).fold {

          @* Бесплатное размещение не запрещено. *@
          <div class="ads-list-block__controls">
            @defining( mad.receivers.get(mnode.id.get).map(_.allShowLevels).getOrElse(Set.empty) ) { adSls =>
              @* Обходим данные по out-уровня, превращая её в список галочек. *@
              @outLvlMap.map { msl =>
                @defining(mnode.common.isEnabled && msl.allowed) { hl =>
                  <label class="@msl.sl.checkboxCssClass@if(!msl.allowed){ inactive}">
                    <input class="@if(msl.limit == 1){js-one-}checkbox" type="checkbox"
                           data-level="@msl.sl" data-adid="@mad.id" data-name="@msl.sl.checkboxCssClass"
                           @if(!msl.allowed) {disabled="disabled"} @if(adSls contains msl.sl) {checked="checked"}
                           />
                          <span class="styled-checkbox"></span>&nbsp;@messages(if(isSingleOutLvl) "lk.sl.enable_ad" else ("lk.sl." + msl.sl.name))
                  </label>
                }
              }
            }
          </div>
        } { faMdr =>
          @* Модератор запретил бесплатное размещение указанное карточки. *@
          @faMdr.reason
        }
        </div>
        @if(canAdv) {
          <a class="btn __size-XM __radial-major" href="@routes.LkAdvExt.forAd(mad.id.get)">
            @messages("ad.Manage")
          </a>
        }


      } @* ads list*@
    }

    <div class="clear"></div>
  }
}
