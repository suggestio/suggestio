@(args: adv.direct.IAdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._
@import AdnShownTypes._
@import lk.dsl._
@import lk.adv.widgets._

@* sink show level checkbox - базовая верстка чекбокса уровней отображения по любому из измерений. *@
@sslCheckbox(maybeBusyAdv: Option[adv.MAdvI], midOpt: Option[Int], fnSuffix: String, label: String, showLevel: Option[String] = None)(busyAttrs: => Html) = {
  <label class="block">
    <input type="checkbox"
      @if(showLevel){data-show-level="@showLevel"}
      @maybeBusyAdv.fold {
        @* Рендер аттрибутов инпута когда существующего размещения ещё нет (т.е. всё можно размещать). *@
        name="node[@midOpt].@fnSuffix"
        value="false"
      } { busyAdv =>
        @* Рендер атрибутов инпута, если размещение уже было сделано ранее. *@
        value="true"
        disabled="disabled" @busyAttrs
      }
    /><span class="checkbox_title">@label</span>
  </label>
}

@* Генератор чекбоксов, задающих/с заданными уровнями отображения. *@
@slCheckbox(maybeBusyAdv: Option[adv.MAdvI], midOpt: Option[Int], fnSuffix: String, sl: AdShowLevel, label: String, showLevel: String) = {
  @* TODO Генерить label на основе sl. *@
  @sslCheckbox(maybeBusyAdv, midOpt, fnSuffix, label, Some(showLevel)) {
    @if(maybeBusyAdv.exists(_ hasOnAdSl sl)) {checked="checked"}
  }
}


@* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
@args.af.globalError.map { ge =>
  <p>@messages("Problem.occured"): @messages(ge.message, ge.args : _*)</p>
}

@form( CSRF(routes.MarketAdv.advFormSubmit(adId)), 'id->"advsForm", 'class->"adv-management_main-form") {
@*form(routes.MarketAdv.getAdvPriceSubmit(adId)) *@   @* Сабмит для получения стоимости текущей конфигурации размещения. *@
  <input type="hidden" value="@routes.MarketAdv.getAdvPriceSubmit(adId)" id="advsPriceUpdateUrl">

  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.user.isSuper) {
    @_advSuTpl()
  }

  @_barTpl(MHands.Left) {

    @_minorTitleTpl() {
      @messages("City.place.choose")
    }

      @* Список городов. *@
      @lk.lkBlockNewDesign( open = false ) {
        <div class="js-city">
          <span class="checkbox_title __major __no-input">@messages("Select.town")</span>
        </div>
      } {
        @args.cities.map { city =>
          <div class="adv-management_city-i js-select-city" data-value="@city.i">
            @city.node.meta.basic.name
          </div>
        }
      }

      @* Списки-вкладки категорий в городах. *@
      @args.cities.map { city =>
        <div class="select-tab_lst js-select-type_w" data-city="@city.i">
          <div class="select-tab_i js-select-type" data-value="-1">
            <label><input type="checkbox"/><span class="styled-checkbox"></span></label>
            <span class="select-tab_i-title">@messages("All.places")</span>
          </div>
          @city.cats.map { cat =>
            <div class="select-tab_i js-select-type" data-value="@cat.i">
              <label><input type="checkbox"/><span class="styled-checkbox"></span></label>
              <span class="select-tab_i-title">@cat.name</span>
              <span class="js-active-nodes-count"></span>
            </div>
          }
        </div>
      }

      @* Рендер списков узлов в городах. *@
      @args.cities.map { city =>
        @city.cats.map { cat =>
          <div class="select-tab_lst js-select-node_w" data-city="@city.i" data-type="@cat.i">
            <h3 class="adv-management_cat-title">@cat.name</h3>
            @cat.nodes.map { an =>
              @defining( an.node.id.get ) { adnId =>
              @defining( args.adnId2formIndex.get(adnId) ) { midOpt =>
              @defining( args.busyAdvs get adnId ) { maybeBusyAdv =>
                @if(maybeBusyAdv.isEmpty) {
                  @lk.lkBlockNewDesign( open = false ) {
                    <label>
                      <input type="checkbox" name="node[@midOpt].advertise" value="false"/>
                      <span class="styled-checkbox"></span>
                    </label>
                    <input type="hidden" name="node[@midOpt].adnId" value="@adnId"/>
                    <span class="checkbox_title __major">
                      @an.node.meta.basic.name
                    </span>
                    <a class="slide-block_info-btn js-btn" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(adnId)">i</a>
                  } {
                    <div class="advm-node_block">
                      <div class="advm-node_left">
                        <p class="block">@messages("Adv.levels")</p>
                        <div class="block __margin-XS">
			  @_delimTpl()
                        </div>
                        @* Галочки уровней отображения. *@
                        @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onStartPage", AdShowLevels.LVL_START_PAGE, messages("Main.screen"), "onStartPage")
                        @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onRcvrCat", AdShowLevels.LVL_CATS, messages("Product.categories"), "onRcvrCat")
                        <div class="block __margin-XS">@_delimTpl()</div>
                        <label class="block">
                          <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">@messages("Catalog")</span>
                        </label>
                      </div>
                    </div>
                  }
                } else {
                  <div class="slide-block_title">
                    <span class="checkbox_title __major">
                      <a href="#" class="link">@an.node.meta.basic.name</a>
                    </span>
                    <span class="ft-S light-gray"> (@messages("advertised"))</span>
                  </div>
                }
              } @* lkBlockNewDesign cnt *@
              } @* mid *@
              } @* adnId *@
            } @* node in cat *@
          </div>
        } @* cat in city *@
      } @* city *@

  } @* adv-management_left-bar *@


  @_barTpl(MHands.Right) {

    @* Даты (период) размещения. *@
    @_minorTitleTpl() {
      @messages("Date.choosing")
    }
    @_datesPeriodTpl( args.af("period"), args.advPeriodsAvail )

    @* Массовое вывставление уровней отображения. *@
    @_slsOverallTpl()

  }

}

