@(args: adv.direct.IAdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._
@import AdnShownTypes._
@import lk.adv.widgets._
@import io.suggest.adv.direct.AdvDirectFormConstants._


@* sink show level checkbox - базовая верстка чекбокса уровней отображения по любому из измерений. *@
@sslCheckbox(maybeBusyAdv: Option[adv.MAdvI], midOpt: Option[Int], fnSuffix: String, label: String, showLevel: Option[String] = None)(busyAttrs: => Html) = {
  <label class="block">
    <input type="checkbox"
      @if(showLevel){data-show-level="@showLevel"}
      @maybeBusyAdv.fold {
        @* Рендер аттрибутов инпута когда существующего размещения ещё нет (т.е. всё можно размещать). *@
        name="node[@midOpt].@fnSuffix"
        value="false"
      } { busyAdv =>
        @* Рендер атрибутов инпута, если размещение уже было сделано ранее. *@
        value="true"
        disabled="disabled" @busyAttrs
      }
    /><span class="checkbox_title">@label</span>
  </label>
}

@* Генератор чекбоксов, задающих/с заданными уровнями отображения. *@
@slCheckbox(maybeBusyAdv: Option[adv.MAdvI], midOpt: Option[Int], fnSuffix: String, sl: AdShowLevel, label: String, showLevel: String) = {
  @* TODO Генерить label на основе sl. *@
  @sslCheckbox(maybeBusyAdv, midOpt, fnSuffix, label, Some(showLevel)) {
    @if(maybeBusyAdv.exists(_ hasOnAdSl sl)) {checked="checked"}
  }
}


@* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
@args.af.globalError.map { ge =>
  <p>@messages("Problem.occured"): @messages(ge.message, ge.args : _*)</p>
}

@form(CSRF( routes.MarketAdv.advFormSubmit(adId) ),
      'id     -> "advsForm",
      'class  -> "adv-management_main-form") {

  @* URL для рассчета стоимости размещения. *@
  @_getPriceUrlTpl( routes.MarketAdv.getAdvPriceSubmit(adId) )


  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.isSuperuser) {
    @_advSuTpl()
  }


  @_barTpl(MHands.Left, id = Some(NODES_BAR_ID)) {

    @_minorTitleTpl() {
      @messages("City.place.choose")
    }

    @* Список городов. *@
    @lk.lkBlockNewDesign( open = false ) {
      <div class="js-city">
        <span class="checkbox_title __major __no-input">@messages("Select.town")</span>
      </div>
    } {
      @_citiesHeadsTpl() {
        @for(city <- args.cities; cityId <- city.node.id.toSeq) {
          @_cityTabHeadTpl(
            title   = city.node.meta.basic.name,
            cityId  = cityId
          )
        }
      }
    }

    @* Списки-вкладки категорий в городах. *@
    @_citiesBodiesTpl() {
      @for(city <- args.cities; cityId <- city.node.id.toSeq) {

        @_cityTabsTpl(cityId) {

          @_tabTitleTpl(
            title   = messages("All.places"),
            cityId  = cityId
          )

          @for(cat <- city.cats) {
            @_tabTitleTpl(
              title       = cat.name,
              cityId      = cityId,
              catId       = Some(cat.id),
              withCounter = true
            )
          }   @* for cat *@
        }     @* cityTabs *@
      }       @* for city, cityId *@
    }         @* citiesBodiesTpl *@

    @* Рендер списков узлов в городах. *@
    @for(city <- args.cities; cityId <- city.node.id.toSeq; cat <- city.cats) {
      @_nodesTabContTpl(cat.name, cityId, catId = cat.id) {
        @for(an <- cat.nodes) {
          @defining( an.node.id.get ) { adnId =>
          @defining( args.adnId2formIndex.get(adnId) ) { midOpt =>
          @defining( args.busyAdvs get adnId ) { maybeBusyAdv =>
            @if(maybeBusyAdv.isEmpty) {
              @lk.lkBlockNewDesign( open = false ) {
                <label>
                  <input type="checkbox" name="node[@midOpt].advertise" value="false"/>
                  <span class="styled-checkbox"></span>
                </label>
                <input type="hidden" name="node[@midOpt].adnId" value="@adnId"/>
                <span class="checkbox_title __major">
                  @an.node.meta.basic.name
                </span>
                <a class="slide-block_info-btn js-btn" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(adnId)">i</a>
              } {
                <div class="advm-node_block">
                  <div class="advm-node_left">
                    <p class="block">@messages("Adv.levels")</p>
                    <div class="block __margin-XS">
                      <hr class="delimiter __light"/>
                    </div>
                    @* Галочки уровней отображения. *@
                    @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onStartPage", AdShowLevels.LVL_START_PAGE, messages("Main.screen"), "onStartPage")
                    @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onRcvrCat", AdShowLevels.LVL_CATS, messages("Product.categories"), "onRcvrCat")
                    <div class="block __margin-XS"><hr class="delimiter __light"/></div>
                    <label class="block">
                      <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">@messages("Catalog")</span>
                    </label>
                  </div>
                </div>
              }
            } else {
              <div class="slide-block_title">
                <span class="checkbox_title __major">
                  <a href="#" class="link">@an.node.meta.basic.name</a>
                </span>
                <span class="ft-S light-gray"> (@messages("advertised"))</span>
              </div>
            }
          } @* lkBlockNewDesign cnt *@
          } @* mid *@
          } @* adnId *@
        }   @* node in cat *@
      }     @* _nodesTabTpl *@
    }       @* city *@

  } @* adv-management_left-bar *@


  @_barTpl(MHands.Right) {

    @* Даты (период) размещения. *@
    @_minorTitleTpl() {
      @messages("Date.choosing")
    }
    @_datesPeriodTpl( args.af("period"), args.advPeriodsAvail )

    @* Массовое вывставление уровней отображения. *@
    @_slsOverallTpl()

  }

}

