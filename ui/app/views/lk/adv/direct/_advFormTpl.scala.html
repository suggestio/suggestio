@(args: adv.direct.IAdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._
@import AdnShownTypes._
@import lk.dsl._
@import lk.adv.widgets._
@import io.suggest.adv.direct.AdvDirectFormConstants._
@import lk.lkwdgts._


@* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
@args.af.globalError.map { ge =>
  <p>@messages("Problem.occured"): @messages(ge.message, ge.args : _*)</p>
}

@form(CSRF( routes.MarketAdv.advFormSubmit(adId) ),
      'id     -> FORM_ID,
      'class  -> "adv-management_main-form") {

  @* URL для рассчета стоимости размещения. *@
  @_getPriceUrlTpl( routes.MarketAdv.getAdvPriceSubmit(adId) )


  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.user.isSuper) {
    @_advSuTpl()
  }


  @_barTpl(MHands.Left, id = Some(NODES_BAR_ID)) {

    @_minorTitleTpl() {
      @messages("City.place.choose")
    }

    @* Список городов. *@
    @lk.lkBlockNewDesign( open = false ) {
      <div class="js-city">
        @_checkBoxTitleTpl(id = Some(CITY_CURR_TITLE_ID), hasInput = false) {
          @messages("Select.town")
        }
      </div>
    } {
      @_citiesHeadsTpl() {
        @for(city <- args.cities; cityId <- city.node.id) {
          @_cityTabHeadTpl(
            title   = city.node.meta.basic.name,
            cityId  = cityId
          )
        }
      }
    }

    @* Списки-вкладки категорий в городах. *@
    @_citiesBodiesTpl() {
      @for(city <- args.cities; cityId <- city.node.id) {
        @_cityTabsTpl(cityId) {

          @_tabTitleTpl(
            title   = messages("All.places"),
            cityId  = cityId
          )

          @for(cat <- city.cats) {
            @_tabTitleTpl(
              title       = cat.name,
              cityId      = cityId,
              catId       = Some(cat.id),
              withCounter = true
            )
          }   @* for cat *@

        }     @* cityTabs *@
      }       @* for city, cityId *@
    }         @* citiesBodiesTpl *@

    @* Рендер списков узлов в городах. *@
    @_ngsBodiesAllTpl() {
      @for(city <- args.cities; cityId <- city.node.id) {
        @_ngsBodiesCityTpl(cityId) {
          @for(cat <- city.cats) {
            @_nodesTabContTpl(cat.name, cityId, catId = cat.id) {
              @for(an <- cat.nodes; nodeId <- an.node.id) {
                @_slideBlkTitleTpl(isOpen = false, id = Some(NODE_ROW_ID(nodeId)), jsSlide = false) {
                  @if( args.busyAdvs.get(nodeId).isEmpty ) {
                    @defining( args.adnId2formIndex.get(nodeId) ) { midOpt =>
                      @_checkBoxTpl(
                        isStyled = false,
                        "id"      -> NODE_CHECK_BOX_ID(nodeId),
                        "name"    -> s"node[${midOpt.get}].advertise",
                        "value"   -> false.toString
                      )
                      <input type="hidden" name="node[@midOpt].adnId" value="@nodeId"/>
                      @_checkBoxTitleTpl() {
                        @an.node.meta.basic.name
                      }
                      <a class="slide-block_info-btn js-btn" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(nodeId)">i</a>
                    } @* midOpt *@
                  } else {
                    @_checkBoxTitleTpl() {
                      <a href="#" class="link">@an.node.meta.basic.name</a>
                    }
                    <span class="ft-S light-gray"> (@messages("advertised"))</span>
                  }
                } @* slideBlkTitleTpl *@
              }   @* for an in nodes *@
            }     @* _nodesTabTpl *@
          }       @* cat in cats *@
        }         @* _ngsBodiesCityTpl *@
      }           @* city *@
    }             @* _ngsBodiesAllTpl *@

  } @* adv-management_left-bar *@


  @_barTpl(MHands.Right) {

    @* Даты (период) размещения. *@
    @_minorTitleTpl() {
      @messages("Date.choosing")
    }
    @_datesPeriodTpl( args.af("period"), args.advPeriodsAvail )

  }

}

