@(args: mbill.MShowOrderTplArgs)(implicit ctx: Context)

@* Страница, отображающая текущий статус ордера. *@

@import ctx.messages
@import args.morder.id.{get => orderId}
@import datetime._prettyDate
@import util.TplDataFormatUtil.formatPrice
@import lk.billing.txns._
@import lk.dsl.wkv._
@import lk.dsl._minorTitleTpl
@import io.suggest.bill.MPrice

@* Рендер строки с ценами заказа.  *@
@__pricesRow(title: String, prices: Traversable[MPrice]) = {
  @* Строка общей стоимости заказа, если хотя бы одна цена передана в args. *@
  @for(headPrice <- prices.headOption) {
    @_wkvRow() {
      @_wkvTd(true) {
        @title
      }
      @_wkvTd(false) {
        @for(mprice <- prices) {
        @* Теоретически возможно, есть несколько цен в разных валютах. Рендерить их столбиком. *@
          @if( !(mprice eq headPrice) ) {
            <br/>
          }
          @formatPrice(mprice)
        }
      }
    }
  }
}


@OrdersBase(
  title = messages("Order.N", orderId.toString),
  mnode = args.mnode
) {

  @* Нарисовать табличку, описывающую текущий ордер. *@
  @_wkvTable() {

    @* Строка с номером заказа. *@
    @_wkvRow() {
      @_wkvTd(true) {
        @messages("Order.number")
      }
      @_wkvTd(false) {
        @messages("_N")
        @orderId
      }
    }

      @* Строка статуса заказа. *@
    @_wkvRow() {
      @_wkvTd(true) {
        @messages("Status")
      }
      @_wkvTd(false) {
        @messages( args.morder.status.singular )
        <br/>
        <span class="ft-S">
          @_prettyDate( args.morder.dateStatus )
        </span>
      }
    }

    @* Строка общей стоимости заказа, если хотя бы одна цена передана в args. *@
    @__pricesRow( messages("Cost"), args.orderPrices )

    @* Строка переплаты за заказ, если она имела место быть (т.е. когда заказ дешевле минимального платежа). *@
    @__pricesRow( messages("Paid"), args.payOverPrices.values )

  }

  <br/>
  <br/>

  @* Рендерим содержимое заказа. *@
  @_ItemsTpl(args, withDelete = false, withStatus = true)


  <br/>
  <br/>

  @* Если есть транзакции, связанные с текущим заказов, то отобразить её. *@
  @_minorTitleTpl() {
    @messages("Transactions")
    @if( args.txns.nonEmpty ) {
      (@args.txns.size)
    }
  }
  @if( args.txns.nonEmpty ) {
    @_TxnsTableTpl() {
      @_TxnsListTpl(args)
    }
  } else {
    @messages("No.transactions.found")
  }

}
