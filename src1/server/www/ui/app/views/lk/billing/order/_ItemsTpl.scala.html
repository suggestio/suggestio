@(args: mbill.IItemsTplArgs, withDelete: Boolean)(implicit ctx: Context)

@* Рендер таблицы item'ов в рамках одного ордера. *@

@import ctx.{messages, request}
@import ctx.api.dynImgUtil
@import datetime._dateTpl
@import util.TplDataFormatUtil.{formatPrice, formatGeoShape}
@import helper._
@import views.html.sc._adNormalTpl


@__td(size: String, isHeader: Boolean, classes: Seq[String] = Nil, rowSpan: Option[Int] = None)(content: Html) = {
  <td @if(rowSpan){rowspan="@rowSpan"}
      class="td __@if(isHeader){gray}else{white} __size-@size @classes.mkString(" ")">
    @content
  </td>
}


@__delBtn(call: Call, titleMsg: String) = {
  @form( CSRF(call), 'class -> "f-right" ) {
    <a class="btn __negative js-submit-btn"
       title="@messages(titleMsg)"
       href="#">
      &cross;
    </a>
  }
}


@if( args.itemNodes.nonEmpty ) {

  <table class="table __width-XL">

    <thead>
      <tr>
        @__td("M", true, "__radial-first" :: "items-ad-column" :: Nil) {
          &nbsp;
        }
        @__td("M", true, "items-descr-column" :: Nil) {
          @messages("_order.Items")
        }
        @__td("M", true, "items-price-column" :: Nil) {
          @messages("Price")
        }
        @if(withDelete) {
          @__td("M", true, "items-delete-column" :: "__radial-last" :: Nil) {
            @__delBtn(routes.LkBill2.cartClear( args.mnode.id.get, r = ctx.r ), "Delete.all")
          }
        }
      </tr>
    </thead>

    <tbody>
      @defining( if(withDelete) 1 else 0 ) { colspanOffset =>
      @for( mnode <- args.itemNodes;  nodeId <- mnode.id;  nodeItems <- args.node2items.get(nodeId);  firstItem <- nodeItems.headOption;  lastItem <- nodeItems.lastOption ) {
        @for( mitem <- nodeItems;  startRow = mitem eq firstItem ) {

          <tr>
            <td class="td __delimiter@if(!startRow){-thin}"
                colspan="@(colspanOffset + (if(startRow) 3 else 2))"></td>
          </tr>

          <tr>
            @* Для первого элемента надо отрендерить вертикальную ячейку с rowspan, которая содержит иллюстрацию. *@
            @if(startRow) {
              @__td("M", false, "__radial-first" :: "items-ad-column" :: Nil, rowSpan = Some(nodeItems.size * 2 - 1)) {
                @* При наличии brArgs отрендерить карточку. *@
                @for( brArgs <- args.node2brArgs.get(nodeId) ) {
                  @_adNormalTpl( brArgs )
                }

                @* При наличии логотипа, рендерим логотип с подсказкой. *@
                @for( logoImg <- args.node2logo.get(nodeId) ) {
                  <img class=""
                       alt="@mnode.guessDisplayName"
                       src="@dynImgUtil.imgCall(logoImg)"
                  />
                }
              }
            }

            @* Рендерим текущий item: сначала суть item'а. *@
            @__td("M", false, "items-descr-column" :: Nil) {
              @for( tagFace <- mitem.tagFaceOpt ) {
                @messages("Tag")
                <span class="ft-S">#</span><span class="ft-M strong">@tagFace</span>
              }

              @for( gs <- mitem.geoShape ) {
                @formatGeoShape(gs)
              }

              @for(rcvrId <- mitem.rcvrIdOpt) {
                @for(rcvrNode <- args.nodesMap.get(rcvrId)) {
                  @messages("in")
                  @rcvrNode.guessDisplayNameOrId
                }
              }

              @* Рендерим диапазон дат размещения. *@
              @for( dtStart <- mitem.dateStartOpt ) {
                @_dateTpl("from", dtStart.toLocalDate)
              }
              @for( dtEnd <- mitem.dateEndOpt ) {
                @_dateTpl("till", dtEnd.toLocalDate)
              }

            }

            @* Стоимость item'а. *@
            @__td("M", false, "items-price-column" :: Nil) {
              @formatPrice(mitem.price)
            }

            @if(withDelete) {
              @__td("M", false, "items-delete-column" :: Nil) {
                @for( itemId <- mitem.id ) {
                  @__delBtn( routes.LkBill2.cartDeleteItem(itemId, r = ctx.request.path), "Delete" )
                }
              }
            }

          </tr>
        }
      }
      }
    </tbody>

  </table>

}
