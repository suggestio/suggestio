@(args: mbill.IItemsTplArgs, withDelete: Boolean)(implicit ctx: Context)

@* Рендер таблицы item'ов в рамках одного ордера. *@

@import ctx.{messages, request}
@import ctx.api.dynImgUtil
@import util.TplDataFormatUtil.formatPrice
@import helper._
@import views.html.sc._adNormalTpl


@__td(size: String, isHeader: Boolean, classes: Seq[String] = Nil, rowSpan: Option[Int] = None)(content: Html) = {
  <td @if(rowSpan){rowspan="@rowSpan"}
      class="td __@if(isHeader){gray}else{white} __size-@size @classes.mkString(" ")">
    @content
  </td>
}


@if( args.itemNodes.nonEmpty ) {

  <table class="table __width-XL">

    <thead>
      <tr>
        @__td("M", true, "__radial-first" :: "items-ad-column" :: Nil) {
          &nbsp;
        }
        @__td("L", true) {
          @messages("Item")
        }
        @__td("M", true, "__radial-last" :: "items-price-column" :: Nil) {
          @messages("Price")
        }
      </tr>
    </thead>

    <tbody>
      @for( mnode <- args.itemNodes;  nodeId <- mnode.id;  nodeItems <- args.node2items.get(nodeId);  firstItem <- nodeItems.headOption;  lastItem <- nodeItems.lastOption ) {
        @for( mitem <- nodeItems;  startRow = mitem eq firstItem ) {

          <tr>
            <td class="td __delimiter@if(!startRow){-thin}" colspan="@if(startRow) {3} else {2}"></td>
          </tr>

          <tr>

            @* Для первого элемента надо отрендерить вертикальную ячейку с rowspan, которая содержит иллюстрацию. *@
            @if(startRow) {
              @__td("M", false, "__radial-first" :: "items-ad-column" :: Nil, rowSpan = Some(nodeItems.size * 2 - 1)) {
                <span class="">

                </span>
                @* При наличии brArgs отрендерить карточку. *@
                @for( brArgs <- args.node2brArgs.get(nodeId) ) {
                  @_adNormalTpl( brArgs )
                }

                @* При наличии логотипа, рендерим логотип с подсказкой. *@
                @for( logoImg <- args.node2logo.get(nodeId) ) {
                  <img class=""
                       alt="@mnode.guessDisplayName"
                       src="@dynImgUtil.imgCall(logoImg)"
                  />
                }

              }
            }

            @* Рендерим текущий item: сначала суть item'а. *@
            @__td("L", false) {
              @for( tagFace <- mitem.tagFaceOpt ) {
                <span class="ft-S">#</span><span class="ft-M strong">@tagFace</span>
              }
              @mitem.id
            }

            @* Стоимость item'а *@
            @__td("M", false, "items-price-column" :: Nil) {
              @formatPrice(mitem.price)

              @if(withDelete) {
                @for( itemId <- mitem.id ) {
                  @form( CSRF(routes.LkBill2.cartDeleteItem(itemId, r = ctx.request.path)), 'class -> "f-right" ) {
                    <a class="btn __negative js-submit-btn"
                       title="@messages("Delete")"
                       href="#">
                      &cross;
                    </a>
                  }
                }
              }
            }

          </tr>
        }
      }
    </tbody>

  </table>

}
