L.StorageSingleton=L.Class.extend({includes:L.Mixin.Events});L.Storage=new L.StorageSingleton();L.S=L.Storage;L.Storage.Map=L.Map.extend({});L.Util.queryString=function(name,fallback){var decode=function(s){return decodeURIComponent(s.replace(/\+/g,' '));};var qs=window.location.search.slice(1).split('&'),qa={};for(var i in qs){var key=qs[i].split('=');if(!key)continue;qa[decode(key[0])]=key[1]?decode(key[1]):1;}
return qa[name]||fallback;};L.Util.booleanFromQueryString=function(name){var value=L.Util.queryString(name);return value==='1'||value==='true';};L.Util.setFromQueryString=function(options,name){var value=L.Util.queryString(name);if(typeof value!=='undefined'){options[name]=value;}};L.Util.setBooleanFromQueryString=function(options,name){var value=L.Util.queryString(name);if(typeof value!=='undefined'){options[name]=value=='1'||value=='true';}};L.Util.escapeHTML=function(s){s=s?s.toString():'';return s.replace(/</gm,'&lt;');};L.Util.toHTML=function(r){var ii;var newline=r.indexOf('\r\n')!=-1?'\r\n':r.indexOf('\n')!=-1?'\n':'';r=r.replace(/</gm,'&lt;');r=r.replace(/^### (.*)/gm,'<h5>$1</h5>');r=r.replace(/^## (.*)/gm,'<h4>$1</h4>');r=r.replace(/^# (.*)/gm,'<h3>$1</h3>');r=r.replace(/^---/gm,'<hr>');r=r.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');r=r.replace(/\*(.*?)\*/g,'<em>$1</em>');r=r.replace(/^\*\* (.*)/gm,'<ul><ul><li>$1</li></ul></ul>');r=r.replace(/^\* (.*)/gm,'<ul><li>$1</li></ul>');for(ii=0;ii<3;ii++)r=r.replace(new RegExp('</ul>'+newline+'<ul>','g'),newline);r=r.replace(/(\[\[http)/g,'[[h_t_t_p');r=r.replace(/({{http)/g,'{{h_t_t_p');r=r.replace(/(https?:[^ \)\n]*)/g,'<a target="_blank" href="$1">$1</a>');r=r.replace(/\[\[(h_t_t_ps?:[^\]|]*?)\]\]/g,'<a target="_blank" href="$1">$1</a>');r=r.replace(/\[\[(h_t_t_ps?:[^|]*?)\|(.*?)\]\]/g,'<a target="_blank" href="$1">$2</a>');r=r.replace(/\[\[([^\]|]*?)\]\]/g,'<a href="$1">$1</a>');r=r.replace(/\[\[([^|]*?)\|(.*?)\]\]/g,'<a href="$1">$2</a>');r=r.replace(/{{{(h_t_t_ps?[^ |]*)}}}/g,'<iframe frameBorder="0" src="$1" width="100%" height="300px"></iframe>');r=r.replace(/{{{(h_t_t_ps?[^ |]*)\|(\d*?)}}}/g,'<iframe frameBorder="0" src="$1" width="100%" height="$2px"></iframe>');r=r.replace(/{{([^\]|]*?)}}/g,'<img src="$1">');r=r.replace(/{{([^|]*?)\|(\d*?)}}/g,'<img src="$1" width="$2">');r=r.replace(/(h_t_t_p)/g,'http');if(newline)r=r.replace(new RegExp(newline+'(?=[^]+)','g'),'<br>'+newline);return r;};L.Util.isObject=function(what){return typeof what==='object'&&what!==null;};L.Util.latLngsForGeoJSON=function(latlngs){coords=[];for(var i=0,len=latlngs.length;i<len;i++){coords.push([latlngs[i].lng,latlngs[i].lat]);}
return coords;};L.Util.CopyJSON=function(geojson){return JSON.parse(JSON.stringify(geojson));};L.Util.detectFileType=function(f){var filename=f.name?escape(f.name.toLowerCase()):'';function ext(_){return filename.indexOf(_)!==-1;}
if(f.type==='application/vnd.google-earth.kml+xml'||ext('.kml')){return'kml';}
if(ext('.gpx'))return'gpx';if(ext('.geojson')||ext('.json'))return'geojson';if(f.type==='text/csv'||ext('.csv')||ext('.tsv')||ext('.dsv')){return'csv';}
if(ext('.xml')||ext('.osm'))return'osm';};L.Util.usableOption=function(options,option){return typeof options[option]!=='undefined'&&options[option]!==''&&options[option]!==null;};L.Util.greedyTemplate=function(str,data,fallback){return str.replace(/\{ *([\w_]+) *\}/g,function(str,key){var value=data[key];if(value===undefined){value=fallback||'';}
return value;});};L.Util.sortFeatures=function(features,sortKey){var sortKeys=(sortKey|| 'name').split(',');var sort=function(a,b,i){var sortKey=sortKeys[i],score,valA=a.properties[sortKey]||'',valB=b.properties[sortKey]|| '';if(!valA){score=-1;}else if(!valB){score=1;}else{score=valA.toString().toLowerCase().localeCompare(valB.toString().toLowerCase());}
if(score===0&&sortKeys[i+1])return sort(a,b,i+1);return score;};features.sort(function(a,b){if(!a.properties|| !b.properties){return 0;}
return sort(a,b,0);});return features;};L.DomUtil.add=function(tagName,className,container,content){var el=L.DomUtil.create(tagName,className,container);if(content){if(content.nodeType&&content.nodeType===1){el.appendChild(content);}
else{el.innerHTML=content;}}
return el;};L.DomUtil.createFieldset=function(container,legend){var fieldset=L.DomUtil.create('fieldset','toggle',container);var legendEl=L.DomUtil.add('legend','style_options_toggle',fieldset,legend);L.DomEvent.on(legendEl,'click',function(){if(L.DomUtil.hasClass(fieldset,'on')){L.DomUtil.removeClass(fieldset,'on');}else{L.DomUtil.addClass(fieldset,'on');}});return fieldset;};L.DomUtil.classIf=function(el,className,bool){if(bool){L.DomUtil.addClass(el,className);}else{L.DomUtil.removeClass(el,className);}};L.DomUtil.element=function(what,attrs,parent){var el=document.createElement(what);for(var attr in attrs){el[attr]=attrs[attr];}
if(typeof parent!=="undefined"){parent.appendChild(el);}
return el;};L.DomUtil.before=function(target,el){target.parentNode.insertBefore(el,target);return el;};L.DomUtil.after=function(target,el)
{target.parentNode.insertBefore(el,target.nextSibling);return el;};L.DomUtil.RGBRegex=/rgb *\( *([0-9]{1,3}) *, *([0-9]{1,3}) *, *([0-9]{1,3}) *\)/;L.DomUtil.TextColorFromBackgroundColor=function(el){var out='#000000';if(!window.getComputedStyle){return out;}
var rgb=window.getComputedStyle(el).getPropertyValue('background-color');rgb=L.DomUtil.RGBRegex.exec(rgb);if(!rgb||rgb.length!=4){return out;}
rgb=parseInt(rgb[1],10)+parseInt(rgb[2],10)+parseInt(rgb[3],10);if(rgb<(255*3/2)){out='#ffffff';}
return out;};L.S.Keys={LEFT:37,UP:38,RIGHT:39,DOWN:40,TAB:9,ENTER:13,ESC:27,APPLE:91,SHIFT:16,ALT:17,CTRL:18,E:69,H:72,I:73,L:76,M:77,P:80,S:83,Z:90};L.S._onKeyDown=function(e){if(e.keyCode==L.S.Keys.ESC){L.S.fire('ui:end');}};L.DomEvent.addListener(document,'keydown',L.S._onKeyDown,L.S);L.Storage.Help=L.Class.extend({initialize:function(map){this.map=map;this.parentContainer=L.DomUtil.create('div','storage-help-container',document.body);this.overlay=L.DomUtil.create('div','storage-help-overlay',this.parentContainer);this.box=L.DomUtil.create('div','storage-help-box',this.parentContainer);var closeLink=L.DomUtil.create('a','storage-close-link',this.box);closeLink.href='#';L.DomUtil.add('i','storage-close-icon',closeLink);var label=L.DomUtil.create('span','',closeLink);label.title=label.innerHTML=L._('Close');this.content=L.DomUtil.create('div','storage-help-content',this.box);L.DomEvent.on(closeLink,'click',this.hide,this);L.DomEvent.addListener(this.parentContainer,'keydown',this.onKeyDown,this);},onKeyDown:function(e){var key=e.keyCode,ESC=27;if(key==ESC){this.hide();}},show:function(){this.content.innerHTML='';for(var i=0,name;i<arguments.length;i++){name=arguments[i];L.DomUtil.add('div','',this.content,this.resolve(name));}
L.DomUtil.addClass(document.body,'storage-help-on');},hide:function(){L.DomUtil.removeClass(document.body,'storage-help-on');},resolve:function(name){return typeof this[name]==='function'?this[name]():this[name];},button:function(container,entries){var helpButton=L.DomUtil.create('a','storage-help-button',container);helpButton.href='#';if(entries){L.DomEvent.on(helpButton,'click',L.DomEvent.stop).on(helpButton,'click',function(e){var args=typeof entries==='string'?[entries]:entries;this.show.apply(this,args);},this);}
return helpButton;},edit:function(){var container=L.DomUtil.create('div',''),self=this,title=L.DomUtil.create('h3','',container),actionsContainer=L.DomUtil.create('ul','storage-edit-actions',container);var addAction=function(action){var actionContainer=L.DomUtil.add('li',action.className,actionsContainer,action.title);L.DomEvent.on(actionContainer,'click',action.callback,action.context);L.DomEvent.on(actionContainer,'click',self.hide,self);};title.innerHTML=L._('Where do we go from here?');var actions=this.map.getEditActions();actions.unshift({title:L._('Draw a polyline')+' (Ctrl+L)',className:'storage-draw-polyline',callback:function(){this.hide();this.map.startPolyline();},context:this},{title:L._('Draw a polygon')+' (Ctrl+P)',className:'storage-draw-polygon',callback:function(){this.hide();this.map.startPolygon();},context:this},{title:L._('Draw a marker')+' (Ctrl+M)',className:'storage-draw-marker',callback:function(){this.hide();this.map.startMarker();},context:this});for(var i=0;i<actions.length;i++){addAction(actions[i]);}
return container;},importFormats:function(){var container=L.DomUtil.create('div');L.DomUtil.add('h3','',container,'GeojSON');L.DomUtil.add('p','',container,L._('All properties are imported.'));L.DomUtil.add('h3','',container,'GPX');L.DomUtil.add('p','',container,L._('Properties imported:')+'name, desc');L.DomUtil.add('h3','',container,'KML');L.DomUtil.add('p','',container,L._('Properties imported:')+'name, description');L.DomUtil.add('h3','',container,'CSV');L.DomUtil.add('p','',container,L._('Comma, tab or semi-colon separated values. SRS WGS84 is implied. Only Point geometries are imported. The import will look at the column headers for any mention of «lat» and «lon» at the begining of the header, case insensitive. All other column are imported as properties.'));return container;},textFormatting:function(){var container=L.DomUtil.create('div'),title=L.DomUtil.add('h3','',container,L._('Text formatting')),elements=L.DomUtil.create('ul','',container);L.DomUtil.add('li','',elements,L._('*simple star for italic*'));L.DomUtil.add('li','',elements,L._('**double star for bold**'));L.DomUtil.add('li','',elements,L._('# one hash for main heading'));L.DomUtil.add('li','',elements,L._('## two hashes for second heading'));L.DomUtil.add('li','',elements,L._('### three hashes for third heading'));L.DomUtil.add('li','',elements,L._('Simple link: [[http://example.com]]'));L.DomUtil.add('li','',elements,L._('Link with text: [[http://example.com|text of the link]]'));L.DomUtil.add('li','',elements,L._('Image: {{http://image.url.com}}'));L.DomUtil.add('li','',elements,L._('Image with custom width (in px): {{http://image.url.com|width}}'));L.DomUtil.add('li','',elements,L._('Iframe: {{{http://iframe.url.com}}}'));L.DomUtil.add('li','',elements,L._('Iframe with custom height (in px): {{{http://iframe.url.com|height}}}'));L.DomUtil.add('li','',elements,L._('--- for an horizontal rule'));return container;},dynamicProperties:function(){var container=L.DomUtil.create('div');L.DomUtil.add('h3','',container,L._('Dynamic properties'));L.DomUtil.add('p','',container,L._('Use placeholders with feature properties between brackets, eg. &#123;name&#125;, they will be dynamically replaced by the corresponding values.'));return container;},formatURL:L._('Supported variables that will be dynamically replaced')+': {bbox}, {lat}, {lng}, {zoom}, {east}, {north}..., {left}, {top}...',formatIconURL:L._('You can use feature properties as variables: ex.: with "http://myserver.org/images/{name}.png", the {name} variable will be replaced by the "name" value of each markers.')});L.S.Popup=L.Popup.extend({options:{parseTemplate:true},initialize:function(feature){this.feature=feature;this.container=L.DomUtil.create('div','storage-popup');this.format();L.Popup.prototype.initialize.call(this,{},feature);this.setContent(this.container);},hasFooter:function(){return this.feature.hasPopupFooter();},renderTitle:function(){},renderBody:function(){var template=this.feature.getOption('popupContentTemplate'),container=L.DomUtil.create('div',''),content,properties,center=this.feature.getCenter();if(this.options.parseTemplate){properties={lat:center.lat,lon:center.lng,lng:center.lng};if(typeof this.feature.getMeasure!=='undefined'){properties['measure']=this.feature.getMeasure();}
properties=L.extend(properties,this.feature.properties);properties.description=L.Util.greedyTemplate(this.feature.properties.description|| '',properties);content=L.Util.greedyTemplate(template,properties);}
content=L.Util.toHTML(content);container.innerHTML=content;var els=container.querySelectorAll('img,iframe');for(var i=0;i<els.length;i++){this.onElementLoaded(els[i]);}
if(container.textContent.replace('\n','')===''){container.innerHTML='';L.DomUtil.add('h3','',container,this.feature.getDisplayName());}
return container;},renderFooter:function(){if(this.hasFooter()){var footer=L.DomUtil.create('ul','storage-popup-footer',this.container),previous_li=L.DomUtil.create('li','previous',footer),zoom_li=L.DomUtil.create('li','zoom',footer),next_li=L.DomUtil.create('li','next',footer),next=this.feature.getNext(),prev=this.feature.getPrevious();if(next){next_li.title=L._('Go to «{feature}»',{feature:next.properties.name});}
if(prev){previous_li.title=L._('Go to «{feature}»',{feature:prev.properties.name});}
zoom_li.title=L._('Zoom to this feature');L.DomEvent.on(next_li,'click',function(){if(next){next.bringToCenter({zoomTo:next.getOption('zoomTo')},function(){next.view(next.getCenter());});}});L.DomEvent.on(previous_li,'click',function(){if(prev){prev.bringToCenter({zoomTo:prev.getOption('zoomTo')},function(){prev.view(prev.getCenter());});}});L.DomEvent.on(zoom_li,'click',function(){this.bringToCenter({zoomTo:this.getOption('zoomTo')});},this.feature);}},format:function(){var title=this.renderTitle();if(title){this.container.appendChild(title);}
var body=this.renderBody();if(body){L.DomUtil.add('div','storage-popup-content',this.container,body);}
this.renderFooter();},onElementLoaded:function(el){L.DomEvent.on(el,'load',function(){this._updateLayout();this._updatePosition();this._adjustPan();},this);}});L.S.Popup.Large=L.S.Popup.extend({options:{maxWidth:500,className:'storage-popup-large'}});L.S.Popup.BaseWithTitle=L.S.Popup.extend({renderTitle:function(){var title;if(this.feature.getDisplayName()){title=L.DomUtil.create('h3','popup-title');title.innerHTML=L.Util.escapeHTML(this.feature.getDisplayName());}
return title;}});L.S.Popup.Table=L.S.Popup.BaseWithTitle.extend({formatRow:function(key,value){if(value.indexOf('http')===0){value='<a href="'+value+'" target="_blank">'+value+'</a>';}
return value;},addRow:function(container,key,value){var tr=L.DomUtil.create('tr','',container);L.DomUtil.add('th','',tr,key);L.DomUtil.add('td','',tr,this.formatRow(key,value));},renderBody:function(){var table=L.DomUtil.create('table');for(var key in this.feature.properties){if(typeof this.feature.properties[key]==='object'|| key==='name'){continue;}
this.addRow(table,key,L.Util.escapeHTML(this.feature.properties[key]).trim());}
return table;}});L.S.Popup.table=L.S.Popup.Table;L.S.Popup.GeoRSSImage=L.S.Popup.BaseWithTitle.extend({options:{minWidth:300,maxWidth:500,className:'storage-popup-large storage-georss-image'},renderBody:function(){var container=L.DomUtil.create('a');container.href=this.feature.properties.link;container.target='_blank';if(this.feature.properties.img){var img=L.DomUtil.create('img','',container);img.src=this.feature.properties.img;img.style.maxWidth=this.options.maxWidth+'px';img.style.maxHeight=this.options.maxWidth+'px';this.onElementLoaded(img);}
return container;}});L.S.Popup.GeoRSSLink=L.S.Popup.extend({options:{className:'storage-georss-link'},renderBody:function(){var title=this.renderTitle(this),a=L.DomUtil.add('a');a.href=this.feature.properties.link;a.target='_blank';a.appendChild(title);return a;}});L.S.Popup.SimplePanel=L.S.Popup.extend({allButton:function(){var button=L.DomUtil.create('li','');L.DomUtil.create('i','storage-icon-16 storage-list',button);var label=L.DomUtil.create('span','',button);label.innerHTML=label.title=L._('See all');L.DomEvent.on(button,'click',this.feature.map.openBrowser,this.feature.map);return button;},update:function(){L.S.fire('ui:start',{data:{html:this._content},actions:[this.allButton()]});},onRemove:function(map){L.S.fire('ui:end');L.S.Popup.prototype.onRemove.call(this,map);},_initLayout:function(){this._container=L.DomUtil.create('span');},_updateLayout:function(){},_updatePosition:function(){},_adjustPan:function(){}});L.Storage.Xhr={_wrapper:function(){var wrapper;if(window.XMLHttpRequest===undefined){wrapper=function(){try{return new window.ActiveXObject('Microsoft.XMLHTTP.6.0');}
catch(e1){try{return new window.ActiveXObject('Microsoft.XMLHTTP.3.0');}
catch(e2){throw new Error('XMLHttpRequest is not supported');}}};}
else{wrapper=window.XMLHttpRequest;}
return new wrapper();},_ajax:function(settings){var xhr=this._wrapper(),id=Math.random(),self=this;if(settings.listener)settings.listener.fire('dataloading',{id:id});xhr.open(settings.verb,settings.uri,true);if(settings.uri.indexOf('http')!==0||settings.uri.indexOf(window.location.origin)===0){xhr.setRequestHeader('X-Requested-With','XMLHttpRequest');}
if(settings.headers){for(var name in settings.headers){xhr.setRequestHeader(name,settings.headers[name]);}}
var loaded=function(){if(settings.listener)settings.listener.fire('dataload',{id:id});};xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status==200){settings.callback.call(settings.context||xhr,xhr.responseText,xhr);}
else if(xhr.status===403){L.Storage.fire('ui:alert',{content:L._('Action not allowed :('),level:'error'});}
else if(xhr.status===412){var msg=L._('Woops! Someone else seems to have edited the data. You can save anyway, but this will erase the changes made by others.');var actions=[{label:L._('Save anyway'),callback:function(){delete settings.headers['If-Match'];self._ajax(settings);},callbackContext:self},{label:L._('Cancel')}];L.Storage.fire('ui:alert',{content:msg,level:'error',duration:100000,actions:actions});}
else{if(xhr.status!==0){L.Storage.fire('ui:alert',{'content':L._('Problem in the response'),'level':'error'});}}
loaded();}};try{xhr.send(settings.data);}catch(e){loaded();console.error('Bad Request',e);}},_json:function(verb,uri,options){var args=arguments,self=this;var default_options={'async':true,'callback':null,'responseType':'text','data':null,'listen_form':null};var settings=L.Util.extend({},default_options,options);if(verb==='POST'){var token=document.cookie.replace(/(?:(?:^|.*;\s*)csrftoken\s*\=\s*([^;]*).*$)|^.*$/,'$1');if(token){settings.headers=settings.headers||{};settings.headers['X-CSRFToken']=token;}}
var callback=function(responseText,response){var data;try{data=JSON.parse(responseText);}
catch(err){console.log(err);L.Storage.fire('ui:alert',{content:L._('Problem in the response format'),level:'error'});return;}
if(data.errors){console.log(data.errors);L.Storage.fire('ui:alert',{content:L._('An error occured'),level:'error'});}else if(data.login_required){if(settings.login_callback){settings.login_callback(data);}
else{self.login(data,args);}}
else{if(settings.callback){L.bind(settings.callback,settings.context||this)(data,response);}else{self.default_callback(data,settings,response);}}};this._ajax({verb:verb,uri:uri,data:settings.data,callback:callback,headers:settings.headers,listener:settings.listener});},get:function(uri,options){L.Storage.Xhr._json('GET',uri,options);},post:function(uri,options){L.Storage.Xhr._json('POST',uri,options);},submit_form:function(form_id,options){if(typeof options==='undefined'){options={};}
var form=L.DomUtil.get(form_id);var formData=new FormData(form);if(options.extraFormData){formData.append(options.extraFormData);}
options.data=formData;L.Storage.Xhr.post(form.action,options);return false;},listen_form:function(form_id,options){var form=L.DomUtil.get(form_id);if(!form){return;}
L.DomEvent.on(form,'submit',L.DomEvent.stopPropagation).on(form,'submit',L.DomEvent.preventDefault).on(form,'submit',function(){L.Storage.Xhr.submit_form(form_id,options);});},listen_link:function(link_id,options){var link=L.DomUtil.get(link_id);if(link){L.DomEvent.on(link,'click',L.DomEvent.stop).on(link,'click',function(){if(options.confirm&&!confirm(options.confirm)){return;}
L.Storage.Xhr.get(link.href,options);});}},default_callback:function(data,options){if(data.redirect){var newPath=data.redirect;if(window.location.pathname==newPath){window.location.reload();}
else{window.location=newPath;}}
else if(data.info){L.Storage.fire('ui:alert',{content:data.info,level:'info'});L.Storage.fire('ui:end');}
else if(data.error){L.Storage.fire('ui:alert',{content:data.error,level:'error'});}
else if(data.html){var ui_options={'data':data},listen_options;if(options.cssClass){ui_options.cssClass=options.cssClass;}
L.Storage.fire('ui:start',ui_options);if(options.listen_form){listen_options=L.Util.extend({},options,options.listen_form.options);L.Storage.Xhr.listen_form(options.listen_form.id,listen_options);}
if(options.listen_link){for(var i=0,l=options.listen_link.length;i<l;i++){listen_options=L.Util.extend({},options,options.listen_link[i].options);L.Storage.Xhr.listen_link(options.listen_link[i].id,listen_options);}}}
else if(options.success){options.success(data);}},login:function(data,args){var self=this;var proceed=function(){L.Storage.fire('ui:end');if(typeof args!=='undefined'){L.Storage.Xhr._json.apply(self,args);}
else{self.default_callback(data,{});}};var ask_for_login=function(data){L.Storage.fire('ui:start',{'data':data});L.Storage.Xhr.listen_form('login_form',{'callback':function(data){if(data.html){self.login(data,args);}
else{proceed();}}});var links=document.getElementsByClassName('storage-login-popup');Object.keys(links).forEach(function(el){var link=links[el];L.DomEvent.on(link,'click',L.DomEvent.stopPropagation).on(link,'click',L.DomEvent.preventDefault).on(link,'click',function(){L.Storage.fire('ui:end');var win=window.open(link.href);window.storage_proceed=function(){proceed();win.close();};});});};if(data.login_required){this.get(data.login_required,{'callback':function(data){ask_for_login(data);}});}
else{ask_for_login(data);}},logout:function(url){this.get(url);},buildQueryString:function(params){var query_string=[];for(var key in params){query_string.push(encodeURIComponent(key)+'='+encodeURIComponent(params[key]));}
return query_string.join('&');}};L.Storage.ElementHelper=L.Class.extend({includes:[L.Mixin.Events],initialize:function(formBuilder,field,options){this.formBuilder=formBuilder;this.obj=this.formBuilder.obj;this.map=this.obj.getMap();this.form=this.formBuilder.form;this.field=field;this.options=options;this.fieldEls=this.field.split('.');this.name=this.formBuilder.getName(field);this.buildLabel();this.build();this.buildHelpText();},get:function(){return this.formBuilder.getter(this.field);},toHTML:function(){return this.get();},toJS:function(){return this.value();},sync:function(){this.set();this.fire('synced');},set:function(){this.formBuilder.setter(this.field,this.toJS());},buildLabel:function(){if(this.options.label){this.label=L.DomUtil.add('label','',this.formBuilder.form,this.options.label);if(this.options.helpEntries){this.map.help.button(this.label,this.options.helpEntries);}}},buildHelpText:function(){if(this.options.helpText){var container=L.DomUtil.create('small','help-text',this.form);container.innerHTML=this.options.helpText;}},fetch:function(){}});L.S.ElementHelper.Textarea=L.S.ElementHelper.extend({build:function(){this.input=L.DomUtil.create('textarea','',this.form);if(this.options.placeholder){this.input.placeholder=this.options.placeholder;}
this.fetch();L.DomEvent.on(this.input,'input',this.sync,this);L.DomEvent.on(this.input,'keypress',this.onKeyPress,this);},fetch:function(){var value=this.backup=this.toHTML();if(value){this.input.value=value;}},value:function(){return this.input.value;},onKeyPress:function(e){var key=e.keyCode,ENTER=13;if(key==ENTER&&(e.shiftKey||e.ctrlKey)){L.DomEvent.stop(e);L.S.fire('ui:end');}}});L.Storage.ElementHelper.Input=L.S.ElementHelper.extend({build:function(){if(this.options.wrapper){this.wrapper=L.DomUtil.create(this.options.wrapper,this.options.wrapperClass||'',this.form);}
this.input=L.DomUtil.create('input','',this.wrapper|| this.form);this.input.type=this.type();this.input.name=this.name;this.input._helper=this;this.fetch();if(this.options.placeholder){this.input.placeholder=this.options.placeholder;}
L.DomEvent.on(this.input,this.getSyncEvent(),this.sync,this);L.DomEvent.on(this.input,'keydown',this.onKeyDown,this);},fetch:function(){this.input.value=this.backup=(typeof this.toHTML()!=='undefined'?this.toHTML():null);},getSyncEvent:function(){return'input';},type:function(){return'text';},value:function(){return this.input.value||undefined;},finish:function(){L.S.fire('ui:end');},onKeyDown:function(e){var key=e.keyCode;if(key==L.S.Keys.ENTER){L.DomEvent.stop(e);this.finish();}
if(key==L.S.Keys.S&&e.ctrlKey){this.finish();}}});L.S.ElementHelper.BlurInput=L.S.ElementHelper.Input.extend({getSyncEvent:function(){return'blur';},finish:function(){this.sync();L.S.ElementHelper.Input.prototype.finish.call(this);},sync:function(){if(this.backup!==this.value()){L.S.ElementHelper.Input.prototype.sync.call(this);}}});L.S.ElementHelper.IntegerMixin={value:function(){return!isNaN(this.input.value)&&this.input.value!==''?parseInt(this.input.value,10):undefined;},type:function(){return'number';}};L.S.ElementHelper.IntInput=L.S.ElementHelper.Input.extend({includes:[L.S.ElementHelper.IntegerMixin]});L.S.ElementHelper.BlurIntInput=L.S.ElementHelper.BlurInput.extend({includes:[L.S.ElementHelper.IntegerMixin]});L.S.ElementHelper.FloatMixin={value:function(){return!isNaN(this.input.value)&&this.input.value!==''?parseFloat(this.input.value):undefined;},type:function(){return'number';}};L.S.ElementHelper.FloatInput=L.S.ElementHelper.Input.extend({includes:[L.S.ElementHelper.FloatMixin]});L.S.ElementHelper.BlurFloatInput=L.S.ElementHelper.BlurInput.extend({includes:[L.S.ElementHelper.FloatMixin]});L.S.ElementHelper.ColorPicker=L.S.ElementHelper.Input.extend({colors:['Black','Navy','DarkBlue','MediumBlue','Blue','DarkGreen','Green','Teal','DarkCyan','DeepSkyBlue','DarkTurquoise','MediumSpringGreen','Lime','SpringGreen','Aqua','Cyan','MidnightBlue','DodgerBlue','LightSeaGreen','ForestGreen','SeaGreen','DarkSlateGray','DarkSlateGrey','LimeGreen','MediumSeaGreen','Turquoise','RoyalBlue','SteelBlue','DarkSlateBlue','MediumTurquoise','Indigo','DarkOliveGreen','CadetBlue','CornflowerBlue','MediumAquaMarine','DimGray','DimGrey','SlateBlue','OliveDrab','SlateGray','SlateGrey','LightSlateGray','LightSlateGrey','MediumSlateBlue','LawnGreen','Chartreuse','Aquamarine','Maroon','Purple','Olive','Gray','Grey','SkyBlue','LightSkyBlue','BlueViolet','DarkRed','DarkMagenta','SaddleBrown','DarkSeaGreen','LightGreen','MediumPurple','DarkViolet','PaleGreen','DarkOrchid','YellowGreen','Sienna','Brown','DarkGray','DarkGrey','LightBlue','GreenYellow','PaleTurquoise','LightSteelBlue','PowderBlue','FireBrick','DarkGoldenRod','MediumOrchid','RosyBrown','DarkKhaki','Silver','MediumVioletRed','IndianRed','Peru','Chocolate','Tan','LightGray','LightGrey','Thistle','Orchid','GoldenRod','PaleVioletRed','Crimson','Gainsboro','Plum','BurlyWood','LightCyan','Lavender','DarkSalmon','Violet','PaleGoldenRod','LightCoral','Khaki','AliceBlue','HoneyDew','Azure','SandyBrown','Wheat','Beige','WhiteSmoke','MintCream','GhostWhite','Salmon','AntiqueWhite','Linen','LightGoldenRodYellow','OldLace','Red','Fuchsia','Magenta','DeepPink','OrangeRed','Tomato','HotPink','Coral','DarkOrange','LightSalmon','Orange','LightPink','Pink','Gold','PeachPuff','NavajoWhite','Moccasin','Bisque','MistyRose','BlanchedAlmond','PapayaWhip','LavenderBlush','SeaShell','Cornsilk','LemonChiffon','FloralWhite','Snow','Yellow','LightYellow','Ivory','White'],build:function(){L.S.ElementHelper.Input.prototype.build.call(this);this.input.placeholder=this.options.placeholder||L._('Inherit');this.container=L.DomUtil.create('div','storage-color-picker');this.container.style.display='none';this.input.parentNode.insertBefore(this.container,this.input.nextSibling);for(var idx in this.colors){this.addColor(this.colors[idx]);}
this.spreadColor();this.input.autocomplete='off';L.DomEvent.on(this.input,'focus',this.onFocus,this);L.DomEvent.on(this.input,'blur',this.onBlur,this);L.DomEvent.on(this.input,'change',this.onChange,this);L.DomEvent.off(this.input,'input',this.sync,this);L.DomEvent.on(this.input,'input',this.onChange,this);},onFocus:function(){this.container.style.display='block';},onBlur:function(){var self=this,closePicker=function(){self.container.style.display='none';};window.setTimeout(closePicker,100);},onChange:function(){this.spreadColor();this.sync();},spreadColor:function(){if(this.input.value){this.input.style.backgroundColor=this.input.value;}else{this.input.style.backgroundColor='inherit';}},addColor:function(colorName){var span=L.DomUtil.create('span','',this.container);span.style.backgroundColor=span.title=colorName;var updateColorInput=function(){this.input.value=colorName;this.onChange();this.container.style.display='none';};L.DomEvent.on(span,'mousedown',updateColorInput,this);}});L.S.ElementHelper.TextColorPicker=L.S.ElementHelper.ColorPicker.extend({colors:['Black','DarkSlateGrey','DimGrey','SlateGrey','LightSlateGrey','Grey','DarkGrey','LightGrey','White']});L.S.ElementHelper.CheckBox=L.S.ElementHelper.extend({build:function(){var container=L.DomUtil.create('div','formbox',this.form);this.input=L.DomUtil.create('input','',container);this.input.type='checkbox';this.input.name=this.name;this.input._helper=this;this.fetch();L.DomEvent.on(this.input,'change',this.sync,this);},fetch:function(){this.backup=this.toHTML();this.input.checked=this.backup===true;},value:function(){return this.input.checked;},toHTML:function(){return[1,true].indexOf(this.get())!==-1;}});L.S.ElementHelper.SelectAbstract=L.S.ElementHelper.extend({selectOptions:[['value','label']],build:function(){this.select=L.DomUtil.create('select','',this.form);this.select.name=this.name;this.validValues=[];this.buildOptions();L.DomEvent.on(this.select,'change',this.sync,this);},getOptions:function(){return this.selectOptions;},fetch:function(){this.buildOptions();},buildOptions:function(){this.select.innerHTML='';var options=this.getOptions();for(var i=0,l=options.length;i<l;i++){this.buildOption(options[i][0],options[i][1]);}},buildOption:function(value,label){this.validValues.push(value);var option=L.DomUtil.create('option','',this.select);option.value=value;option.innerHTML=label;if(this.toHTML()===value){option.selected='selected';}},value:function(){return this.select[this.select.selectedIndex].value;},getDefault:function(){return this.getOptions()[0][0];},toJS:function(){var value=this.value();if(this.validValues.indexOf(value)!==-1){return value;}else{return this.getDefault();}}});L.S.ElementHelper.IconClassSwitcher=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[[undefined,L._('inherit')],['Default',L._('Default')],['Circle',L._('Circle')],['Drop',L._('Drop')],['Ball',L._('Ball')]]});L.S.ElementHelper.PopupTemplate=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[[undefined,L._('inherit')],['Default',L._('Name and description')],['Large',L._('Name and description (large)')],['Table',L._('Table')],['GeoRSSImage',L._('GeoRSS (title + image)')],['GeoRSSLink',L._('GeoRSS (only link)')],['SimplePanel',L._('Side panel')]],toJS:function(){var value=L.S.ElementHelper.SelectAbstract.prototype.toJS.apply(this);if(value==='table'){value='Table';}
return value;}});L.S.ElementHelper.LayerTypeChooser=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[['Default',L._('Default')],['Cluster',L._('Clustered')],['Heat',L._('Heatmap')],]});L.S.ElementHelper.DataLayerSwitcher=L.S.ElementHelper.SelectAbstract.extend({getOptions:function(){var options=[];this.map.eachDataLayer(function(datalayer){if(datalayer.isLoaded()&&!datalayer.isRemoteLayer()&&datalayer.isBrowsable()){options.push([L.stamp(datalayer),datalayer.getName()]);}});return options;},toHTML:function(){return L.stamp(this.obj.datalayer);},toJS:function(){return this.map.datalayers[this.value()];},set:function(){this.obj.changeDataLayer(this.toJS());}});L.S.ElementHelper.onLoadPanel=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[['none',L._('None')],['caption',L._('Caption')],['databrowser',L._('Data browser')]]});L.S.ElementHelper.DataFormat=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[[undefined,L._('Choose the data format')],['geojson','geojson'],['osm','osm'],['csv','csv'],['gpx','gpx'],['kml','kml'],['georss','georss']]});L.S.ElementHelper.LicenceChooser=L.S.ElementHelper.SelectAbstract.extend({getOptions:function(){var licences=[],licencesList=this.formBuilder.obj.options.licences,licence;for(var i in licencesList){licence=licencesList[i];licences.push([i,licence.name]);}
return licences;},toHTML:function(){return this.get().name;},toJS:function(){return this.formBuilder.obj.options.licences[this.value()];}});L.S.ElementHelper.NullableBoolean=L.S.ElementHelper.SelectAbstract.extend({selectOptions:[[undefined,L._('inherit')],[true,L._('yes')],[false,L._('no')]],toJS:function(){var value=this.value();switch(value){case'true':case true:value=true;break;case'false':case false:value=false;break;default:value=undefined;}
return value;}});L.S.ElementHelper.IconUrl=L.S.ElementHelper.Input.extend({type:function(){return'hidden';},build:function(){L.S.ElementHelper.Input.prototype.build.call(this);this.parentContainer=L.DomUtil.create('div','storage-form-iconfield',this.form);this.buttonsContainer=L.DomUtil.create('div','',this.parentContainer);this.pictogramsContainer=L.DomUtil.create('div','storage-pictogram-list',this.parentContainer);this.input.type='hidden';this.input.placeholder=L._('Url');this.createButtonsBar();},createButtonsBar:function(){if(this.value()&&this.value().indexOf('{')==-1){var img=L.DomUtil.create('img','',L.DomUtil.create('div','storage-icon-choice',this.buttonsContainer));img.src=this.value();L.DomEvent.on(img,'click',this.fetchIconList,this);}
this.button=L.DomUtil.create('a','',this.buttonsContainer);this.button.innerHTML=this.value()?L._('Change symbol'):L._('Add symbol');this.button.href='#';L.DomEvent.on(this.button,'click',L.DomEvent.stop).on(this.button,'click',this.fetchIconList,this);},addIconPreview:function(pictogram){var baseClass='storage-icon-choice',value=pictogram.src,className=value===this.value()?baseClass+' selected':baseClass,container=L.DomUtil.create('div',className,this.pictogramsContainer),img=L.DomUtil.create('img','',container);img.src=value;if(pictogram.name&&pictogram.attribution){img.title=pictogram.name+' — © '+pictogram.attribution;}
L.DomEvent.on(container,'click',function(e){this.input.value=value;this.sync();this.unselectAll(this.pictogramsContainer);L.DomUtil.addClass(container,'selected');this.pictogramsContainer.innerHTML='';this.createButtonsBar();},this);},empty:function(){this.input.value='';this.unselectAll(this.pictogramsContainer);this.sync();this.pictogramsContainer.innerHTML='';this.createButtonsBar();},fetchIconList:function(e){this.map.get(this.map.options.urls.pictogram_list_json,{callback:function(data){this.pictogramsContainer.innerHTML='';this.buttonsContainer.innerHTML='';var title=L.DomUtil.create('h5','',this.pictogramsContainer);title.innerHTML=L._('Choose a symbol');for(var idx in data.pictogram_list){this.addIconPreview(data.pictogram_list[idx]);}
var deleteButton=L.DomUtil.create('a','',this.pictogramsContainer);deleteButton.innerHTML=L._('Remove icon symbol');deleteButton.href='#';deleteButton.style.display='block';deleteButton.style.clear='both';L.DomEvent.on(deleteButton,'click',L.DomEvent.stop).on(deleteButton,'click',this.empty,this);var cancelButton=L.DomUtil.create('a','',this.pictogramsContainer);cancelButton.innerHTML=L._('Cancel');cancelButton.href='#';cancelButton.style.display='block';cancelButton.style.clear='both';L.DomEvent.on(cancelButton,'click',L.DomEvent.stop).on(cancelButton,'click',function(e){this.pictogramsContainer.innerHTML='';this.createButtonsBar();},this);var customButton=L.DomUtil.create('a','',this.pictogramsContainer);customButton.innerHTML=L._('Custom');customButton.href='#';customButton.style.display='block';customButton.style.clear='both';this.map.help.button(customButton,'formatIconURL');L.DomEvent.on(customButton,'click',L.DomEvent.stop).on(customButton,'click',function(e){this.input.type='url';this.pictogramsContainer.innerHTML='';},this);},context:this});},unselectAll:function(container){var els=container.querySelectorAll('div.selected');for(var el in els){if(els.hasOwnProperty(el)){L.DomUtil.removeClass(els[el],'selected');}}}});L.S.ElementHelper.Url=L.S.ElementHelper.Input.extend({type:function(){return'url';}});L.Storage.FormBuilder=L.Class.extend({initialize:function(obj,fields,options){this.obj=obj;this.fields=fields;this.form=L.DomUtil.create('form','storage-form');this.helpers={};this.options=options||{};if(this.options.id){this.form.id=this.options.id;}
if(this.options.className){L.DomUtil.addClass(this.form,this.options.className);}},build:function(){this.form.innerHTML='';for(var idx in this.fields){this.buildField(this.fields[idx]);}
return this.form;},buildField:function(field){var type,helper,options;if(field instanceof Array){options=field[1]||{};helpText=field[2]||null;field=field[0];}else{options=this.defaultOptions[this.getName(field)]||{};}
type=options.handler||'Input';if(L.S.ElementHelper[type]){helper=new L.S.ElementHelper[type](this,field,options);}else{console.error('No element helper for '+type);return;}
this.helpers[field]=helper;helper.on('synced',function(){if(this.options.callback){this.options.callback.call(this.options.callbackContext||this.obj,field);}
this.obj.fire('synced',{field:field});},this);},getter:function(field){var path=field.split('.'),value=this.obj;for(var i=0,l=path.length;i<l;i++){value=value[path[i]];}
return value;},setter:function(field,value){var path=field.split('.'),obj=this.obj,what;for(var i=0,l=path.length;i<l;i++){what=path[i];if(what===path[l-1]){if(typeof value==='undefined'){delete obj[what];}else{obj[what]=value;}}else{obj=obj[what];}}
this.obj.isDirty=true;},resetField:function(field){var backup=this.backup[field],input=this.inputs[field];input.value=backup;this.setter(field,backup);},getName:function(field){var fieldEls=field.split('.');return fieldEls[fieldEls.length-1];},fetchAll:function(){for(var key in this.helpers){if(this.helpers.hasOwnProperty(key)){this.helpers[key].fetch();}}},syncAll:function(){for(var key in this.helpers){if(this.helpers.hasOwnProperty(key)){this.helpers[key].sync();}}},defaultOptions:{name:{label:L._('name')},description:{label:L._('description'),handler:'Textarea',helpEntries:'textFormatting'},color:{handler:'ColorPicker',label:L._('color'),helpText:L._('Must be a CSS valid name (eg.: DarkBlue or #123456)')},opacity:{label:L._('opacity'),helpText:L._('Opacity, from 0.1 to 1.0 (opaque).')},stroke:{handler:'NullableBoolean',label:L._('stroke'),helpText:L._('Whether to display or not the Polygon path.')},weight:{label:L._('weight'),helpText:L._('Path weight in pixels. From 0 to 10.')},fill:{handler:'NullableBoolean',label:L._('fill'),helpText:L._('Whether to fill the path with color.')},fillColor:{handler:'ColorPicker',label:L._('fill color'),helpText:L._('Optional. Same as color if not set.')},fillOpacity:{label:L._('fill opacity'),helpText:L._('Fill opacity, from 0.1 to 1.0 (opaque).')},smoothFactor:{label:L._('smooth factor'),helpText:L._('How much to simplify the polyline on each zoom level (more = better performance and smoother look, less = more accurate)')},dashArray:{label:L._('dash array'),helpText:L._('A string that defines the stroke dash pattern. Ex.: «5, 10, 15».')},iconClass:{handler:'IconClassSwitcher',label:L._('type of icon')},iconUrl:{handler:'IconUrl',label:L._('symbol of the icon')},popupTemplate:{handler:'PopupTemplate',label:L._('template to use for the popup')},popupContentTemplate:{label:L._('Popup content template'),handler:'Textarea',helpEntries:['dynamicProperties','textFormatting'],helpText:L._('You can use formatting and &#123;properties&#125; from your features.'),placeholder:'# {name}'},datalayer:{handler:'DataLayerSwitcher',label:L._('Choose the layer of the feature')},moreControl:{handler:'CheckBox',helpText:L._('Do you want to display the «more» control?')},datalayersControl:{handler:'CheckBox',helpText:L._('Do you want to display the data layers control?')},zoomControl:{handler:'CheckBox',helpText:L._('Do you want to display zoom control?')},scrollWheelZoom:{handler:'CheckBox',helpText:L._('Allow scroll wheel zoom?')},miniMap:{handler:'CheckBox',helpText:L._('Do you want to display a minimap?')},scaleControl:{handler:'CheckBox',helpText:L._('Do you want to display the scale control?')},onLoadPanel:{handler:'onLoadPanel',helpText:L._('Do you want to display a panel on load?')},displayPopupFooter:{handler:'CheckBox',helpText:L._('Do you want to display popup footer?')},captionBar:{handler:'CheckBox',helpText:L._('Do you want to display a caption bar?')},zoomTo:{handler:'IntInput',placeholder:L._('Inherit'),helpText:L._('Zoom level for automatic zooms')},showLabel:{handler:'NullableBoolean',helpText:L._('Add a permanent label')}}});L.Storage.Icon=L.DivIcon.extend({initialize:function(map,options){this.map=map;var default_options={iconSize:null,iconUrl:this.map.getDefaultOption('iconUrl'),feature:null};options=L.Util.extend({},default_options,options);L.Icon.prototype.initialize.call(this,options);this.feature=this.options.feature;if(this.feature&&this.feature.isReadOnly()){this.options.className+=" readonly";}},_getIconUrl:function(name){var url;if(this.feature&&this.feature._getIconUrl(name)){url=this.feature._getIconUrl(name);}
else{url=this.options[name+'Url'];}
return this.formatUrl(url,this.feature);},_getColor:function(){var color;if(this.feature){color=this.feature.getOption("color");}
else if(this.options.color){color=this.options.color;}
else{color=this.map.getDefaultOption('color');}
return color;},formatUrl:function(url,feature){return L.Util.template(url||'',feature?feature.properties:{});}});L.Storage.Icon.Default=L.Storage.Icon.extend({default_options:{iconAnchor:new L.Point(16,40),popupAnchor:new L.Point(0,-40),labelAnchor:new L.Point(12,-20),className:"storage-div-icon"},initialize:function(map,options){options=L.Util.extend({},this.default_options,options);L.Storage.Icon.prototype.initialize.call(this,map,options);},_setColor:function(){var color=this._getColor();this.elements.container.style.backgroundColor=color;this.elements.arrow.style.borderTopColor=color;},createIcon:function(){this.elements={};this.elements.main=L.DomUtil.create('div');this.elements.container=L.DomUtil.create('div','icon_container',this.elements.main);this.elements.arrow=L.DomUtil.create('div','icon_arrow',this.elements.main);this.elements.img=L.DomUtil.create('img',null,this.elements.container);var src=this._getIconUrl('icon');if(src){this.elements.img.src=src;}
this._setColor();this._setIconStyles(this.elements.main,'icon');return this.elements.main;}});L.Storage.Icon.Circle=L.Storage.Icon.extend({initialize:function(map,options){var default_options={iconAnchor:new L.Point(6,6),popupAnchor:new L.Point(0,-6),labelAnchor:new L.Point(0,2),className:"storage-circle-icon"};options=L.Util.extend({},default_options,options);L.Storage.Icon.prototype.initialize.call(this,map,options);},_setColor:function(){this.elements.main.style.backgroundColor=this._getColor();},createIcon:function(){this.elements={};this.elements.main=L.DomUtil.create('div');this.elements.main.innerHTML="&nbsp;";this._setColor();this._setIconStyles(this.elements.main,'icon');return this.elements.main;}});L.Storage.Icon.Drop=L.Storage.Icon.Default.extend({default_options:{iconAnchor:new L.Point(16,42),popupAnchor:new L.Point(0,-42),labelAnchor:new L.Point(12,-20),className:"storage-drop-icon"}});L.Storage.Icon.Ball=L.Storage.Icon.Default.extend({default_options:{iconAnchor:new L.Point(8,30),popupAnchor:new L.Point(0,-28),labelAnchor:new L.Point(4,-20),className:"storage-ball-icon"},createIcon:function(){this.elements={};this.elements.main=L.DomUtil.create('div');this.elements.container=L.DomUtil.create('div','icon_container',this.elements.main);this.elements.arrow=L.DomUtil.create('div','icon_arrow',this.elements.main);this._setColor();this._setIconStyles(this.elements.main,'icon');return this.elements.main;},_setColor:function(){var color=this._getColor("color"),background;if(L.Browser.ielt9){background=color;}
else if(L.Browser.webkit){background="-webkit-gradient( radial, 6 38%, 0, 6 38%, 8, from(white), to("+color+") )";}
else{background="radial-gradient(circle at 6px 38% , white -4px, "+color+" 8px) repeat scroll 0 0 transparent";}
this.elements.container.style.background=background;}});_CACHE_COLOR={};L.Storage.Icon.Cluster=L.DivIcon.extend({options:{iconSize:[40,40]},initialize:function(datalayer,cluster){this.datalayer=datalayer;this.cluster=cluster;},createIcon:function(){var container=L.DomUtil.create('div','leaflet-marker-icon marker-cluster'),div=L.DomUtil.create('div','',container),span=L.DomUtil.create('span','',div),backgroundColor=this.datalayer.getColor(),color;span.innerHTML=this.cluster.getChildCount();div.style.backgroundColor=backgroundColor;if(this.datalayer.options.cluster&&this.datalayer.options.cluster.textColor){color=this.datalayer.options.cluster.textColor;}
if(!color){if(typeof _CACHE_COLOR[backgroundColor]==="undefined"){color=L.DomUtil.TextColorFromBackgroundColor(div);_CACHE_COLOR[backgroundColor]=color;}else{color=_CACHE_COLOR[backgroundColor];}}
div.style.color=color;return container;}});L.Storage.FeatureMixin={form_id:'feature_form',staticOptions:{},initialize:function(map,latlng,options){this.map=map;if(typeof options==='undefined'){options={};}
this.datalayer=options.datalayer ||null;this.properties={_storage_options:{}};if(options.geojson){this.populate(options.geojson);}
var isDirty=false,self=this;try{Object.defineProperty(this,'isDirty',{get:function(){return isDirty;},set:function(status){if(!isDirty&&status){self.fire('isdirty');}
isDirty=status;if(self.datalayer){self.datalayer.isDirty=status;}}});}
catch(e){}
this.preInit();this.addInteractions();this.parentClass.prototype.initialize.call(this,latlng,options);},preInit:function(){},isReadOnly:function(){return this.datalayer&&this.datalayer.isRemoteLayer();},view:function(latlng){if(this.map.editEnabled){return;}
if(this.properties._storage_options.outlink){var win=window.open(this.properties._storage_options.outlink);return;}
if(this.map.slideshow){this.map.slideshow.current=this;}
this.attachPopup();this.openPopup(latlng|| this.getCenter());},openPopup:function(){if(this.map.editEnabled){return;}
this.parentClass.prototype.openPopup.apply(this,arguments);},edit:function(e){if(!this.map.editEnabled||this.isReadOnly())return;var container=L.DomUtil.create('div'),form;var builder=new L.S.FormBuilder(this,['datalayer'],{callback:function(){this.edit(e);}});container.appendChild(builder.build());var properties=[];for(var i in this.properties){if(typeof this.properties[i]==='object'||['name','description'].indexOf(i)!==-1){continue;}
properties.push(['properties.'+i,{label:i}]);}
properties.unshift('properties.description');properties.unshift('properties.name');builder=new L.S.FormBuilder(this,properties,{id:'storage-feature-properties',callback:this.resetLabel});form=builder.build();container.appendChild(form);this.appendEditFieldsets(container);var advancedActions=L.DomUtil.createFieldset(container,L._('Advanced actions'));this.getAdvancedEditActions(advancedActions);L.S.fire('ui:start',{data:{html:container}});this.map.editedFeature=this;this.bringToCenter(e);},getAdvancedEditActions:function(container){var deleteLink=L.DomUtil.create('a','storage-delete',container);deleteLink.href='#';deleteLink.innerHTML=L._('Delete');L.DomEvent.on(deleteLink,'click',function(e){L.DomEvent.stop(e);if(this.confirmDelete()){L.S.fire('ui:end');}},this);},appendEditFieldsets:function(container){var options_fields=this.getAdvancedOptions();builder=new L.S.FormBuilder(this,options_fields,{id:'storage-feature-advanced-properties',callback:this._redraw,callbackContext:this});var advancedProperties=L.DomUtil.createFieldset(container,L._('Advanced properties'));form=builder.build();advancedProperties.appendChild(form);},endEdit:function(){},getDisplayName:function(){return this.properties.name|| this.properties.title|| this.datalayer.options.name;},hasPopupFooter:function(){if(L.Browser.ielt9){return false;}
if(this.datalayer.isRemoteLayer()&&this.datalayer.options.remoteData.dynamic){return false;}
return this.map.options.displayPopupFooter;},getPopupClass:function(){return L.Storage.Popup[this.getOption('popupTemplate')]||L.Storage.Popup;},attachPopup:function(){var Class=this.getPopupClass();this.bindPopup(new Class(this));},confirmDelete:function(){if(confirm(L._('Are you sure you want to delete the feature?'))){this.del();return true;}
return false;},del:function(){this.isDirty=true;this.map.closePopup();if(this.datalayer){this.datalayer.removeLayer(this);this.disconnectFromDataLayer(this.datalayer);}
this.map.removeLayer(this);},connectToDataLayer:function(datalayer){this.datalayer=datalayer;},disconnectFromDataLayer:function(datalayer){if(this.datalayer===datalayer){this.datalayer=null;}},populate:function(feature){this.properties=L.extend({},feature.properties);this.options.title=feature.properties&&feature.properties.name;this.properties._storage_options=L.extend({},this.properties._storage_options);},changeDataLayer:function(datalayer){if(this.datalayer){this.datalayer.isDirty=true;this.datalayer.removeLayer(this);}
datalayer.addLayer(this);datalayer.isDirty=true;this._redraw();},getOption:function(option,fallback){var value=fallback||null;if(typeof this.staticOptions[option]!=='undefined'){value=this.staticOptions[option];}
else if(L.Util.usableOption(this.properties._storage_options,option)){value=this.properties._storage_options[option];}
else if(this.datalayer&&L.Util.usableOption(this.datalayer.options,option)){value=this.datalayer.options[option];}
else{value=this.map.getOption(option);}
return value;},bringToCenter:function(e,callback){var latlng;if(e&&e.zoomTo){this.map._zoom=e.zoomTo;}
if(e&&e.latlng){latlng=e.latlng;}
else{latlng=this.getCenter();}
this.map.panTo(latlng);if(callback){callback();}},zoomTo:function(){this.bringToCenter({zoomTo:this.getOption('zoomTo')});},getNext:function(){return this.datalayer.getNextFeature(this);},getPrevious:function(){return this.datalayer.getPreviousFeature(this);},cloneProperties:function(){var properties=L.extend({},this.properties);properties._storage_options=L.extend({},properties._storage_options);if(Object.keys&&Object.keys(properties._storage_options).length===0){delete properties._storage_options;}
return properties;},deleteProperty:function(property){delete this.properties[property];this.makeDirty();},renameProperty:function(from,to){this.properties[to]=this.properties[from];this.deleteProperty(from);},toGeoJSON:function(){return{type:'Feature',geometry:this.geometry(),properties:this.cloneProperties()};},addInteractions:function(){this.on('contextmenu editable:vertex:contextmenu',this._showContextMenu,this);},_showContextMenu:function(e){var pt=this.map.mouseEventToContainerPoint(e.originalEvent);e.relatedTarget=this;this.map.contextmenu.showAt(pt,e);},makeDirty:function(){this.isDirty=true;},getMap:function(){return this.map;},getContextMenuItems:function(e){var items=[];if(this.map.editEnabled&&!this.isReadOnly()){items=items.concat(this.getEditContextMenuItems(e));}
return items;},getEditContextMenuItems:function(){return['-',{text:L._('Edit this feature'),callback:this.edit,context:this,iconCls:'storage-edit'},{text:L._('Edit feature\'s layer'),callback:this.datalayer.edit,context:this.datalayer,iconCls:'storage-edit'},{text:L._('Delete this feature'),callback:this.confirmDelete,context:this,iconCls:'storage-delete'}];},showTooltip:function(content){this.tooltip=new L.Tooltip(this.map);this.tooltip.updateContent(content);this.updateTooltipPosition();this.map.on('zoomend',this.updateTooltipPosition,this);},removeTooltip:function(){this.map.off('zoomend',this.updateTooltipPosition,this);if(this.tooltip){this.tooltip.dispose();}},updateTooltipPosition:function(){if(!this.tooltip){return;}
this.tooltip.updatePosition(this.getCenter());},onRemove:function(map){this.parentClass.prototype.onRemove.call(this,map);if(this.map.editedFeature===this){this.endEdit();L.Storage.fire('ui:end');}
if(this.tooltip){this.tooltip.dispose();}},resetLabel:function(){if(this.label){this.hideLabel();delete this.label;}
if(this.getOption('showLabel')&&this.properties.name){this.bindLabel(L.Util.escapeHTML(this.properties.name),{noHide:true});this.showLabel();}},matchFilter:function(filter,keys){filter=filter.toLowerCase();for(var i=0;i<keys.length;i++){if((this.properties[keys[i]]||'').toLowerCase().indexOf(filter)!==-1)return true;}
return false;}};L.Storage.Marker=L.Marker.extend({parentClass:L.Marker,includes:[L.Storage.FeatureMixin,L.Mixin.Events],preInit:function(){this.setIcon(this.getIcon());},addInteractions:function(){L.Storage.FeatureMixin.addInteractions.call(this);this.on('dragend',function(e){this.isDirty=true;this.edit(e);},this);this.on('click',this._onClick);if(!this.isReadOnly()){this.on('mouseover',this._enableDragging);}
this.on('mouseout',this._onMouseOut);this._popupHandlersAdded=true;},_onClick:function(e){if(this.map.editEnabled){this.edit(e);}
else{this.view(e.latlng);}},_onMouseOut:function(){if(this.dragging&&this.dragging._draggable&&!this.dragging._draggable._moving){this._disableDragging();}},_enableDragging:function(){if(this.map.editEnabled){if(!this.editEnabled())this.enableEdit();this.map.dragging._draggable._moved=false;}},_disableDragging:function(){if(this.map.editEnabled){if(this.editor&&this.editor.drawing)return;this.disableEdit();}},_redraw:function(){if(this.datalayer&&this.datalayer.isVisible()){this._initIcon();this.update();}},_initIcon:function(){this.options.icon=this.getIcon();L.Marker.prototype._initIcon.call(this);this.resetLabel();},disconnectFromDataLayer:function(datalayer){this.options.icon.datalayer=null;L.Storage.FeatureMixin.disconnectFromDataLayer.call(this,datalayer);},geometry:function(){var latlng=this.getLatLng();return{type:'Point',coordinates:[latlng.lng,latlng.lat]};},_getIconUrl:function(name){if(typeof name==='undefined'){name='icon';}
return this.getOption(name+'Url');},getIconClass:function(){return this.getOption('iconClass');},getIcon:function(){var Class=L.Storage.Icon[this.getIconClass()]||L.Storage.Icon.Default;return new Class(this.map,{feature:this});},getCenter:function(){return this._latlng;},getClassName:function(){return'marker';},getAdvancedOptions:function(){return['properties._storage_options.color','properties._storage_options.iconClass','properties._storage_options.iconUrl','properties._storage_options.popupTemplate','properties._storage_options.zoomTo','properties._storage_options.showLabel'];},appendEditFieldsets:function(container){L.Storage.FeatureMixin.appendEditFieldsets.call(this,container);var coordinatesOptions=[['_latlng.lat',{handler:'FloatInput',label:L._('Latitude')}],['_latlng.lng',{handler:'FloatInput',label:L._('Longitude')}]];builder=new L.S.FormBuilder(this,coordinatesOptions,{callback:function(){this._redraw();this.bringToCenter();},callbackContext:this});var fieldset=L.DomUtil.createFieldset(container,L._('Coordinates'));fieldset.appendChild(builder.build());},bringToCenter:function(e,callback){callback=callback||function(){};if(this.datalayer.isClustered()&&!this._icon){this.datalayer.layer.zoomToShowLayer(this,callback);}else{L.Storage.FeatureMixin.bringToCenter.call(this,e,callback);}}});L.Storage.PathMixin={options:{clickable:true,magnetize:true,magnetPoint:null},_onClick:function(e){this._popupHandlersAdded=true;if(!this.map.editEnabled){this.view(e.latlng);}},edit:function(e){if(this.map.editEnabled){if(!this.editEnabled())this.enableEdit();L.Storage.FeatureMixin.edit.call(this,e);}},_toggleEditing:function(e){if(this.map.editEnabled){if(this.editEnabled()){this.endEdit();L.Storage.fire('ui:end');}
else{this.edit(e);}}
L.DomEvent.stop(e.originalEvent);},closePopup:function(){this.map.closePopup(this._popup);},styleOptions:['smoothFactor','color','opacity','stroke','weight','fill','fillColor','fillOpacity','dashArray','clickable'],_setStyleOptions:function(){var option;for(var idx in this.styleOptions){option=this.styleOptions[idx];this.options[option]=this.getOption(option);}},getAdvancedOptions:function(){return['properties._storage_options.color','properties._storage_options.opacity','properties._storage_options.weight','properties._storage_options.smoothFactor','properties._storage_options.dashArray','properties._storage_options.popupTemplate','properties._storage_options.zoomTo'];},_updateStyle:function(){this._setStyleOptions();L.Polyline.prototype._updateStyle.call(this);if(!this.options.clickable){this._path.setAttribute('pointer-events','stroke');}else{this._path.removeAttribute('pointer-events');}},_redraw:function(){this._updateStyle();},onAdd:function(map){this._container=null;this._setStyleOptions();if(this.map._controls.measureControl){this.map._controls.measureControl.handler.on('enabled',this.showMeasureTooltip,this);this.map._controls.measureControl.handler.on('disabled',function(){this.removeTooltip();},this);}
this.parentClass.prototype.onAdd.call(this,map);if(this.editing&&this.editing.enabled()){this.editing.addHooks();}},onRemove:function(map){if(this.map._controls.measureControl){this.map._controls.measureControl.handler.off('enabled',this.showMeasureTooltip,this);}
if(this.editing&&this.editing.enabled()){this.editing.removeHooks();}
L.S.FeatureMixin.onRemove.call(this,map);},getCenter:function(){return this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)];},zoomTo:function(){if(this.options.zoomTo){L.S.FeatureMixin.zoomTo.call(this);}else{this.map.fitBounds(this.getBounds());}},endEdit:function(){this.disableEdit();L.Storage.FeatureMixin.endEdit.call(this);},_onMouseOver:function(){if(this.map.editEnabled&&!this.map.editedFeature){L.Storage.fire('ui:tooltip',{content:L._('Double-click to edit')});this.once('mouseout',function(){L.Storage.fire('ui:tooltip:abort');});}},showMeasureTooltip:function(){if(this.datalayer.isVisible()){this.showTooltip({text:this.getMeasure()});}},addInteractions:function(){L.Storage.FeatureMixin.addInteractions.call(this);this.on('dragend',this.edit);this.on('click',this._onClick);if(!this.isReadOnly()){this.on('dblclick',this._toggleEditing);}
this.on('mouseover',this._onMouseOver);this.on('edit',this.makeDirty);}};L.Storage.Polyline=L.Polyline.extend({parentClass:L.Polyline,includes:[L.Storage.FeatureMixin,L.Storage.PathMixin,L.Mixin.Events],staticOptions:{stroke:true,fill:false},geometry:function(){return{type:'LineString',coordinates:L.Util.latLngsForGeoJSON(this.getLatLngs())};},getClassName:function(){return'polyline';},getMeasure:function(){var distance=0,latlng,latlngs=this.getLatLngs(),previous;for(var i=0;i<latlngs.length;i++){latlng=latlngs[i];if(previous){distance+=latlng.distanceTo(previous);}
previous=latlng;}
return L.GeometryUtil.readableDistance(distance,true);},getEditContextMenuItems:function(e){var items=L.Storage.FeatureMixin.getEditContextMenuItems.call(this),vertexClicked=e.vertex,index;items.push({text:L._('Transform to polygon'),callback:this.toPolygon,context:this});if(this.map.editedFeature&&this.map.editedFeature instanceof L.Storage.Polyline&&this.map.editedFeature!==this){items.push({text:L._('Merge geometry with edited feature'),callback:function(){this.mergeInto(this.map.editedFeature);this.map.editedFeature.editor.reset();},context:this});}
if(vertexClicked){index=e.vertex.getIndex();if(index!==0&&index!==this._latlngs.length-1){items.push({text:L._('Split line'),callback:function(){this.splitAt(index);},context:this});}else if(index===0){items.push({text:L._('Continue line (Ctrl-click)'),callback:this.editor.continueBackward,context:this.editor});}else if(index===e.vertex.getLastIndex()){items.push({text:L._('Continue line (Ctrl-click)'),callback:this.editor.continueForward,context:this.editor});}}
return items;},toPolygon:function(){var geojson=this.toGeoJSON();geojson.geometry.type='Polygon';geojson.geometry.coordinates=[geojson.geometry.coordinates];var polygon=this.datalayer.geojsonToFeatures(geojson);polygon.edit();this.del();},getAdvancedEditActions:function(container){L.Storage.FeatureMixin.getAdvancedEditActions.call(this,container);var toPolygon=L.DomUtil.create('a','storage-to-polygon',container);toPolygon.href='#';toPolygon.innerHTML=L._('Transform to polygon');L.DomEvent.on(toPolygon,'click',this.toPolygon,this);},mergeInto:function(other){if(!other instanceof L.Storage.Polyline)return;var otherLatlngs=other.getLatLngs(),otherLeft=otherLatlngs[0],otherRight=otherLatlngs[otherLatlngs.length-1],thisLatlngs=this.getLatLngs(),thisLeft=thisLatlngs[0],thisRight=thisLatlngs[thisLatlngs.length-1],l2ldistance=otherLeft.distanceTo(thisLeft),l2rdistance=otherLeft.distanceTo(thisRight),r2ldistance=otherRight.distanceTo(thisLeft),r2rdistance=otherRight.distanceTo(thisRight),toMerge;if(l2rdistance<Math.min(l2ldistance,r2ldistance,r2rdistance)){toMerge=[thisLatlngs,otherLatlngs];}else if(r2ldistance<Math.min(l2ldistance,l2rdistance,r2rdistance)){toMerge=[otherLatlngs,thisLatlngs];}else if(r2rdistance<Math.min(l2ldistance,l2rdistance,r2ldistance)){thisLatlngs.reverse();toMerge=[otherLatlngs,thisLatlngs];}else{thisLatlngs.reverse();toMerge=[thisLatlngs,otherLatlngs];}
var a=toMerge[0],b=toMerge[1],p1=this.map.latLngToContainerPoint(a[a.length-1]),p2=this.map.latLngToContainerPoint(b[0]),tolerance=5;if(Math.abs(p1.x-p2.x)<=tolerance&&Math.abs(p1.y-p2.y)<=tolerance){a.pop();}
other.setLatLngs(a.concat(b));this.del();},splitAt:function(index){if(index===0|| index===this._latlngs.length-1)return;var latlngs=this.getLatLngs(),thisLatlngs=latlngs.slice(0,index+1),otherLatlngs=latlngs.slice(index);var geojson={type:'Feature',geometry:{type:'LineString',coordinates:L.Util.latLngsForGeoJSON(otherLatlngs)},properties:this.cloneProperties()};this.setLatLngs(thisLatlngs);this.isDirty=true;if(this.editEnabled()){this.editor.reset();}
var other=this.datalayer.geojsonToFeatures(geojson);return other;}});L.Storage.Polygon=L.Polygon.extend({parentClass:L.Polygon,includes:[L.Storage.FeatureMixin,L.Storage.PathMixin,L.Mixin.Events],geometry:function(){var latlngs=this.getLatLngs().slice(0),closingPoint=latlngs[0];latlngs.push(closingPoint);var coords=L.Util.latLngsForGeoJSON(latlngs),coordinates=[coords];if(this._holes){for(var i=0;i<this._holes.length;i++){coordinates.push(L.Util.latLngsForGeoJSON(this._holes[i]));}}
return{type:'Polygon',coordinates:coordinates};},getClassName:function(){return'polygon';},getAdvancedOptions:function(){var options=L.Storage.PathMixin.getAdvancedOptions();options.push('properties._storage_options.stroke','properties._storage_options.fill','properties._storage_options.fillColor','properties._storage_options.fillOpacity');options.push(['properties._storage_options.outlink',{label:L._('outlink'),helpText:L._('Define output link to open a new window on polygon click.'),placeholder:'http://...'}]);options.push(['properties._storage_options.clickable',{handler:'NullableBoolean',label:L._('Mouse interactions'),helpText:L._('If false, the polygon will act as a part of the underlying map.')}]);return options;},getMeasure:function(){var area=L.GeometryUtil.geodesicArea(this.getLatLngs());return L.GeometryUtil.readableArea(area,true);},getCenter:function(){var latlngs=this._latlngs,len=latlngs.length,i,j,p1,p2,f,center;for(i=0,j=len-1,area=0,lat=0,lng=0;i<len;j=i++){p1=latlngs[i];p2=latlngs[j];f=p1.lat*p2.lng-p2.lat*p1.lng;lat+=(p1.lat+p2.lat)*f;lng+=(p1.lng+p2.lng)*f;area+=f/2;}
center=area?new L.LatLng(lat/(6*area),lng/(6*area)):latlngs[0];center.area=area;return center;},getEditContextMenuItems:function(){var items=L.Storage.FeatureMixin.getEditContextMenuItems.call(this);if(!this._holes||!this._holes.length){items.push({text:L._('Transform to lines'),callback:this.toPolyline,context:this});}
items.push({text:L._('Start a hole here'),callback:this.startHole,context:this});return items;},startHole:function(e){this.enableEdit();this.editor.newHole(e.latlng);},toPolyline:function(){var geojson=this.toGeoJSON();geojson.geometry.type='LineString';geojson.geometry.coordinates=geojson.geometry.coordinates[0];var polyline=this.datalayer.geojsonToFeatures(geojson);polyline.edit();this.del();},getAdvancedEditActions:function(container){L.Storage.FeatureMixin.getAdvancedEditActions.call(this,container);var toPolyline=L.DomUtil.create('a','storage-to-polyline',container);toPolyline.href='#';toPolyline.innerHTML=L._('Transform to lines');L.DomEvent.on(toPolyline,'click',this.toPolyline,this);}});L.S.Layer={isBrowsable:true,getFeatures:function(){return this._layers;},getEditableOptions:function(){return[];},postUpdate:function(){}};L.S.Layer.Default=L.FeatureGroup.extend({_type:'Default',includes:[L.S.Layer],initialize:function(datalayer){this.datalayer=datalayer;L.FeatureGroup.prototype.initialize.call(this);}});L.S.Layer.Cluster=L.MarkerClusterGroup.extend({_type:'Cluster',includes:[L.S.Layer],initialize:function(datalayer){this.datalayer=datalayer;var options={polygonOptions:{color:this.datalayer.getColor()},iconCreateFunction:function(cluster){return new L.Storage.Icon.Cluster(datalayer,cluster);}};if(this.datalayer.options.cluster&&this.datalayer.options.cluster.radius){options.maxClusterRadius=this.datalayer.options.cluster.radius;}
L.MarkerClusterGroup.prototype.initialize.call(this,options);},getEditableOptions:function(){if(!L.Util.isObject(this.datalayer.options.cluster)){this.datalayer.options.cluster={};}
return[['options.cluster.radius',{handler:'BlurIntInput',placeholder:L._('Clustering radius'),helpText:L._('Override clustering radius (default 80)')}],['options.cluster.textColor',{handler:'TextColorPicker',placeholder:L._('Auto'),helpText:L._('Text color for the cluster label')}],];},postUpdate:function(field){if(field==='options.cluster.radius'){this.datalayer.resetLayer(true);return;}
if(field==='options.color'){this.options.polygonOptions.color=this.datalayer.getColor();}}});L.S.Layer.Heat=L.HeatLayer.extend({_type:'Heat',includes:[L.S.Layer],isBrowsable:false,initialize:function(datalayer){this.datalayer=datalayer;L.HeatLayer.prototype.initialize.call(this,[],this.datalayer.options.heat);},addLayer:function(layer){if(layer instanceof L.Marker){var latlng=layer.getLatLng(),alt;if(this.datalayer.options.heat&&this.datalayer.options.heat.intensityProperty){alt=parseFloat(layer.properties[this.datalayer.options.heat.intensityProperty|| 0]);latlng=new L.LatLng(latlng.lat,latlng.lng,alt);}
this.addLatLng(latlng);}},clearLayers:function(){this.setLatLngs([]);},getFeatures:function(){return{};},getBounds:function(){return L.latLngBounds(this._latlngs);},getEditableOptions:function(){if(!L.Util.isObject(this.datalayer.options.heat)){this.datalayer.options.heat={};}
return[['options.heat.radius',{handler:'BlurIntInput',placeholder:L._('Heatmap radius'),helpText:L._('Override heatmap radius (default 25)')}],['options.heat.intensityProperty',{handler:'BlurInput',placeholder:L._('Heatmap intensity property'),helpText:L._('Optional intensity property for heatmap')}],];},postUpdate:function(field){if(field==='options.heat.intensityProperty'){this.datalayer.resetLayer(true);return;}
if(field==='options.heat.radius'){this.options.radius=this.datalayer.options.heat.radius;}
this._updateOptions();}});L.Storage.DataLayer=L.Class.extend({includes:[L.Mixin.Events],options:{displayOnLoad:true},initialize:function(map,data){this.map=map;this._index=Array();this._layers={};this._geojson=null;var isDirty=false,isDeleted=false,self=this;try{Object.defineProperty(this,'isDirty',{get:function(){return isDirty;},set:function(status){if(!isDirty&&status){self.fire('dirty');}
isDirty=status;if(status){self.map.addDirtyDatalayer(self);}else{self.map.removeDirtyDatalayer(self);self.isDeleted=false;}}});}
catch(e){}
try{Object.defineProperty(this,'isDeleted',{get:function(){return isDeleted;},set:function(status){if(!isDeleted&&status){self.fire('deleted');}
isDeleted=status;if(status)self.isDirty=status;}});}
catch(e){}
this.setStorageId(data.id);this.setOptions(data);this.connectToMap();if((this.map.datalayersOnLoad&&this.storage_id&&this.map.datalayersOnLoad.indexOf(this.storage_id.toString())!==-1)||(!this.map.datalayersOnLoad&&this.options.displayOnLoad)){this.show();}
if(!this.storage_id){this.isDirty=true;}
this.onceLoaded(function(){this.map.on('moveend',function(){if(this.isRemoteLayer()&&this.options.remoteData.dynamic&&this.isVisible()){this.fetchRemoteData();}},this);});},resetLayer:function(force){if(this.options.markercluster){this.options.type='Cluster';delete this.options.markercluster;}
if(this.layer&&this.options.type===this.layer._type&&!force)return;var visible=this.isVisible();if(visible){this.map.removeLayer(this.layer);}
if(this.layer){this.layer.clearLayers();}
var Class=L.S.Layer[this.options.type]||L.S.Layer.Default;this.layer=new Class(this);this.eachLayer(function(layer){this.layer.addLayer(layer);});if(visible){this.map.addLayer(this.layer);}
this.propagateRemote();},eachLayer:function(method,context){for(var i in this._layers){method.call(context||this,this._layers[i]);}
return this;},eachFeature:function(method,context){if(this.layer&&this.layer.isBrowsable){for(var i=0;i<this._index.length;i++){method.call(context||this,this._layers[this._index[i]]);}}
return this;},fetchData:function(){if(!this.storage_id){return;}
this.map.get(this._dataUrl(),{callback:function(geojson,response){if(geojson._storage){this.setOptions(geojson._storage);}
this._etag=response.getResponseHeader('ETag');if(this.isRemoteLayer()){this.fetchRemoteData();}else{this.fromGeoJSON(geojson);}
this._loaded=true;this.fire('loaded');},context:this});},fromGeoJSON:function(geojson){this.addData(geojson);this._geojson=geojson;this.fire('dataloaded');this.fire('datachanged');},clear:function(){this.layer.clearLayers();this._layers={};this._index=Array();if(this._geojson){this._geojson_bk=L.Util.CopyJSON(this._geojson);this._geojson=null;}},reindex:function(){var features=[];this.eachFeature(function(feature){features.push(feature);});L.Util.sortFeatures(features,this.map.getOption('sortKey'));this._index=[];for(var i=0;i<features.length;i++){this._index.push(L.Util.stamp(features[i]));}},fetchRemoteData:function(){var from=parseInt(this.options.remoteData.from,10),to=parseInt(this.options.remoteData.to,10);if((!isNaN(from)&&this.map.getZoom()<from)||(!isNaN(to)&&this.map.getZoom()>to)){this.clear();return;}
var self=this,url=this.map.localizeUrl(this.options.remoteData.url);if(this.options.remoteData.proxy){url=this.map.proxyUrl(url);}
this.map.ajax({uri:url,verb:'GET',callback:function(raw){self.clear();self.rawToGeoJSON(raw,self.options.remoteData.format,function(geojson){self.fromGeoJSON(geojson);});}});},onceLoaded:function(callback,context){if(this.isLoaded()){callback.call(context||this,this);}else{this.once('loaded',callback,context);}
return this;},onceDataLoaded:function(callback,context){if(this.hasDataLoaded()){callback.call(context||this,this);}else{this.once('dataloaded',callback,context);}
return this;},isLoaded:function(){return!this.storage_id||this._loaded;},hasDataLoaded:function(){return!this.storage_id||this._geojson!==null;},setStorageId:function(id){if(!this.storage_id&&id){this.storage_id=id;}},backupOptions:function(){this._backupOptions=L.Util.CopyJSON(this.options);},resetOptions:function(){this.options=L.Util.CopyJSON(this._backupOptions);},setOptions:function(options){L.Util.setOptions(this,options);this.backupOptions();this.resetLayer();},connectToMap:function(){var id=L.stamp(this);if(!this.map.datalayers[id]){this.map.datalayers[id]=this;this.map.datalayers_index.push(this);}
this.map.updateDatalayersControl();},_dataUrl:function(){var template=this.map.options.urls.datalayer_view;return L.Util.template(template,{'pk':this.storage_id,'map_id':this.map.options.storage_id});},isRemoteLayer:function(){return!!(this.options.remoteData&&this.options.remoteData.url&&this.options.remoteData.format);},isClustered:function(){return this.options.type==='Cluster';},addLayer:function(feature){var id=L.stamp(feature);feature.connectToDataLayer(this);this._index.push(id);this._layers[id]=feature;this.layer.addLayer(feature);if(this.hasDataLoaded()){this.fire('datachanged');}},removeLayer:function(feature){var id=L.stamp(feature);feature.disconnectFromDataLayer(this);this._index.splice(this._index.indexOf(id),1);delete this._layers[id];this.layer.removeLayer(feature);if(this.hasDataLoaded()){this.fire('datachanged');}},addData:function(geojson){this.geojsonToFeatures(geojson);},addRawData:function(c,type){var self=this;this.rawToGeoJSON(c,type,function(geojson){self.addData(geojson);});},rawToGeoJSON:function(c,type,callback){var toDom=function(x){return(new DOMParser()).parseFromString(x,'text/xml');};if(type==='csv'){csv2geojson.csv2geojson(c,{delimiter:'auto',includeLatLon:false},function(err,result){if(err){var message='';for(var i=0;i<err.length;i++){message+=err[i].message;}
L.S.fire('ui:alert',{content:message,level:'error'});console.log(err);}else{callback(result);}});}else if(type==='gpx'){callback(toGeoJSON.gpx(toDom(c)));}else if(type==='georss'){callback(GeoRSSToGeoJSON(toDom(c)));}else if(type==='kml'){callback(toGeoJSON.kml(toDom(c)));}else if(type==='osm'){var d;try{d=JSON.parse(c);}catch(e){d=toDom(c);}
callback(osmtogeojson(d,{flatProperties:true}));}else if(type==='geojson'){try{var gj=JSON.parse(c);callback(gj);}catch(err){L.S.fire('ui:alert',{content:'Invalid JSON file: '+err});return;}}},geojsonToFeatures:function(geojson){var features=geojson instanceof Array?geojson:geojson.features,i,len;if(features){L.Util.sortFeatures(features,this.map.getOption('sortKey'));for(i=0,len=features.length;i<len;i++){this.geojsonToFeatures(features[i]);}
return this;}
var geometry=geojson.type==='Feature'?geojson.geometry:geojson;if(!geometry)return;var coords=geometry.coordinates,layer,tmp;switch(geometry.type){case'Point':try{latlng=L.GeoJSON.coordsToLatLng(coords);}catch(e){console.error('Invalid latlng object from',coords);break;}
layer=this._pointToLayer(geojson,latlng);break;case'LineString':latlngs=L.GeoJSON.coordsToLatLngs(coords);layer=this._lineToLayer(geojson,latlngs);break;case'Polygon':latlngs=L.GeoJSON.coordsToLatLngs(coords,1);layer=this._polygonToLayer(geojson,latlngs);break;case'MultiLineString':if(coords.length>=1){tmp=[];for(var j=0,l=coords.length;j<l;j++){tmp=tmp.concat(coords[j]);}
latlngs=L.GeoJSON.coordsToLatLngs(tmp);layer=this._lineToLayer(geojson,latlngs);break;}
case'MultiPolygon':if(coords.length===1){latlngs=L.GeoJSON.coordsToLatLngs(coords[0],1);layer=this._polygonToLayer(geojson,latlngs);break;}
case'GeometryCollection':return this.geojsonToFeatures(geojson.geometries);default:L.S.fire('ui:alert',{content:L._('Skipping unkown geometry.type: {type}',{type:geometry.type}),level:'error'});}
if(layer){this.addLayer(layer);return layer;}},_pointToLayer:function(geojson,latlng){if(this.options.pointToLayer){return options.pointToLayer(geojson,latlng);}
return new L.Storage.Marker(this.map,latlng,{'geojson':geojson,'datalayer':this});},_lineToLayer:function(geojson,latlngs){return new L.Storage.Polyline(this.map,latlngs,{'geojson':geojson,'datalayer':this,color:null});},_polygonToLayer:function(geojson,latlngs){return new L.Storage.Polygon(this.map,latlngs,{'geojson':geojson,'datalayer':this});},importRaw:function(raw,type){this.addRawData(raw,type);this.isDirty=true;this.zoomTo();},importFromFiles:function(files,type){for(var i=0,f;f=files[i];i++){this.importFromFile(f,type);}},importFromFile:function(f,type){var reader=new FileReader(),self=this;type=type||L.Util.detectFileType(f);reader.readAsText(f);reader.onload=function(e){self.importRaw(e.target.result,type);};},importFromUrl:function(url,type){url=this.map.localizeUrl(url);var self=this;L.S.Xhr._ajax({verb:'GET',uri:url,callback:function(data){self.importRaw(data,type);}});},getEditUrl:function(){return L.Util.template(this.map.options.urls.datalayer_update,{'map_id':this.map.options.storage_id,'pk':this.storage_id});},getCreateUrl:function(){return L.Util.template(this.map.options.urls.datalayer_create,{'map_id':this.map.options.storage_id});},getSaveUrl:function(){return(this.storage_id&&this.getEditUrl())||this.getCreateUrl();},getColor:function(){return this.options.color||this.map.getOption('color');},getDeleteUrl:function(){return L.Util.template(this.map.options.urls.datalayer_delete,{'pk':this.storage_id,'map_id':this.map.options.storage_id});},_delete:function(){this.isDeleted=true;this.erase();},empty:function(){if(this.isRemoteLayer())return;this.clear();this.isDirty=true;},clone:function(){var options=L.Util.CopyJSON(this.options);options.name=L._('Clone of {name}',{name:this.options.name});delete options.id;var geojson=L.Util.CopyJSON(this._geojson),datalayer=this.map.createDataLayer(options);datalayer.fromGeoJSON(geojson);return datalayer;},erase:function(){this.hide();delete this.map.datalayers[L.stamp(this)];this.map.datalayers_index.splice(this.map.datalayers_index.indexOf(this),1);this.map.updateDatalayersControl();this.fire('erase');this._leaflet_events_bk=this._leaflet_events;this.off();this.clear();delete this._loaded;},reset:function(){if(this.storage_id){this.resetOptions();if(this._leaflet_events_bk&&!this._leaflet_events){this._leaflet_events=this._leaflet_events_bk;}
this.hide();this.clear();if(this.isRemoteLayer()){this.fetchRemoteData();}else if(this._geojson_bk){this.fromGeoJSON(this._geojson_bk);}
this._loaded=true;this.show();this.isDirty=false;}else{this.erase();}},redraw:function(){this.hide();this.show();},edit:function(){if(!this.map.editEnabled||!this.isLoaded()){return;}
var container=L.DomUtil.create('div'),metadata_fields=['options.name','options.description',['options.type',{handler:'LayerTypeChooser',label:L._('Type of layer')}],['options.displayOnLoad',{label:L._('Display on load'),handler:'CheckBox'}]];var builder=new L.S.FormBuilder(this,metadata_fields,{callback:function(field){this.map.updateDatalayersControl();if(field==='options.type'){this.resetLayer();this.edit();}},callbackContext:this});form=builder.build();container.appendChild(form);var optionsFields=['options.color','options.iconClass','options.iconUrl','options.smoothFactor','options.opacity','options.stroke','options.weight','options.fill','options.fillColor','options.fillOpacity','options.dashArray','options.popupTemplate','options.zoomTo','options.showLabel','options.popupContentTemplate'];optionsFields=optionsFields.concat(this.layer.getEditableOptions());builder=new L.S.FormBuilder(this,optionsFields,{id:'datalayer-advanced-properties',callback:function(field){this.hide();this.layer.postUpdate(field);this.show();}});var advancedProperties=L.DomUtil.createFieldset(container,L._('Advanced properties'));form=builder.build();advancedProperties.appendChild(form);if(!L.Util.isObject(this.options.remoteData)){this.options.remoteData={};}
var remoteDataFields=[['options.remoteData.url',{handler:'Url',label:L._('Url'),helpEntries:'formatURL'}],['options.remoteData.format',{handler:'DataFormat',label:L._('Format')}],['options.remoteData.from',{label:L._('From zoom'),helpText:L._('Optionnal.')}],['options.remoteData.to',{label:L._('To zoom'),helpText:L._('Optionnal.')}],['options.remoteData.dynamic',{handler:'CheckBox',label:L._('Dynamic')}],['options.remoteData.licence',{label:L._('Licence'),helpText:L._('Please be sure the licence is compliant with your use.')}]];if(this.map.options.urls.ajax_proxy){remoteDataFields.push(['options.remoteData.proxy',{handler:'CheckBox',label:L._('Proxy request'),helpText:L._('To use if remote server doesn\'t allow cross domain (slower)')}]);}
var remoteDataContainer=L.DomUtil.createFieldset(container,L._('Remote data'));builder=new L.S.FormBuilder(this,remoteDataFields);remoteDataContainer.appendChild(builder.build());var advancedActions=L.DomUtil.createFieldset(container,L._('Advanced actions'));var deleteLink=L.DomUtil.create('a','delete_datalayer_button storage-delete',advancedActions);deleteLink.innerHTML=L._('Delete');deleteLink.href='#';L.DomEvent.on(deleteLink,'click',L.DomEvent.stop).on(deleteLink,'click',function(){this._delete();L.S.fire('ui:end');},this);if(!this.isRemoteLayer()){var emptyLink=L.DomUtil.create('a','storage-empty',advancedActions);emptyLink.innerHTML=L._('Empty');emptyLink.href='#';L.DomEvent.on(emptyLink,'click',L.DomEvent.stop).on(emptyLink,'click',this.empty,this);}
var cloneLink=L.DomUtil.create('a','storage-clone',advancedActions);cloneLink.innerHTML=L._('Clone');cloneLink.href='#';L.DomEvent.on(cloneLink,'click',L.DomEvent.stop).on(cloneLink,'click',function(){datalayer=this.clone();datalayer.edit();},this);L.S.fire('ui:start',{data:{html:container}});},featuresToGeoJSON:function(){var features=[];this.eachLayer(function(layer){features.push(layer.toGeoJSON());});return features;},show:function(){if(!this.isLoaded()){this.fetchData();}
this.map.addLayer(this.layer);this.fire('show');},hide:function(){this.map.removeLayer(this.layer);this.fire('hide');},toggle:function(){if(!this.isVisible()){this.show();}
else{this.hide();}},zoomTo:function(){if(!this.isVisible()){return;}
var bounds=this.layer.getBounds();if(bounds.isValid()){this.map.fitBounds(bounds);}},isVisible:function(){return this.map.hasLayer(this.layer);},getFeatureByIndex:function(index){if(index===-1){index=this._index.length-1;}
var id=this._index[index];return this._layers[id];},getNextFeature:function(feature){var id=this._index.indexOf(L.stamp(feature)),nextId=this._index[id+1];return nextId?this._layers[nextId]:this.getNextVisible().getFeatureByIndex(0);},getPreviousFeature:function(feature){if(this._index<=1){return null;}
var id=this._index.indexOf(L.stamp(feature)),previousId=this._index[id-1];return previousId?this._layers[previousId]:this.getPreviousVisible().getFeatureByIndex(-1);},getNextVisible:function(){var id=this.map.datalayers_index.indexOf(this),next=this.map.datalayers_index[id+1]||this.map.datalayers_index[0];while(!next.isVisible()|| !next.isBrowsable()||next._index.length===0){next=next.getNextVisible();}
return next;},getPreviousVisible:function(){var id=this.map.datalayers_index.indexOf(this),prev=this.map.datalayers_index[id-1]||this.map.datalayers_index[this.map.datalayers_index.length-1];while(!prev.isVisible()|| !prev.isBrowsable()||prev._index.length===0){prev=prev.getPreviousVisible();}
return prev;},isBrowsable:function(){return this.layer&&this.layer.isBrowsable;},save:function(){if(this.isDeleted){this.saveDelete();return;}
if(!this.isLoaded()){return;}
var geojson={type:'FeatureCollection',features:this.isRemoteLayer()?[]:this.featuresToGeoJSON(),_storage:this.options};this.backupOptions();var formData=new FormData();formData.append('name',this.options.name);formData.append('display_on_load',!!this.options.displayOnLoad);var blob=new Blob([JSON.stringify(geojson)],{type:'application/json'});formData.append('geojson',blob);this.map.post(this.getSaveUrl(),{data:formData,callback:function(data,response){this._geojson=geojson;this._etag=response.getResponseHeader('ETag');this.setStorageId(data.id);this.setOptions(data);this.connectToMap();this.reset();this.map.continueSaving();},context:this,headers:{'If-Match':this._etag|| ''}});},saveDelete:function(){L.S.Xhr.post(this.getDeleteUrl(),{callback:function(){this.isDirty=false;this.map.continueSaving();},context:this});},getMap:function(){return this.map;},getName:function(){return this.options.name||L._('Untitled layer');},tableEdit:function(){if(this.isRemoteLayer()||!this.isVisible())return;var editor=new L.S.TableEditor(this);editor.edit();}});L.TileLayer.include({toJSON:function(){return{minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,attribution:this.options.attribution,url_template:this._url,name:this.options.name,tms:this.options.tms};},getAttribution:function(){return L.Util.toHTML(this.options.attribution);}});L.Storage.Toolbar=L.Control.extend({_createButton:function(options){var link=L.DomUtil.create('a',options.className||'',options.container);link.href='#';L.DomEvent.on(link,'click',L.DomEvent.stop).on(link,'mousedown',L.DomEvent.stop).on(link,'dblclick',L.DomEvent.stop).on(link,'click',options.callback,options.context).on(link,'mouseover',function(){L.Storage.fire('ui:tooltip',{content:options.title,attachTo:link});});return link;},onAdd:function(map){var container=L.DomUtil.create('div','storage-toolbar');this._toolbarContainer=L.DomUtil.create('div','leaflet-bar');var actions=this.getActions(map),action;for(var i=0;i<actions.length;i++){action=actions[i];action.container=this._toolbarContainer;this._createButton(action);}
container.appendChild(this._toolbarContainer);return container;}});L.Storage.SettingsToolbar=L.S.Toolbar.extend({getActions:function(map){return map.getEditActions();}});L.Storage.DrawToolbar=L.S.Toolbar.extend({getActions:function(map){return map.getDrawActions();}});L.Storage.EditControl=L.Control.extend({options:{position:'topright'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-edit-enable storage-control'),edit=L.DomUtil.create('a','',container);edit.href='#';edit.title=L._('Enable editing')+' (Ctrl-E)';L.DomEvent.addListener(edit,'click',L.DomEvent.stop).addListener(edit,'click',map.enableEdit,map);return container;}});L.Control.Embed=L.Control.extend({options:{position:'topleft'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-embed storage-control');var link=L.DomUtil.create('a','',container);link.href='#';link.title=L._('Embed and share this map');L.DomEvent.on(link,'click',L.DomEvent.stopPropagation).on(link,'click',L.DomEvent.preventDefault).on(link,'click',map.renderShareBox,map).on(link,'dblclick',L.DomEvent.stopPropagation);return container;}});L.Storage.MoreControls=L.Control.extend({options:{position:'topleft'},onAdd:function(map){var container=L.DomUtil.create('div',''),more=L.DomUtil.create('a','storage-control-more storage-control-text',container),less=L.DomUtil.create('a','storage-control-less storage-control-text',container);more.href='#';more.title=L._('More controls');more.innerHTML=L._('More');L.DomEvent.on(more,'click',L.DomEvent.stop).on(more,'click',this.toggle,this);less.href='#';less.title=L._('Hide controls');less.innerHTML=L._('Less');L.DomEvent.on(less,'click',L.DomEvent.stop).on(less,'click',this.toggle,this);return container;},toggle:function(){var pos=this.getPosition(),corner=this._map._controlCorners[pos],className='storage-more-controls';if(L.DomUtil.hasClass(corner,className)){L.DomUtil.removeClass(corner,className);}else{L.DomUtil.addClass(corner,className);}}});L.Storage.DataLayersControl=L.Control.extend({options:{position:'topleft'},labels:{zoomToLayer:L._('Zoom to layer extent'),toggleLayer:L._('Show/hide layer'),editLayer:L._('Edit')},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-browse storage-control'),actions=L.DomUtil.create('div','storage-browse-actions',container);this._datalayers_container=L.DomUtil.create('ul','storage-browse-datalayers',actions);var link=L.DomUtil.create('a','storage-browse-link',actions);link.href='#';link.title=link.innerHTML=L._('Browse data');var add=L.DomUtil.create('a','show-on-edit block add-datalayer',actions);add.href='#';add.innerHTML=add.title=L._('Add a layer');var toggle=L.DomUtil.create('a','storage-browse-toggle',container);toggle.href='#';L.DomEvent.on(toggle,'click',L.DomEvent.stop);L.DomEvent.on(link,'click',L.DomEvent.stop).on(link,'click',map.openBrowser,map);L.DomEvent.on(add,'click',L.DomEvent.stop).on(add,'click',this.newDataLayer,this);map.whenReady(function(){this.update();},this);if(!L.Browser.touch){L.DomEvent.disableClickPropagation(container);L.DomEvent.on(container,'mousewheel',L.DomEvent.stopPropagation);L.DomEvent.on(container,'MozMousePixelScroll',L.DomEvent.stopPropagation);}else{L.DomEvent.on(container,'click',L.DomEvent.stopPropagation);}
return container;},update:function(){if(this._datalayers_container){this._datalayers_container.innerHTML='';for(var idx in this._map.datalayers){this.addDataLayer(this._map.datalayers[idx]);}}},addDataLayer:function(datalayer){var datalayer_li=L.DomUtil.create('li','',this._datalayers_container);datalayer.renderToolbox(datalayer_li);var title=L.DomUtil.add('span','layer-title',datalayer_li,datalayer.options.name);datalayer_li.id='browse_data_toggle_'+datalayer.storage_id;L.DomUtil.classIf(datalayer_li,'off',!datalayer.isVisible());title.innerHTML=datalayer.options.name;},newDataLayer:function(){var datalayer=this._map.createDataLayer({});datalayer.edit();}});L.Storage.DataLayer.include({renderToolbox:function(container){var toggle=L.DomUtil.create('i','layer-toggle',container),zoom_to=L.DomUtil.create('i','layer-zoom_to',container),edit=L.DomUtil.create('i','layer-edit show-on-edit',container),table=L.DomUtil.create('i','layer-table-edit show-on-edit',container);zoom_to.title=L._('Zoom to layer extent');toggle.title=L._('Show/hide layer');edit.title=L._('Edit');table.title=L._('Edit properties in a table');L.DomEvent.on(toggle,'click',this.toggle,this);L.DomEvent.on(zoom_to,'click',this.zoomTo,this);L.DomEvent.on(edit,'click',this.edit,this);L.DomEvent.on(table,'click',this.tableEdit,this);L.DomUtil.addClass(container,this.getHidableClass());L.DomUtil.classIf(container,'off',!this.isVisible());},getLocalId:function(){return this.storage_id||'tmp'+L.Util.stamp(this);},getHidableElements:function() {return document.querySelectorAll('.'+this.getHidableClass());},getHidableClass:function(){return'show_with_datalayer_'+this.getLocalId();},propagateRemote:function(){var els=this.getHidableElements();for(var i=0;i<els.length;i++){L.DomUtil.classIf(els[i],'remotelayer',this.isRemoteLayer());}},propagateHide:function(){var els=this.getHidableElements();for(var i=0;i<els.length;i++){L.DomUtil.addClass(els[i],'off');}},propagateShow:function(){this.onceLoaded(function(){var els=this.getHidableElements();for(var i=0;i<els.length;i++){L.DomUtil.removeClass(els[i],'off');}},this);}});L.Storage.DataLayer.addInitHook(function(){this.on('hide',this.propagateHide);this.on('show',this.propagateShow);this.propagateShow();});L.Storage.Map.include({_openBrowser:function(){var browserContainer=L.DomUtil.create('div','storage-browse-data'),title=L.DomUtil.add('h3','storage-browse-title',browserContainer,this.options.name),filter=L.DomUtil.create('input','',browserContainer),filterValue='',featuresContainer=L.DomUtil.create('div','storage-browse-features',browserContainer),filterKeys=(this.options.filterKey||this.options.sortKey|| 'name').split(',');filter.type='text';filter.placeholder=L._('Filter…');var addFeature=function(feature){var feature_li=L.DomUtil.create('li',feature.getClassName()+' feature'),zoom_to=L.DomUtil.create('i','feature-zoom_to',feature_li),edit=L.DomUtil.create('i','show-on-edit feature-edit',feature_li),color=L.DomUtil.create('i','feature-color',feature_li),title=L.DomUtil.create('span','feature-title',feature_li),symbol=feature._getIconUrl?L.S.Icon.prototype.formatUrl(feature._getIconUrl(),feature):null;zoom_to.title=L._('Bring feature to center');edit.title=L._('Edit this feature');title.innerHTML=feature.getDisplayName()||'—';color.style.backgroundColor=feature.getOption('color');if(symbol){color.style.backgroundImage='url('+symbol+')';}
L.DomEvent.on(zoom_to,'click',function(e){this.bringToCenter(e,L.bind(this.view,this));},feature);L.DomEvent.on(edit,'click',function(){this.edit();},feature);return feature_li;};var append=function(datalayer){var container=L.DomUtil.create('div',datalayer.getHidableClass(),featuresContainer),headline=L.DomUtil.create('h5','',container);container.id='browse_data_datalayer_'+datalayer.storage_id;datalayer.renderToolbox(headline);L.DomUtil.add('span','',headline,datalayer.options.name);var ul=L.DomUtil.create('ul','',container);L.DomUtil.classIf(container,'off',!datalayer.isVisible());var build=function(){ul.innerHTML='';datalayer.eachFeature(function(feature){if(filterValue&&!feature.matchFilter(filterValue,filterKeys))return;ul.appendChild(addFeature(feature));});};build();datalayer.on('datachanged',build);L.Storage.once('ui:end',function(){datalayer.off('datachanged',build);});L.Storage.once('ui:ready',function(){L.Storage.once('ui:start',function(){datalayer.off('datachanged',build);});});};var appendAll=function(){featuresContainer.innerHTML='';filterValue=filter.value;this.eachDataLayer(function(datalayer){append(datalayer);});};L.bind(appendAll,this)();L.DomEvent.on(filter,'input',appendAll,this);L.Storage.fire('ui:start',{data:{html:browserContainer}});}});L.Storage.TileLayerControl=L.Control.extend({options:{position:'topleft'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-tilelayers storage-control');var link=L.DomUtil.create('a','',container);link.href='#';link.title=L._('Change map background');L.DomEvent.on(link,'click',L.DomEvent.stopPropagation).on(link,'click',L.DomEvent.preventDefault).on(link,'click',this.openSwitcher,this).on(link,'dblclick',L.DomEvent.stopPropagation);return container;},openSwitcher:function(options){var self=this;this._tilelayers_container=L.DomUtil.create('ul','storage-tilelayer-switcher-container');this.buildList(options);},buildList:function(options){this._map.eachTileLayer(function(tilelayer){this.addTileLayerElement(tilelayer,options);},this);L.Storage.fire('ui:start',{data:{html:this._tilelayers_container}});},addTileLayerElement:function(tilelayer,options){var selectedClass=this._map.hasLayer(tilelayer)?'selected':'',el=L.DomUtil.create('li',selectedClass,this._tilelayers_container),img=L.DomUtil.create('img','',el),name=L.DomUtil.create('div','',el);img.src=L.Util.template(tilelayer.options.url_template,this._map.demoTileInfos);name.innerHTML=tilelayer.options.name;L.DomEvent.on(el,'click',function(e){this._map.selectTileLayer(tilelayer);L.S.fire('ui:end');if(options&&options.callback){options.callback(tilelayer);}},this);}});L.S.AttributionControl=L.Control.Attribution.extend({options:{prefix:''},_update:function(){L.Control.Attribution.prototype._update.call(this);if(this._map.options.shortCredit){L.DomUtil.add('span','',this._container,' — '+L.Util.toHTML(this._map.options.shortCredit));}
var link=L.DomUtil.add('a','',this._container,' — '+L._('About'));L.DomEvent.on(link,'click',L.DomEvent.stop).on(link,'click',this._map.displayCaption,this._map).on(link,'dblclick',L.DomEvent.stop);}});L.Storage.HomeControl=L.Control.extend({options:{position:'topleft'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-home storage-control'),link=L.DomUtil.create('a','',container);link.href='/';link.title=L._('Go to home page');return container;}});L.Storage.LocateControl=L.Control.extend({options:{position:'topleft'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-locate storage-control'),link=L.DomUtil.create('a','',container);link.href='#';link.title=L._('Center map on your location');var fn=function(e){map.locate({setView:true,enableHighAccuracy:true});};L.DomEvent.on(link,'click',L.DomEvent.stopPropagation).on(link,'click',L.DomEvent.preventDefault).on(link,'click',fn,map).on(link,'dblclick',L.DomEvent.stopPropagation);return container;}});L.Storage.JumpToLocationControl=L.Control.extend({options:{position:'topleft',server_url:'http://open.mapquestapi.com/nominatim/v1/search.php'},onAdd:function(map){var container=L.DomUtil.create('div','leaflet-control-search storage-control'),self=this;L.DomEvent.disableClickPropagation(container);var link=L.DomUtil.create('a','',container);var form=L.DomUtil.create('form','',container);var input=L.DomUtil.create('input','',form);link.href='#';link.title=input.placeholder=L._('Jump to location');link.innerHTML='&nbsp;';var fn=function(){var search_terms=input.value;if(!search_terms){return;}
L.DomUtil.addClass(link,'loading');var url=[],bounds=map.getBounds(),viewbox=[bounds.getNorthWest().lng,bounds.getNorthWest().lat,bounds.getSouthEast().lng,bounds.getSouthEast().lat];viewbox=viewbox.join(',');var params={format:'json',q:search_terms,viewbox:viewbox,limit:1};url=self.options.server_url+'?'+L.S.Xhr.buildQueryString(params);L.Storage.Xhr.get(url,{callback:function(data){L.DomUtil.removeClass(link,'loading');if(data.length>0&&data[0].lon&&data[0].lat){map.panTo([data[0].lat,data[0].lon]);map.setZoom(map.getOption('zoomTo'));}
else{L.S.fire('ui:alert',{content:L._('Sorry, no location found for {location}',{location:search_terms})});}}});};L.DomEvent.on(form,'submit',L.DomEvent.stopPropagation).on(form,'submit',L.DomEvent.preventDefault).on(form,'submit',fn);L.DomEvent.on(link,'click',L.DomEvent.stopPropagation).on(link,'click',L.DomEvent.preventDefault).on(link,'click',fn).on(link,'dblclick',L.DomEvent.stopPropagation);return container;}});L.Control.MiniMap.include({initialize:function(layer,options){L.Util.setOptions(this,options);this._layer=this._cloneLayer(layer);},onMainMapBaseLayerChange:function(e){var layer=this._cloneLayer(e.layer);if(this._miniMap.hasLayer(this._layer)){this._miniMap.removeLayer(this._layer);}
this._layer=layer;this._miniMap.addLayer(this._layer);},_cloneLayer:function(layer){return new L.TileLayer(layer._url,L.Util.extend({},layer.options));}});L.Control.Loading.include({onAdd:function(map){this._container=L.DomUtil.create('div','storage-loader',map._controlContainer);map.on('baselayerchange',this._layerAdd,this);this._addMapListeners(map);this._map=map;},_showIndicator:function(){L.DomUtil.addClass(this._map._container,'storage-loading');},_hideIndicator:function(){L.DomUtil.removeClass(this._map._container,'storage-loading');}});L.S.ContextMenu=L.Map.ContextMenu.extend({_createItems:function(e){this._map.setContextMenuItems(e);L.Map.ContextMenu.prototype._createItems.call(this);},_showAtPoint:function(pt,e){this._items=[];this._container.innerHTML='';this._createItems(e);L.Map.ContextMenu.prototype._showAtPoint.call(this,pt,e);}});L.Control.MeasureControl.TITLE=L._('Measure distances');L.S.MeasureControl=L.Control.MeasureControl.extend({onAdd:function(map){L.Control.MeasureControl.prototype.onAdd.call(this,map);L.DomUtil.removeClass(this._container,'leaflet-bar');L.DomUtil.addClass(this._container,'storage-measure-control storage-control');if(map.editTools){map.on('editable:enable',this.handler.disable,this.handler);}
return this._container;}});L.S.IframeExporter=L.Class.extend({includes:[L.Mixin.Events],options:{includeFullScreenLink:true,currentView:false,keepCurrentDatalayers:false},queryString:{scaleControl:false,miniMap:false,scrollWheelZoom:false,zoomControl:true,allowEdit:false,moreControl:true,datalayersControl:true,onLoadPanel:'none'},dimensions:{width:'100%',height:'300px'},initialize:function(map){this.map=map;this.baseUrl=window.location.protocol+'//'+window.location.host+window.location.pathname;this.queryString.onLoadPanel=this.map.options.onLoadPanel;},getMap:function(){return this.map;},build:function(){var datalayers=[];if(this.options.keepCurrentDatalayers){this.map.eachDataLayer(function(datalayer){if(datalayer.isVisible()&&datalayer.storage_id){datalayers.push(datalayer.storage_id);}});this.queryString.datalayers=datalayers.join(',');}else{delete this.queryString.datalayers;}
var currentView=this.options.currentView?window.location.hash:'',iframeUrl=this.baseUrl+'?'+L.S.Xhr.buildQueryString(this.queryString)+currentView,code='<iframe width="'+this.dimensions.width+'" height="'+this.dimensions.height+'" frameBorder="0" src="'+iframeUrl+'"></iframe>';if(this.options.includeFullScreenLink){code+='<p><a href="'+this.baseUrl+'">'+L._('See full screen')+'</a></p>';}
return code;}});L.S.Editable=L.Editable.extend({initialize:function(map,options){L.Editable.prototype.initialize.call(this,map,options);this.on('editable:drawing:start editable:drawing:click',this.drawingTooltip);this.on('editable:drawing:end',this.closeTooltip);this.on('editable:drawing:cancel',function(e){if(e.layer._latlngs&&e.layer._latlngs.length<e.layer.editor.MIN_VERTEX)e.layer.del();if(e.layer instanceof L.S.Marker)e.layer.del();});this.on('editable:drawing:commit',function(e){e.layer.isDirty=true;if(this.map.editedFeature!==e.layer)e.layer.edit(e);});this.on('editable:editing',function(e){e.layer.isDirty=true;});this.on('editable:vertex:ctrlclick',function(e){var index=e.vertex.getIndex();if(index===0)e.layer.editor.continueBackward();else if(index===e.vertex.getLastIndex())e.layer.editor.continueForward();});},createPolyline:function(latlngs){return new L.Storage.Polyline(this.map,latlngs);},createPolygon:function(latlngs){var polygon=new L.Storage.Polygon(this.map,latlngs);return polygon;},createMarker:function(latlng){return new L.Storage.Marker(this.map,latlng);},connectCreatedToMap:function(layer){var datalayer=this.map.defaultDataLayer();datalayer.addLayer(layer);layer.isDirty=true;return layer;},drawingTooltip:function(e){var content;if(e.layer instanceof L.Marker)content=L._('Click to add a marker');else if(e.layer instanceof L.Polyline){if(!e.layer.editor._drawnLatLngs.length){if(e.layer instanceof L.Polygon)content=L._('Click to start drawing a polygon');else if(e.layer instanceof L.Polyline)content=L._('Click to start drawing a line');}else if(e.layer.editor._drawnLatLngs.length<e.layer.editor.MIN_VERTEX){content=L._('Click to continue drawing');}else{content=L._('Click last point to finish shape');}}
if(content)L.S.fire('ui:tooltip',{content:content});},closeTooltip:function(){L.S.fire('ui:tooltip:abort');}});L.S.Slideshow=L.Class.extend({statics:{CLASSNAME:'storage-slideshow-active'},options:{delay:5000,autoplay:false},initialize:function(map,options){this.setOptions(options);this.map=map;this._id=null;var current=null,self=this;try{Object.defineProperty(this,'current',{get:function(){if(!current){var datalayer=this.defaultDatalayer();if(datalayer){current=datalayer.getFeatureByIndex(0);}}
return current;},set:function(feature){current=feature;}});}
catch(e){}
try{Object.defineProperty(this,'next',{get:function(){if(!current){return self.current;}
return current.getNext();}});}
catch(e){}
if(this.options.autoplay){this.map.onceDatalayersLoaded(function(){this.play();},this);}
this.map.on('edit:enabled',function(){this.stop();},this);},setOptions:function(options){L.setOptions(this,options);this.timeSpinner();},defaultDatalayer:function(){var datalayer;for(var i in this.map.datalayers){if(this.map.datalayers.hasOwnProperty(i)){datalayer=this.map.datalayers[i];if(datalayer.isVisible()&&datalayer.isBrowsable()){return datalayer;}}}},timeSpinner:function(){var time=parseInt(this.options.delay,10);if(!time)return;var css='rotation '+time/1000+'s infinite linear',spinners=document.querySelectorAll('.storage-slideshow-toolbox .play .spinner');for(var i=0;i<spinners.length;i++){spinners[i].style.animation=css;spinners[i].style['-webkit-animation']=css;spinners[i].style['-moz-animation']=css;spinners[i].style['-o-animation']=css;}},resetSpinners:function(){var spinners=document.querySelectorAll('.storage-slideshow-toolbox .play .spinner'),el,newOne;for(var i=0;i<spinners.length;i++){el=spinners[i];newOne=el.cloneNode(true);el.parentNode.replaceChild(newOne,el);}},play:function(){if(this._id)return;if(this.map.editEnabled)return;L.DomUtil.addClass(document.body,L.S.Slideshow.CLASSNAME);this._id=window.setInterval(L.bind(this.loop,this),this.options.delay);this.resetSpinners();this.loop();},loop:function(){this.current=this.next;this.step();},pause:function(){if(this._id){L.DomUtil.removeClass(document.body,L.S.Slideshow.CLASSNAME);window.clearInterval(this._id);this._id=null;}},stop:function(){this.pause();this.current=null;},forward:function(){this.pause();this.current=this.next;this.step();},backward:function(){this.pause();if(this.current){this.current=this.current.getPrevious();}
this.step();},step:function(){if(!this.current){this.stop();return;}
this.current.zoomTo();this.current.view();},renderToolbox:function(container){var box=L.DomUtil.create('ul','storage-slideshow-toolbox'),play=L.DomUtil.create('li','play',box),stop=L.DomUtil.create('li','stop',box),prev=L.DomUtil.create('li','prev',box),next=L.DomUtil.create('li','next',box);L.DomUtil.create('div','spinner',play);play.title=L._('Start slideshow');stop.title=L._('Stop slideshow');next.title=L._('Zoom to the next');prev.title=L._('Zoom to the previous');var toggle=function(){if(this._id)this.pause();else this.play();};L.DomEvent.on(play,'click',L.DomEvent.stop).on(play,'click',toggle,this);L.DomEvent.on(stop,'click',L.DomEvent.stop).on(stop,'click',this.stop,this);L.DomEvent.on(prev,'click',L.DomEvent.stop).on(prev,'click',this.backward,this);L.DomEvent.on(next,'click',L.DomEvent.stop).on(next,'click',this.forward,this);container.appendChild(box);this.timeSpinner();return box;}});L.S.TableEditor=L.Class.extend({initialize:function(datalayer){this.datalayer=datalayer;this.table=L.DomUtil.create('div','table');this.header=L.DomUtil.create('div','thead',this.table);this.body=L.DomUtil.create('div','tbody',this.table);this.resetProperties();},renderHeaders:function(){this.header.innerHTML='';for(var i=0;i<this.properties.length;i++){this.renderHeader(this.properties[i]);}},renderHeader:function(property){var container=L.DomUtil.create('div','tcell',this.header),title=L.DomUtil.add('span','',container,property),del=L.DomUtil.create('i','storage-delete',container),rename=L.DomUtil.create('i','storage-edit',container);del.title=L._('Delete this property on all the features');rename.title=L._('Rename this property on all the features');var doDelete=function(){if(confirm(L._('Are you sure you want to delete this property on all the features?'))){this.datalayer.eachLayer(function(feature){feature.deleteProperty(property);});this.resetProperties();this.edit();}};var doRename=function(){var newName=prompt(L._('Please enter the new name of this property'),property);if(!newName)return;this.datalayer.eachLayer(function(feature){feature.renameProperty(property,newName);});this.resetProperties();this.edit();};L.DomEvent.on(del,'click',doDelete,this);L.DomEvent.on(rename,'click',doRename,this);},renderRow:function(feature){var builder=new L.S.FormBuilder(feature,this.field_properties,{id:'storage-feature-properties',className:'trow',callback:feature.resetLabel});this.body.appendChild(builder.build());},compileProperties:function(){var self=this,usable=function(feature,key){return typeof feature.properties[key]!=='object'&&self.properties.indexOf(key)===-1;};this.datalayer.eachLayer(function(feature){for(var key in feature.properties){if(feature.properties.hasOwnProperty(key)&&usable(feature,key)){this.properties.push(key);}}},this);if(this.properties.length===0){this.properties=['name'];}
this.properties.splice(this.properties.indexOf('description'),1);this.properties.sort();this.field_properties=[];for(var i=0;i<this.properties.length;i++){this.field_properties.push(['properties.'+this.properties[i],{wrapper:'div',wrapperClass:'tcell'}]);}},resetProperties:function(){this.properties=[];},edit:function(){var id='tableeditor:edit';this.datalayer.map.fire('dataloading',{id:id});this.compileProperties();this.renderHeaders();this.body.innerHTML='';this.datalayer.eachLayer(this.renderRow,this);var addButton=L.DomUtil.create('li','');L.DomUtil.create('i','storage-icon-16 storage-add',addButton);var label=L.DomUtil.create('span','',addButton);label.innerHTML=label.title=L._('Add a new property');var addProperty=function(){var newName=prompt(L._('Please enter the name of the property'));if(!newName)return;this.properties=[newName];this.edit();};L.DomEvent.on(addButton,'click',addProperty,this);var className=(this.properties.length>2)?'storage-table-editor fullwidth':'storage-table-editor';L.S.fire('ui:start',{data:{html:this.table},cssClass:className,actions:[addButton]});this.datalayer.map.fire('dataload',{id:id});}});L.Map.mergeOptions({base_layers:null,overlay_layers:null,datalayers:[],center:[4,50],zoom:6,hash:true,embedControl:true,datalayersControl:true,default_color:'DarkBlue',default_smoothFactor:1.0,default_opacity:0.5,default_fillOpacity:0.3,default_stroke:true,default_fill:true,default_weight:3,default_iconClass:'Default',default_zoomTo:16,default_popupContentTemplate:'# {name}\n{description}',attributionControl:false,allowEdit:true,homeControl:true,zoomControl:true,locateControl:true,jumpToLocationControl:true,editInOSMControl:false,editInOSMControlOptions:false,scaleControl:true,miniMap:false,name:'',description:'',displayPopupFooter:false,demoTileInfos:{s:'a',z:9,x:265,y:181},tilelayersControl:true,licences:[],licence:'',enableMarkerDraw:true,enablePolygonDraw:true,enablePolylineDraw:true,limitBounds:{},importPresets:[],moreControl:true,captionBar:false,slideshow:{},clickable:true});L.Storage.Map.include({initialize:function(el,geojson){if(geojson.properties&&geojson.properties.locale){L.setLocale(geojson.properties.locale);}
var zoomControl=typeof geojson.properties.zoomControl!=='undefined'?geojson.properties.zoomControl:true;geojson.properties.zoomControl=false;L.Util.setBooleanFromQueryString(geojson.properties,'scrollWheelZoom');L.Map.prototype.initialize.call(this,el,geojson.properties);this.initLoader();this.name=this.options.name;this.description=this.options.description;this.demoTileInfos=this.options.demoTileInfos;if(geojson.geometry){this.options.center=geojson.geometry;}
this.options.zoomControl=zoomControl;this.overrideBooleanOptionFromQueryString('zoomControl');this.overrideBooleanOptionFromQueryString('moreControl');this.overrideBooleanOptionFromQueryString('miniMap');this.overrideBooleanOptionFromQueryString('scaleControl');this.overrideBooleanOptionFromQueryString('allowEdit');this.overrideBooleanOptionFromQueryString('datalayersControl');this.overrideBooleanOptionFromQueryString('displayDataBrowserOnLoad');this.overrideBooleanOptionFromQueryString('displayCaptionOnLoad');this.datalayersOnLoad=L.Util.queryString('datalayers');if(this.datalayersOnLoad)this.datalayersOnLoad=this.datalayersOnLoad.toString().split(',');if(L.Browser.ielt9){this.options.allowEdit=false;}
var editedFeature=null;try{Object.defineProperty(this,'editedFeature',{get:function(){return editedFeature;},set:function(feature){if(editedFeature&&editedFeature!=feature){editedFeature.endEdit();}
editedFeature=feature;}});}
catch(e){}
if(this.options.hash){this.addHash();}
this.initCenter();this.handleLimitBounds();this.initTileLayers(this.options.tilelayers);this.initControls();this.datalayers={};this.datalayers_index=Array();this.dirty_datalayers=Array();this.initDatalayers();if(this.options.displayCaptionOnLoad){if(!this.options.onLoadPanel){this.options.onLoadPanel='caption';}
delete this.options.displayCaptionOnLoad;}
if(this.options.displayDataBrowserOnLoad){if(!this.options.onLoadPanel){this.options.onLoadPanel='databrowser';}
delete this.options.displayDataBrowserOnLoad;}
if(this.options.onLoadPanel==='databrowser'){this.openBrowser();}else if(this.options.onLoadPanel==='caption'){this.displayCaption();}
L.Storage.on('ui:closed',function(){this.invalidateSize({pan:false});},this);var isDirty=false,self=this;try{Object.defineProperty(this,'isDirty',{get:function(){return isDirty|| this.dirty_datalayers.length;},set:function(status){if(!isDirty&&status){self.fire('isdirty');}
isDirty=status;self.checkDirty();}});}
catch(e){}
this.on('baselayerchange',function(e){if(this._controls.miniMap){this._controls.miniMap.onMainMapBaseLayerChange(e);}},this);if(!this.options.storage_id){this.isDirty=true;this.options.name=L._('Untitled map');this.options.allowEdit=true;var datalayer=this.createDataLayer();datalayer.connectToMap();this.enableEdit();var dataUrl=L.Util.queryString('dataUrl',null),dataFormat=L.Util.queryString('dataFormat','geojson');if(dataUrl){dataUrl=decodeURIComponent(dataUrl);dataUrl=this.localizeUrl(dataUrl);dataUrl=this.proxyUrl(dataUrl);datalayer.importFromUrl(dataUrl,dataFormat);}}
this.help=new L.Storage.Help(this);this.slideshow=new L.S.Slideshow(this,this.options.slideshow);this.initCaptionBar();if(this.options.allowEdit){L.Storage.fire('ui:tooltip:init',{map:this});this.editTools=new L.S.Editable(this);L.Storage.on('ui:end ui:start',function(){this.editedFeature=null;},this);this.initEditBar();var editShortcuts=function(e){var key=e.keyCode;if(key==L.S.Keys.E&&e.ctrlKey&&!this.editEnabled){L.DomEvent.stop(e);this.enableEdit();}else if(key==L.S.Keys.E&&e.ctrlKey&&this.editEnabled&&!this.isDirty){L.DomEvent.stop(e);this.disableEdit();L.S.fire('ui:end');}
if(key==L.S.Keys.S&&e.ctrlKey){L.DomEvent.stop(e);if(this.isDirty){this.save();}}
if(key==L.S.Keys.Z&&e.ctrlKey&&this.isDirty){L.DomEvent.stop(e);this.askForReset();}
if(key==L.S.Keys.M&&e.ctrlKey&&this.editEnabled){L.DomEvent.stop(e);this.editTools.startMarker();}
if(key==L.S.Keys.P&&e.ctrlKey&&this.editEnabled){L.DomEvent.stop(e);this.editTools.startPolygon();}
if(key==L.S.Keys.L&&e.ctrlKey&&this.editEnabled){L.DomEvent.stop(e);this.editTools.startPolyline();}
if(key==L.S.Keys.I&&e.ctrlKey&&this.editEnabled){L.DomEvent.stop(e);this.importPanel();}
if(key==L.S.Keys.H&&e.ctrlKey&&this.editEnabled){L.DomEvent.stop(e);this.help.show('edit');}
if(e.keyCode==L.S.Keys.ESC&&this.editEnabled){this.editTools.stopDrawing();}};L.DomEvent.addListener(document,'keydown',editShortcuts,this);}
window.onbeforeunload=function(){if(self.isDirty){return true;}};this.backupOptions();this.initContextMenu();},overrideBooleanOptionFromQueryString:function(name){L.Util.setBooleanFromQueryString(this.options,name);},initControls:function(){this._controls=this._controls||{};for(var i in this._controls){this.removeControl(this._controls[i]);delete this._controls[i];}
L.DomUtil.classIf(document.body,'storage-caption-bar-enabled',this.options.captionBar||(this.options.slideshow&&(this.options.slideshow.delay|| this.options.slideshow.autoplay)));L.DomUtil.classIf(document.body,'storage-slideshow-enabled',this.options.slideshow&&(this.options.slideshow.delay||this.options.slideshow.autoplay));if(this.options.zoomControl){this._controls.zoomControl=(new L.Control.Zoom({zoomInTitle:L._('Zoom in'),zoomOutTitle:L._('Zoom out')})).addTo(this);}
if(this.options.datalayersControl){this._controls.datalayersControl=new L.Storage.DataLayersControl().addTo(this);}
if(this.options.allowEdit){this._controls.toggleEdit=new L.Storage.EditControl(this);this.addControl(this._controls.toggleEdit);this._controls.drawToolbar=new L.S.DrawToolbar(this);this.addControl(this._controls.drawToolbar);this._controls.settingsToolbar=new L.S.SettingsToolbar(this);this.addControl(this._controls.settingsToolbar);}
if(this.options.moreControl){this._controls.moreControl=(new L.Storage.MoreControls()).addTo(this);this._controls.homeControl=(new L.Storage.HomeControl()).addTo(this);this._controls.locateControl=(new L.Storage.LocateControl()).addTo(this);this._controls.jumpToLocationControl=(new L.Storage.JumpToLocationControl()).addTo(this);this._controls.embedControl=(new L.Control.Embed(this,this.options.embedOptions)).addTo(this);this._controls.tilelayersControl=new L.Storage.TileLayerControl().addTo(this);var editInOSMControlOptions={position:'topleft',widgetOptions:{helpText:L._('Open this map extent in a map editor to provide more accurate data to OpenStreetMap')}};this._controls.editInOSMControl=(new L.Control.EditInOSM(editInOSMControlOptions)).addTo(this);var measureOptions={handler:{icon:new L.DivIcon({iconSize:new L.Point(8,8),className:'leaflet-div-icon leaflet-editing-icon storage-measure-edge'}),shapeOptions:{stroke:true,color:'darkslategray',weight:3,opacity:0.5,fill:false,clickable:false}}};this._controls.measureControl=(new L.S.MeasureControl(measureOptions).addTo(this));}
if(this.options.scaleControl){this._controls.scaleControl=L.control.scale().addTo(this);}
this._controls.attribution=new L.S.AttributionControl().addTo(this);if(this.options.miniMap){this.whenReady(function(){if(this.selected_tilelayer){this._controls.miniMap=new L.Control.MiniMap(this.selected_tilelayer).addTo(this);this._controls.miniMap._miniMap.invalidateSize();}});}
if(this.options.scrollWheelZoom){this.scrollWheelZoom.enable();}else{this.scrollWheelZoom.disable();}},initDatalayers:function(){var toload=0,datalayer,seen=0,self=this;var decrementToLoad=function(){toload--;if(toload===0){loaded();}};var loaded=function(){self.fire('datalayersloaded');self.datalayersLoaded=true;};for(var j in this.options.datalayers){if(this.options.datalayers.hasOwnProperty(j)){toload++;seen++;datalayer=this.createDataLayer(this.options.datalayers[j]);datalayer.onceLoaded(decrementToLoad);}}
if(seen===0){loaded();}},onceDatalayersLoaded:function(callback,context){if(this.datalayersLoaded){callback.call(context||this,this);}else{this.once('datalayersloaded',callback,context);}
return this;},updateDatalayersControl:function(){if(this._controls.datalayersControl){this._controls.datalayersControl.update();}},backupOptions:function(){this._backupOptions=L.extend({},this.options);this._backupOptions.tilelayer=L.extend({},this.options.tilelayer);this._backupOptions.limitBounds=L.extend({},this.options.limitBounds);},resetOptions:function(){this.options=L.extend({},this._backupOptions);this.options.tilelayer=L.extend({},this._backupOptions.tilelayer);},initTileLayers:function(){this.tilelayers=Array();for(var i in this.options.tilelayers){if(this.options.tilelayers.hasOwnProperty(i)){this.tilelayers.push(this.createTileLayer(this.options.tilelayers[i]));if(this.options.tilelayer&&this.options.tilelayer.url_template===this.options.tilelayers[i].url_template){this.options.tilelayer.attribution=this.options.tilelayers[i].attribution;}}}
if(this.options.tilelayer&&this.options.tilelayer.url_template&&this.options.tilelayer.attribution){this.customTilelayer=this.createTileLayer(this.options.tilelayer);this.selectTileLayer(this.customTilelayer);}else{this.selectTileLayer(this.tilelayers[0]);}},createTileLayer:function(tilelayer){return new L.TileLayer(tilelayer.url_template,tilelayer);},selectTileLayer:function(tilelayer){if(tilelayer===this.selected_tilelayer){return;}
try{this.fire('baselayerchange',{layer:tilelayer});this.addLayer(tilelayer);if(this.selected_tilelayer){this.removeLayer(this.selected_tilelayer);}
this.selected_tilelayer=tilelayer;if(!isNaN(this.selected_tilelayer.options.minZoom)&&this.getZoom()<this.selected_tilelayer.options.minZoom){this.setZoom(this.selected_tilelayer.options.minZoom);}
if(!isNaN(this.selected_tilelayer.options.maxZoom)&&this.getZoom()>this.selected_tilelayer.options.maxZoom){this.setZoom(this.selected_tilelayer.options.maxZoom);}}catch(e){this.removeLayer(tilelayer);L.S.fire('ui:alert',{content:L._('Error in the tilelayer URL')+': '+tilelayer._url,level:'error'});}},eachTileLayer:function(method,context){var urls=[];for(var i in this.tilelayers){if(this.tilelayers.hasOwnProperty(i)){method.call(context,this.tilelayers[i]);urls.push(this.tilelayers[i]._url);}}
if(this.customTilelayer&&(Array.prototype.indexOf&&urls.indexOf(this.customTilelayer._url)===-1)){method.call(context||this,this.customTilelayer);}},initCenter:function(){if(this.options.hash&&this._hash.parseHash(location.hash)){this._hash.update();}
else if(this.options.locate&&this.options.locate.setView){this.locate(this.options.locate);}
else{this.options.center=this.latLng(this.options.center);this.setView(this.options.center,this.options.zoom);}},latLng:function(a,b,c){if(!(a instanceof L.LatLng)&&a.coordinates){a=Array(a.coordinates[1],a.coordinates[0]);}
return L.latLng(a,b,c);},handleLimitBounds:function(){var south=parseFloat(this.options.limitBounds.south),west=parseFloat(this.options.limitBounds.west),north=parseFloat(this.options.limitBounds.north),east=parseFloat(this.options.limitBounds.east);if(!isNaN(south)&&!isNaN(west)&&!isNaN(north)&&!isNaN(east)){var bounds=L.latLngBounds([[south,west],[north,east]]);this.options.minZoom=this.getBoundsZoom(bounds,false);try{this.setMaxBounds(bounds);}catch(e){console.error('Error limiting bounds',e);}}else{this.options.minZoom=0;this.setMaxBounds();}},createDataLayer:function(datalayer){datalayer=datalayer||{name:L._('Layer')+' '+(this.datalayers_index.length+1)};return new L.Storage.DataLayer(this,datalayer);},getDefaultOption:function(option){return this.options['default_'+option]||null;},getOption:function(option){if(L.Util.usableOption(this.options,option)){return this.options[option];}else{return this.getDefaultOption(option);}},updateExtent:function(){this.options.center=this.getCenter();this.options.zoom=this.getZoom();this.isDirty=true;L.Storage.fire('ui:alert',{content:L._('The zoom and center have been setted.'),'level':'info'});},updateTileLayers:function(){var self=this,callback=function(tilelayer){self.options.tilelayer=tilelayer.toJSON();self.isDirty=true;};if(this._controls.tilelayersControl){this._controls.tilelayersControl.openSwitcher({callback:callback});}},renderShareBox:function(){var container=L.DomUtil.create('div','storage-share'),embedTitle=L.DomUtil.add('h4','',container,L._('Embed the map')),iframe=L.DomUtil.create('textarea','storage-share-iframe',container);var UIFields=[['dimensions.width',{handler:'Input',label:L._('width')}],['dimensions.height',{handler:'Input',label:L._('height')}],['options.includeFullScreenLink',{handler:'CheckBox',helpText:L._('Include full screen link?')}],['options.currentView',{handler:'CheckBox',helpText:L._('Current view instead of default map view?')}],['options.keepCurrentDatalayers',{handler:'CheckBox',helpText:L._('Keep current visible layers')}],'queryString.moreControl','queryString.datalayersControl','queryString.zoomControl','queryString.scrollWheelZoom','queryString.miniMap','queryString.scaleControl','queryString.onLoadPanel'];var iframeExporter=new L.S.IframeExporter(this);var buildIframeCode=function(){iframe.innerHTML=iframeExporter.build();};buildIframeCode();var builder=new L.S.FormBuilder(iframeExporter,UIFields,{callback:buildIframeCode});var iframeOptions=L.DomUtil.createFieldset(container,L._('Iframe export options'));iframeOptions.appendChild(builder.build());if(this.options.shortUrl){L.DomUtil.create('hr','',container);L.DomUtil.add('h4','',container,L._('Short URL'));var shortUrl=L.DomUtil.create('input','storage-short-url',container);shortUrl.type='text';shortUrl.value=this.options.shortUrl;}
L.DomUtil.create('hr','',container);L.DomUtil.add('h4','',container,L._('Download raw data'));var typeInput=L.DomUtil.create('select','',container);typeInput.name='format';L.DomUtil.add('small','help-text',container,L._('Only visible features will be downloaded.'));var types={geojson:{formatter:function(gj){return JSON.stringify(gj,null,2);},ext:'.geojson',filetype:'application/json'},gpx:{formatter:togpx,ext:'.gpx',filetype:'application/xml'},kml:{formatter:tokml,ext:'.kml',filetype:'application/vnd.google-earth.kml+xml'}};for(var key in types){if(types.hasOwnProperty(key)){option=L.DomUtil.create('option','',typeInput);option.value=option.innerHTML=key;}}
var download=L.DomUtil.create('a','button',container);download.innerHTML=L._('Download data');L.DomEvent.on(download,'click',function(){var type=types[typeInput.value],content=type.formatter(this.toGeoJSON()),name=this.options.name||'data';name=name.replace(/[^a-z0-9]/gi,'_').toLowerCase();download.download=name+type.ext;window.URL=window.URL||window.webkitURL;var blob=new Blob([content],{type:type.filetype});download.href=window.URL.createObjectURL(blob);},this);L.S.fire('ui:start',{data:{html:container}});},toGeoJSON:function(){var features=[];this.eachDataLayer(function(datalayer){if(datalayer.isVisible()){features=features.concat(datalayer.featuresToGeoJSON());}});var geojson={type:'FeatureCollection',features:features};return geojson;},updatePermissions:function(){if(!this.options.storage_id){L.S.fire('ui:alert',{content:L._('Please save the map before'),level:'info'});return;}
var url=L.Util.template(this.options.urls.map_update_permissions,{'map_id':this.options.storage_id});this.get(url,{'listen_form':{'id':'map_edit'}});},importPanel:function(){var container=L.DomUtil.create('div','storage-upload'),title=L.DomUtil.create('h4','',container),presetBox=L.DomUtil.create('div','formbox',container),presetSelect=L.DomUtil.create('select','',presetBox),fileBox=L.DomUtil.create('div','formbox',container),fileInput=L.DomUtil.create('input','',fileBox),urlInput=L.DomUtil.create('input','',container),rawInput=L.DomUtil.create('textarea','',container),typeLabel=L.DomUtil.create('label','',container),layerLabel=L.DomUtil.create('label','',container),submitInput=L.DomUtil.create('input','',container),map=this,option,types=['geojson','csv','gpx','kml','osm','georss'];title.innerHTML=L._('Import data');fileInput.type='file';fileInput.multiple='multiple';submitInput.type='button';submitInput.value=L._('Import');submitInput.className='button';typeLabel.innerHTML=L._('Choose the format of the data to import');this.help.button(typeLabel,'importFormats');var typeInput=L.DomUtil.create('select','',typeLabel);typeInput.name='format';layerLabel.innerHTML=L._('Choose the layer to import in');var layerInput=L.DomUtil.create('select','',layerLabel);layerInput.name='datalayer';urlInput.type='text';urlInput.placeholder=L._('Provide an URL here');rawInput.placeholder=L._('Paste here your data');this.eachDataLayer(function(datalayer){if(datalayer.isLoaded()){var id=L.stamp(datalayer);option=L.DomUtil.create('option','',layerInput);option.value=id;option.innerHTML=datalayer.options.name;}});L.DomUtil.element('option',{value:'',innerHTML:L._('Import in a new layer')},layerInput);L.DomUtil.element('option',{value:'',innerHTML:L._('Choose the data format')},typeInput);for(var i=0;i<types.length;i++){option=L.DomUtil.create('option','',typeInput);option.value=option.innerHTML=types[i];}
if(this.options.importPresets.length){var noPreset=L.DomUtil.create('option','',presetSelect);noPreset.value=noPreset.innerHTML=L._('Choose a preset');for(var j=0;j<this.options.importPresets.length;j++){option=L.DomUtil.create('option','',presetSelect);option.value=this.options.importPresets[j].url;option.innerHTML=this.options.importPresets[j].label;}}else{presetBox.style.display='none';}
var submit=function(){var type=typeInput.value,layerId=layerInput[layerInput.selectedIndex].value,layer;if(layerId)layer=map.datalayers[layerId];if(fileInput.files.length){if(layer){layer.importFromFiles(fileInput.files,type);}else{for(var i=0,f;f=fileInput.files[i];i++){layer=this.createDataLayer({name:f.name});layer.importFromFile(f,type);}}}else{if(!layer)layer=this.createDataLayer();if(!type)return L.S.fire('ui:alert',{content:L._('Please choose a format'),level:'error'});else if(rawInput.value)layer.importRaw(rawInput.value,type);else if(urlInput.value)layer.importFromUrl(urlInput.value,type);else if(presetSelect.selectedIndex>0)layer.importFromUrl(presetSelect[presetSelect.selectedIndex].value,type);}};L.DomEvent.on(submitInput,'click',submit,this);L.DomEvent.on(fileInput,'change',function(e){var type='',newType;for(var i=0;i<e.target.files.length;i++){newType=L.Util.detectFileType(e.target.files[i]);if(!type&&newType)type=newType;if(type&&newType!==type){type='';break;}}
typeInput.value=type;},this);L.S.fire('ui:start',{data:{html:container}});},openBrowser:function(){this.whenReady(function(){this._openBrowser();});},displayCaption:function(){var container=L.DomUtil.create('div','storage-caption'),title=L.DomUtil.create('h3','',container);title.innerHTML=this.options.name;if(this.options.author&&this.options.author.name&&this.options.author.link){var authorContainer=L.DomUtil.add('h5','storage-map-author',container,L._('by')+' '),author=L.DomUtil.create('a');author.href=this.options.author.link;author.innerHTML=this.options.author.name;authorContainer.appendChild(author);}
if(this.options.description){var description=L.DomUtil.create('div','storage-map-description',container);description.innerHTML=L.Util.toHTML(this.options.description);}
var datalayerContainer=L.DomUtil.create('div','datalayer-container',container);this.eachDataLayer(function(datalayer){var p=L.DomUtil.create('p','',datalayerContainer),color=L.DomUtil.create('span','datalayer-color',p),headline=L.DomUtil.create('strong','',p),description=L.DomUtil.create('span','',p);datalayer.onceLoaded(function(){color.style.backgroundColor=this.getColor();if(datalayer.options.description){description.innerHTML=datalayer.options.description;}});datalayer.renderToolbox(headline);L.DomUtil.add('span','',headline,datalayer.options.name+' ');});var creditsContainer=L.DomUtil.create('div','credits-container',container),credits=L.DomUtil.createFieldset(creditsContainer,L._('Credits'));title=L.DomUtil.add('h5','',credits,L._('User content credits'));if(this.options.shortCredit|| this.options.longCredit){L.DomUtil.add('p','',credits,L.Util.toHTML(this.options.longCredit|| this.options.shortCredit));}
if(this.options.licence){var licence=L.DomUtil.add('p','',credits,L._('Map user content has been published under licence')+' '),link=L.DomUtil.add('a','',licence,this.options.licence.name);link.href=this.options.licence.url;}else{L.DomUtil.add('p','',credits,L._('No licence has been set'));}
L.DomUtil.create('hr','',credits);title=L.DomUtil.create('h5','',credits);title.innerHTML=L._('Map background credits');var tilelayerCredit=L.DomUtil.create('p','',credits),name=L.DomUtil.create('strong','',tilelayerCredit),attribution=L.DomUtil.create('span','',tilelayerCredit);name.innerHTML=this.selected_tilelayer.options.name+' ';attribution.innerHTML=this.selected_tilelayer.getAttribution();L.DomUtil.create('hr','',credits);var umapCredit=L.DomUtil.create('p','',credits),urls={leaflet:'http://leafletjs.com',django:'https://www.djangoproject.com',umap:'http://wiki.openstreetmap.org/wiki/UMap'};umapCredit.innerHTML=L._('Powered by <a href="{leaflet}">Leaflet</a> and <a href="{django}">Django</a>, glued by <a href="{umap}">uMap project</a>.',urls);L.S.fire('ui:start',{data:{html:container}});},eachDataLayer:function(method,context){for(var i in this.datalayers){if(this.datalayers.hasOwnProperty(i)){method.call(context,this.datalayers[i]);}}},reset:function(){if(this.editTools)this.editTools.stopDrawing();this.resetOptions();this.dirty_datalayers.slice().forEach(function(datalayer){if(datalayer.isDeleted){datalayer.connectToMap();}
datalayer.reset();});this.dirty_datalayers=Array();this.updateDatalayersControl();this.initTileLayers();this.isDirty=false;},checkDirty:function(){if(this.isDirty){L.DomUtil.addClass(this._container,'storage-is-dirty');}else{L.DomUtil.removeClass(this._container,'storage-is-dirty');}},addDirtyDatalayer:function(datalayer){if(this.dirty_datalayers.indexOf(datalayer)===-1){this.dirty_datalayers.push(datalayer);this.isDirty=true;}},removeDirtyDatalayer:function(datalayer){if(this.dirty_datalayers.indexOf(datalayer)!==-1){this.dirty_datalayers.splice(this.dirty_datalayers.indexOf(datalayer),1);this.checkDirty();}},continueSaving:function(){if(this.dirty_datalayers.length){this.dirty_datalayers[0].save();}else{if(this._post_save_alert){L.S.fire('ui:alert',this._post_save_alert);delete this._post_save_alert;}}},save:function(){if(!this.isDirty){return;}
var editableOptions=['zoom','datalayersControl','scrollWheelZoom','zoomControl','scaleControl','moreControl','miniMap','displayPopupFooter','onLoadPanel','tilelayersControl','name','description','licence','tilelayer','limitBounds','color','iconClass','iconUrl','smoothFactor','opacity','weight','fill','fillColor','fillOpacity','dashArray','popupTemplate','popupContentTemplate','zoomTo','captionBar','slideshow','sortKey','filterKey','showLabel','shortCredit','longCredit'],properties={};for(var i=editableOptions.length-1;i>=0;i--){if(typeof this.options[editableOptions[i]]!=='undefined'){properties[editableOptions[i]]=this.options[editableOptions[i]];}}
var geojson={type:'Feature',geometry:this.geometry(),properties:properties};this.backupOptions();var formData=new FormData();formData.append('name',this.options.name);formData.append('center',JSON.stringify(this.geometry()));formData.append('settings',JSON.stringify(geojson));this.post(this.getSaveUrl(),{data:formData,callback:function(data){var duration=3000;if(!this.options.storage_id){duration=100000;this.options.storage_id=data.id;if(history&&history.pushState){history.pushState({},this.options.name,data.url);}else{window.location=data.url;}}
if(data.info){msg=data.info;}else{msg=L._('Map has been saved!');}
this._post_save_alert={content:msg,level:'info',duration:duration};L.S.fire('ui:end');this.isDirty=false;this.continueSaving();},context:this});},getEditUrl:function(){return L.Util.template(this.options.urls.map_update,{'map_id':this.options.storage_id});},getCreateUrl:function(){return L.Util.template(this.options.urls.map_create);},getSaveUrl:function(){return(this.options.storage_id&&this.getEditUrl())||this.getCreateUrl();},geometry:function(){var latlng=this.latLng(this.options.center||this.getCenter());return{type:'Point',coordinates:[latlng.lng,latlng.lat]};},defaultDataLayer:function(){var datalayer;for(var i in this.datalayers){if(this.datalayers.hasOwnProperty(i)){datalayer=this.datalayers[i];if(datalayer.isVisible()&&!datalayer.isRemoteLayer()){return datalayer;}}}
if(datalayer&&!datalayer.isRemoteLayer()){this.addLayer(datalayer.layer);return datalayer;}
return this.createDataLayer();},getDataLayerByStorageId:function(storage_id){var datalayer;for(var i in this.datalayers){if(this.datalayers.hasOwnProperty(i)){datalayer=this.datalayers[i];if(datalayer.storage_id==storage_id){return datalayer;}}}},edit:function(){if(!this.editEnabled)return;var container=L.DomUtil.create('div'),metadataFields=['options.name','options.description'],title=L.DomUtil.create('h4','',container);title.innerHTML=L._('Edit map properties');var builder=new L.S.FormBuilder(this,metadataFields);form=builder.build();container.appendChild(form);var UIFields=['options.moreControl','options.datalayersControl','options.zoomControl','options.scrollWheelZoom','options.miniMap','options.scaleControl','options.onLoadPanel','options.displayPopupFooter','options.captionBar'];builder=new L.S.FormBuilder(this,UIFields,{callback:this.initControls,callbackContext:this});var controlsOptions=L.DomUtil.createFieldset(container,L._('User interface options'));controlsOptions.appendChild(builder.build());var optionsFields=['options.color','options.iconClass','options.iconUrl','options.smoothFactor','options.opacity','options.weight','options.fill','options.fillColor','options.fillOpacity','options.dashArray','options.popupTemplate','options.popupContentTemplate','options.zoomTo','options.showLabel',['options.sortKey',{handler:'BlurInput',helpText:L._('Property to use for sorting features'),placeholder:L._('Default: name')}],['options.filterKey',{handler:'Input',helpText:L._('Comma separated list of properties to use when filtering features'),placeholder:L._('Default: name')}]];builder=new L.S.FormBuilder(this,optionsFields,{callback:function(field){if(field!=='options.popupTemplate'&&field!=='options.popupContentTemplate'){this.eachDataLayer(function(datalayer){if(field==='options.sortKey')datalayer.reindex();datalayer.redraw();});}}});var defaultProperties=L.DomUtil.createFieldset(container,L._('Default properties'));defaultProperties.appendChild(builder.build());if(!L.Util.isObject(this.options.tilelayer)){this.options.tilelayer={};}
var tilelayerFields=[['options.tilelayer.name',{handler:'BlurInput',placeholder:L._('display name')}],['options.tilelayer.url_template',{handler:'BlurInput',helpText:L._('Supported scheme')+': http://{s}.domain.com/{z}/{x}/{y}.png',placeholder:'url'}],['options.tilelayer.maxZoom',{handler:'BlurIntInput',placeholder:L._('max zoom')}],['options.tilelayer.minZoom',{handler:'BlurIntInput',placeholder:L._('min zoom')}],['options.tilelayer.attribution',{handler:'BlurInput',placeholder:L._('attribution')}],['options.tilelayer.tms',{handler:'CheckBox',helpText:L._('TMS format')}]];var customTilelayer=L.DomUtil.createFieldset(container,L._('Custom background'));builder=new L.S.FormBuilder(this,tilelayerFields,{callback:this.initTileLayers,callbackContext:this});customTilelayer.appendChild(builder.build());if(!L.Util.isObject(this.options.limitBounds)){this.options.limitBounds={};}
var limitBounds=L.DomUtil.createFieldset(container,L._('Limit bounds'));var boundsFields=[['options.limitBounds.south',{handler:'BlurFloatInput',placeholder:L._('max South')}],['options.limitBounds.west',{handler:'BlurFloatInput',placeholder:L._('max West')}],['options.limitBounds.north',{handler:'BlurFloatInput',placeholder:L._('max North')}],['options.limitBounds.east',{handler:'BlurFloatInput',placeholder:L._('max East')}],];var boundsBuilder=new L.S.FormBuilder(this,boundsFields,{callback:this.handleLimitBounds,callbackContext:this});limitBounds.appendChild(boundsBuilder.build());var boundsButtons=L.DomUtil.create('div','button-bar',limitBounds);var setCurrentButton=L.DomUtil.add('a','button half',boundsButtons,L._('Use current bounds'));setCurrentButton.href='#';L.DomEvent.on(setCurrentButton,'click',function(){var bounds=this.getBounds();this.options.limitBounds.south=L.Util.formatNum(bounds.getSouth());this.options.limitBounds.west=L.Util.formatNum(bounds.getWest());this.options.limitBounds.north=L.Util.formatNum(bounds.getNorth());this.options.limitBounds.east=L.Util.formatNum(bounds.getEast());boundsBuilder.fetchAll();this.isDirty=true;this.handleLimitBounds();},this);var emptyBounds=L.DomUtil.add('a','button half',boundsButtons,L._('Empty'));emptyBounds.href='#';L.DomEvent.on(emptyBounds,'click',function(){this.options.limitBounds.south=null;this.options.limitBounds.west=null;this.options.limitBounds.north=null;this.options.limitBounds.east=null;boundsBuilder.fetchAll();this.isDirty=true;this.handleLimitBounds();},this);var slideshow=L.DomUtil.createFieldset(container,L._('Slideshow'));var slideshowFields=[['options.slideshow.delay',{handler:'IntInput',placeholder:L._('Set a value for adding a slideshow'),helpText:L._('Delay between elements (in milliseconds)')}],['options.slideshow.autoplay',{handler:'CheckBox',helpText:L._('Autostart slideshow when map is loaded?')}]];var slideshowHandler=function(){this.slideshow.setOptions(this.options.slideshow);this.initControls();};var slideshowBuilder=new L.S.FormBuilder(this,slideshowFields,{callback:slideshowHandler,callbackContext:this});slideshow.appendChild(slideshowBuilder.build());var credits=L.DomUtil.createFieldset(container,L._('Credits'));var creditsFields=[['options.licence',{handler:'LicenceChooser',label:L._('licence')}],['options.shortCredit',{handler:'Input',label:L._('Short credits'),helpText:L._('Will be displayed in the bottom right corner of the map'),helpEntries:'textFormatting'}],['options.longCredit',{handler:'Textarea',label:L._('Long credits'),helpText:L._('Will be visible in the caption of the map'),helpEntries:'textFormatting'}]];var creditsBuilder=new L.S.FormBuilder(this,creditsFields,{callback:function(){this._controls.attribution._update();},callbackContext:this});credits.appendChild(creditsBuilder.build());var advancedActions=L.DomUtil.createFieldset(container,L._('Advanced actions'));var del=L.DomUtil.create('a','storage-delete',advancedActions);del.href='#';del.innerHTML=L._('Delete');L.DomEvent.on(del,'click',L.DomEvent.stop).on(del,'click',this.del,this);var clone=L.DomUtil.create('a','storage-clone',advancedActions);clone.href='#';clone.innerHTML=L._('Clone this map');L.DomEvent.on(clone,'click',L.DomEvent.stop).on(clone,'click',this.clone,this);L.S.fire('ui:start',{data:{html:container}});},enableEdit:function(){L.DomUtil.addClass(document.body,'storage-edit-enabled');this.editEnabled=true;this.fire('edit:enabled');},disableEdit:function(){if(this.isDirty)return;L.DomUtil.removeClass(document.body,'storage-edit-enabled');this.editedFeature=null;this.editEnabled=false;this.fire('edit:disabled');},getDisplayName:function(){return this.options.name||L._('Untitled map');},initCaptionBar:function(){var container=L.DomUtil.create('div','storage-caption-bar',this._controlContainer),name=L.DomUtil.create('h3','',container);if(this.options.author&&this.options.author.name&&this.options.author.link){var authorContainer=L.DomUtil.add('span','storage-map-author',container,' '+L._('by')+' '),author=L.DomUtil.create('a');author.href=this.options.author.link;author.innerHTML=this.options.author.name;authorContainer.appendChild(author);}
var about=L.DomUtil.add('a','storage-about-link',container,' — '+L._('About'));about.href='#';L.DomEvent.on(about,'click',this.displayCaption,this);var browser=L.DomUtil.add('a','storage-open-browser-link',container,' | '+L._('Browse data'));browser.href='#';L.DomEvent.on(browser,'click',L.DomEvent.stop).on(browser,'click',this.openBrowser,this);var setName=function(){name.innerHTML=this.getDisplayName();};L.bind(setName,this)();this.on('synced',L.bind(setName,this));this.onceDatalayersLoaded(function(){this.slideshow.renderToolbox(container);});},initEditBar:function(){var container=L.DomUtil.create('div','storage-main-edit-toolbox',this._controlContainer),title=L.DomUtil.add('h3','',container,L._('Editing')+'&nbsp;'),name=L.DomUtil.create('a','storage-click-to-edit',title),setName=function(){name.innerHTML=this.getDisplayName();};L.bind(setName,this)();L.DomEvent.on(name,'click',this.edit,this);this.on('synced',L.bind(setName,this));this.help.button(title,'edit');var save=L.DomUtil.create('a','leaflet-control-edit-save button',container);save.href='#';save.title=L._('Save current edits')+' (Ctrl-S)';save.innerHTML=L._('Save');var cancel=L.DomUtil.create('a','leaflet-control-edit-cancel button',container);cancel.href='#';cancel.title=L._('Cancel edits');cancel.innerHTML=L._('Cancel');var disable=L.DomUtil.create('a','leaflet-control-edit-disable',container);disable.href='#';disable.title=disable.innerHTML=L._('Disable editing');L.DomEvent.addListener(disable,'click',L.DomEvent.stop).addListener(disable,'click',function(e){this.disableEdit(e);L.S.fire('ui:end');},this);L.DomEvent.addListener(save,'click',L.DomEvent.stop).addListener(save,'click',this.save,this);L.DomEvent.addListener(cancel,'click',L.DomEvent.stop).addListener(cancel,'click',this.askForReset,this);},askForReset:function(e){if(!confirm(L._('Are you sure you want to cancel your changes?')))return;this.reset();this.disableEdit(e);L.S.fire('ui:end');},getEditActions:function(){var actions=[{title:L._('Import data')+' (Ctrl+I)',className:'upload-data',callback:this.importPanel,context:this},{title:L._('Edit map settings'),className:'update-map-settings',callback:this.edit,context:this},{title:L._('Change tilelayers'),className:'update-map-tilelayers',callback:this.updateTileLayers,context:this},{title:L._('Save this center and zoom'),className:'update-map-extent',callback:this.updateExtent,context:this}];if(this.options.urls.map_update_permissions){actions=actions.concat([{title:L._('Update permissions and editors'),className:'update-map-permissions',callback:this.updatePermissions,context:this}]);}
return actions;},startMarker:function(){return this.editTools.startMarker();},startPolyline:function(){return this.editTools.startPolyline();},startPolygon:function(){return this.editTools.startPolygon();},getDrawActions:function(){var actions=[];if(this.options.enableMarkerDraw){actions.push({title:L._('Draw a marker'),className:'storage-draw-marker',callback:this.startMarker,context:this});}
if(this.options.enablePolylineDraw){actions.push({title:L._('Draw a polyline'),className:'storage-draw-polyline',callback:this.startPolyline,context:this});}
if(this.options.enablePolygonDraw){actions.push({title:L._('Draw a polygon'),className:'storage-draw-polygon',callback:this.startPolygon,context:this});}
return actions;},del:function(){if(confirm(L._('Are you sure you want to delete this map?'))){var url=L.Util.template(this.options.urls.map_delete,{'map_id':this.options.storage_id});this.post(url);}},clone:function(){if(confirm(L._('Are you sure you want to clone this map and all its datalayers?'))){var url=L.Util.template(this.options.urls.map_clone,{'map_id':this.options.storage_id});this.post(url);}},initLoader:function(){this.loader=new L.Control.Loading();this.loader.onAdd(this);},post:function(url,options){options=options||{};options.listener=this;L.S.Xhr.post(url,options);},get:function(url,options){options=options||{};options.listener=this;L.S.Xhr.get(url,options);},ajax:function(options){options.listener=this;L.S.Xhr._ajax(options);},initContextMenu:function(){this.contextmenu=new L.S.ContextMenu(this);this.contextmenu.enable();},setContextMenuItems:function(e){var items=[];if(this._zoom!==this.getMaxZoom()){items.push({text:L._('Zoom in'),callback:function(){this.zoomIn();}});}
if(this._zoom!==this.getMinZoom()){items.push({text:L._('Zoom out'),callback:function(){this.zoomOut();}});}
if(e&&e.relatedTarget){if(e.relatedTarget.getContextMenuItems){items=items.concat(e.relatedTarget.getContextMenuItems(e));}}
if(this.options.allowEdit){items.push('-');if(this.editEnabled){if(!this.isDirty){items.push({text:L._('Stop editing')+' (Ctrl+E)',callback:this.disableEdit});}
if(this.options.enableMarkerDraw){items.push({text:L._('Draw a marker')+' (Ctrl-M)',callback:this.startMarker,context:this});}
if(this.options.enablePolylineDraw){items.push({text:L._('Draw a polygon')+' (Ctrl-P)',callback:this.startPolygon,context:this});}
if(this.options.enablePolygonDraw){items.push({text:L._('Draw a line')+' (Ctrl-L)',callback:this.startPolyline,context:this});}
items.push('-');items.push({text:L._('Help'),callback:function(){this.help.show('edit');}});}else{items.push({text:L._('Start editing')+' (Ctrl+E)',callback:this.enableEdit});}}
items.push('-',{text:L._('Browse data'),callback:this.openBrowser},{text:L._('About'),callback:this.displayCaption});if(this.options.urls.routing){items.push('-',{text:L._('Directions from here'),callback:this.openExternalRouting});}
this.options.contextmenuItems=items;},openExternalRouting:function(e){var url=this.options.urls.routing;if(url){var params={lat:e.latlng.lat,lng:e.latlng.lng,locale:L.locale};window.open(L.Util.template(url,params));}
return;},getMap:function(){return this;},localizeUrl:function(url){var replace={bbox:this.getBounds().toBBoxString(),north:this.getBounds().getNorthEast().lat,east:this.getBounds().getNorthEast().lng,south:this.getBounds().getSouthWest().lat,west:this.getBounds().getSouthWest().lng,lat:this.getCenter().lat,lng:this.getCenter().lng,zoom:this.getZoom()};replace.left=replace.west;replace.bottom=replace.south;replace.right=replace.east;replace.top=replace.north;return L.Util.template(url,replace);},proxyUrl:function(url){if(this.options.urls.ajax_proxy){url=L.Util.template(this.options.urls.ajax_proxy,{url:encodeURIComponent(url)});}
return url;}});L.Storage.on('ui:start',function(e){var container=L.DomUtil.get('storage-ui-container');container.className='';container.innerHTML='';var actionsContainer=L.DomUtil.create('ul','toolbox',container);var body=L.DomUtil.create('div','body',container);if(e.data.html.nodeType&&e.data.html.nodeType===1){body.appendChild(e.data.html);}
else{body.innerHTML=e.data.html;}
L.DomUtil.addClass(document.body,'storage-ui');var closeLink=L.DomUtil.create('li','storage-close-link',actionsContainer);L.DomUtil.add('i','storage-close-icon',closeLink);var label=L.DomUtil.create('span','',closeLink);label.title=label.innerHTML=L._('Close');if(e.actions){for(var i=0;i<e.actions.length;i++){actionsContainer.appendChild(e.actions[i]);}}
if(e.cssClass){L.DomUtil.addClass(container,e.cssClass);}
L.Storage.fire('ui:ready');var close=function(){L.Storage.fire('ui:end');};L.DomEvent.on(closeLink,'click',close);});L.Storage.on('ui:end',function(){var div=L.DomUtil.get('storage-ui-container');div.innerHTML='';L.DomUtil.removeClass(document.body,'storage-ui');L.Storage.fire('ui:closed');});var UI_ALERTS=Array();var UI_ALERT_ID=null;L.Storage.on('ui:alert',function(e){var pop=function(e){if(!e){if(UI_ALERTS.length){e=UI_ALERTS.pop();}else{return;}}
var div=L.DomUtil.get('storage-alert-container'),timeoutID,level_class=e.level&&e.level=='info'?'info':'error';div.innerHTML='';div.innerHTML=e.content;L.DomUtil.addClass(document.body,'storage-alert');L.DomUtil.addClass(div,level_class);var close=function(){if(timeoutID!==UI_ALERT_ID){return;}
div.innerHTML='';L.DomUtil.removeClass(document.body,'storage-alert');L.DomUtil.removeClass(div,level_class);if(timeoutID){window.clearTimeout(timeoutID);}
pop();};if(e.actions){var action,el;for(var i=0;i<e.actions.length;i++){action=e.actions[i];el=L.DomUtil.element('a',{'className':'storage-action'},div);el.href='#';el.innerHTML=action.label;L.DomEvent.on(el,'click',L.DomEvent.stop).on(el,'click',close);if(action.callback){L.DomEvent.on(el,'click',action.callback,action.callbackContext|| this);}}}
var closeLink=L.DomUtil.create('a','storage-close-link',div);closeLink.href='#';L.DomUtil.add('i','storage-close-icon',closeLink);var label=L.DomUtil.create('span','',closeLink);label.title=label.innerHTML=L._('Close');L.DomEvent.on(closeLink,'click',L.DomEvent.stop).on(closeLink,'click',close);UI_ALERT_ID=timeoutID=window.setTimeout(close,e.duration|| 3000);};if(L.DomUtil.hasClass(document.body,'storage-alert')){UI_ALERTS.push(e);}else{pop(e);}});L.Storage.on('ui:tooltip:init',function(e){var tooltip=L.DomUtil.get('storage-tooltip-container'),map=e.map,ID;var close=function(id){if(id&&id!==ID)return;tooltip.innerHTML='';L.DomUtil.removeClass(document.body,'storage-tooltip');};var setFixedPosition=function(){var left=map._container.offsetLeft+(map._container.clientWidth/2)-(tooltip.clientWidth/2),top=map._container.offsetTop+5,point=L.point(left,top);L.DomUtil.setPosition(tooltip,point);};L.Storage.on('ui:tooltip',function(e){ID=Math.random();var id=ID;L.DomUtil.addClass(document.body,'storage-tooltip');setFixedPosition();tooltip.innerHTML=e.content;function closeIt(){close(id);}
if(e.attachTo){L.DomEvent.on(e.attachTo,'mouseout',closeIt);}
if(e.duration!==Infinity){window.setTimeout(closeIt,e.duration|| 3000);}});L.Storage.on('ui:tooltip:abort',function(){close();});});