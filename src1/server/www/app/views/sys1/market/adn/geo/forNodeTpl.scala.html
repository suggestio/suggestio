@(args: msys.ISysGeoForNodeTplArgs)(implicit ctx: Context)

@* Вывод гео-информации по узлу. *@

@import ctx._
@import datetime._
@import stuff._
@import mgeo.MGsPtr

@* Отрендерить список нод на основе списка id нод. Используется карта parentsMap для доступа к инфе по узлу. *@
@_renderNodes(nodesIds: TraversableOnce[String]) = {
  @for(parentId <- nodesIds) {
    <a href="@routes.SysMarket.showAdnNode(parentId)">
      @args.parentsMap.get(parentId).fold {
        @parentId
      } { parentNode =>
        <span title="@parentNode.meta.address.town / @parentId">
          @parentNode.meta.basic.name
        </span>
      }
    </a>,
  }
}

@* Рендер одного списка узлов-геородителей. *@
@_renderGeoParents(p: MPredicate, title: String, label: String) = {
  @defining( args.mnode.edges.withPredicateIterIds(p) ) { parentIdsIter =>
    @if( parentIdsIter.nonEmpty ) {
      <p>
        <span title="@title">
          @label
        </span>
        @_renderNodes( parentIdsIter )
      </p>
    }
  }
}


@* Рендер самой страницы. *@
@geoBase(
  title   = "География узла",
  nodeOpt = Some(args.mnode)
) {
@defining( args.mnode.id.get ) { nodeId =>
  <h2>
    <a href="@routes.Umap.getAdnNodeMap(nodeId)@args.mapStateHash">
      Картографический редактор...
    </a>
    (@args.countGeoJsonCompat отображаемых фигур)
  </h2>
  <br/>

  <h1>
    География узла
    <a href="@routes.SysMarket.showAdnNode(nodeId)">
      @args.mnode.meta.basic.name
    </a>
  </h1>

  <p>Географическая информация узла -- это геометрические фигуры в координатах поверхности земли. Они тяжеловесные, и
     хранятся отдельно от родительского узла, в той же шарде узла, но в отдельной модели.</p>
  @if( args.shapes.nonEmpty ) {
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>URL</th>
          <th>Level</th>
          <th>Shape</th>
          <th>Last-Modified</th>
          <th>Другое</th>
        </tr>
      </thead>
      <tbody>
        @for(geo <- args.shapes) {
          @defining( MGsPtr(nodeId, geo.id) ) { mGsPtr =>
          <tr>
            <td><span title="@geo.id">@geo.id</span></td>
            <td>
              @for(url <- geo.fromUrl) {
                <a href="@url" target="_blank">Go</a>
              }
            </td>
            <td>@geo.glevel.precision</td>
            <td>
              <a href="@routes.SysAdnGeo.showGeoJson( mGsPtr )">
                <span title='@geo.shape'>
                  @geo.shape.displayTypeName
                </span>
              </a>
            </td>
            <td>
              @for(dt <- geo.dateEdited) {
                @_prettyDate(dt)
              }
            </td>
            <td>
              @if(!geo.shape.shapeType.isGeoJsonCompatible) {
                <span title="Круги и прямоугольники не совместимы со стандартном GeoJSON, поэтому не отображаются в картографическом редакторе фигур.">
                  НЕ отображается на карте.
                </span>
              }
              <a href="@if(geo.shape.shapeType.isCircle) {@routes.SysAdnGeo.editCircle(mGsPtr)} else {@routes.SysAdnGeo.editNodeOsm(mGsPtr)}">
                @messages("Edit")
              </a>
            </td>
          </tr>
          }
        }
      </tbody>
    </table>
  }

  <p>
    <a href="@routes.SysAdnGeo.createForNodeOsm(nodeId)">
      Добавить OSM-контур к этому узлу...
    </a>
  </p>

  <p>
    <a href="@routes.SysAdnGeo.createCircle(nodeId)">
      Добавить круг...
    </a>
  </p>

  <p>
    <a href="http://geojsonlint.com/">
      Визуальная проверка GeoJSON.
    </a>
  </p>


  <br/><br/>
  <h1>Геоданные узла</h1>
  <p>Геоданные узла хранятся и индексируются в самом узле.</p>

  @if( args.mnode.geo.isEmpty ) {
    Отсутствуют.
    <a href="@routes.SysAdnGeo.editAdnNodeGeodataPropose(nodeId)">
      Попробовать автозаполнение геоданных...
    </a>

  } else {

    @for(point <- args.mnode.geo.point) {
      @* TODO Почему-то маркер точки не подсвечивается на карте, поэтому используем большое увеличение (18) и отметку по центру. *@
      <span title="Примитивная координата, до которой можно измерить расстояние или использовать при сортировки по расстоянию. Например географический центр узла.">
        Координата:
      </span>
      <a href="http://www.openstreetmap.org/#map=18/@point.lat/@point.lon"
         target="_blank"
         title="Открыть карту в новой вкладке. Цель будет в центре.">
        <span title="(lat, lon), т.е. (широта, долгота) в WGS84.">
          (@point.lat, @point.lon)
        </span>
      </a>
      <br/>
    }

    @_renderGeoParents(
      p = MPredicates.GeoParent.Direct,
      title = "Прямые родители узла в географическом плане.",
      label = "Геородительские узлы:"
    )

    @_renderGeoParents(
      p = MPredicates.GeoParent,
      title = "Все географически родительские узлы. Т.е. прямые родители и все их геородители.",
      label = "Все геородительские узлы:"
    )

  }

  <a href="@routes.SysAdnGeo.editAdnNodeGeodata(nodeId)">
    @messages("Edit")...
  </a>

} @* defining nodeId *@
} @* geoBase *@
