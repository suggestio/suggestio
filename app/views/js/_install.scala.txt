@(dkey:String,qi_id:String,wsTimestamp:Option[Long] = None)

_qi_complete = () ->
  
  sio._qi_completed = true
  
  host = '@dkey'
  qi_id = '@qi_id'
  timestamp = '@wsTimestamp'
  sio.dkey_host = host
  
  iframe_params = 
    id : 'sio-install-post-iframe'
    name:'sio-install-post-iframe'
  
  _sio_iframe = utils.ce 'iframe', iframe_params, ''
  _sio_iframe.style.display = 'none'
  
  utils.ge_tag('body')[0].appendChild _sio_iframe
  
  form_params = 
    id : 'sio-install-post-form'
    action : sio.config.sio_host + 'js/install_url/' + host + '/' + qi_id
    method : 'post'
    target : 'sio-install-post-iframe'
  
  _sio_install_form = utils.ce 'form', form_params, '<input type="text" name="url" value="' + window.location + '"><input type="submit" value="post">'
  _sio_install_form.style.display = 'none'
  utils.ge_tag('body')[0].appendChild _sio_install_form
  
  _sio_install_form.submit()
  
  cb = () ->
    _listen_qi_events host, qi_id, timestamp
    
  setTimeout cb, 500
  
_listen_qi_events = ( host, qi_id, timestamp ) ->
  
  socket_url = sio.config.sio_host.replace('http','ws') + 'js/install_ws/' + host + '/' + qi_id + '/' + timestamp
  
  socket = new WebSocket socket_url
  
  socket.onopen = () ->
    console.log "ws connection established"
  
  socket.onclose = (event) ->
    if event.wasClean
      console.log "ws connection closed"
    else
      console.log "ws connection dropped"
  
  socket.onmessage = (event) ->
    console.log "ws data received : " + event.data
  
  socket.onerror = (error) ->
    console.log "ws error : " + error.message
  
_qi_complete()