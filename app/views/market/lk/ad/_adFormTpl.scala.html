@(af: Form[_], call: Call, btnText: String, mmcats: CollectMMCatsAcc_t, offerType: AdOfferType, adnNode: MAdnNode)(implicit ctx: util.Context)

@* Рендер формы редактирования произвольной рекламы.
 * offerType - предпочитаемый тип оффера, когда он неизвестен.
*@
@import ctx._
@import helper._
@import AdOfferTypes._
@import util.blocks._

@helper.javascriptRouter("jsRoutes")(
  routes.javascript.MarketCategory.topCatsOf,
  routes.javascript.MarketCategory.directSubcatsOf
)

@* Определяем текущий тип оффера (тип формы). Используем данные формы и аргумент offerType как fallback. *@
@defining(af("ad.offer.mode").value.flatMap(AdOfferTypes.maybeWithName).getOrElse(offerType)) { offerType1 =>
@form(call, 'id -> "promoOfferForm") {

  @* Бывает, что у формы задана ошибка верхнего уровня. Такое происходит например если ad.mode не верен. *@
  @*af.globalError*@

  <input type="hidden" id="preview-action" value="@routes.MarketAdPreview.adFormPreviewSubmit(adnNode.id.get)" />


  <div class="lk-edit-form__block">
    <div class="lk-edit-form__block-title">
      Выбор категории
    </div>

    <div class="lk-edit-form__block-body">
      @_adFormCatSelectorsTpl(mmcats, af)
    </div>

  </div>

  @* TODO: этот блок нужно выпилить, т.к. рекламные шапки больше не привязаны к рекламным карточкам
  <div class="block">
    <div class="border-line"></div>
    <div class="hat">
      <span class="title">Брендированая шапка</span>
      <a class="toggle open" href="#" data-content="brand-hat">Свернуть</a>
    </div>
    <div class="border-line"></div>
    <div class="slide-content" id="brand-hat">
      <div class="subhat">
        <span class="title">Редактирование логотипа</span>
        <a class="toggle" href="#" data-content="brand-hat-logo">Развернуть</a>
      </div>
      <div class="border-line"></div>

      <div class="slide-content" id="brand-hat-logo" style="display: none;">
        <table cellpadding="0" cellspacing="0" class="input-wrap big img-with-preview">
          <tr>
            <td class="left">
              <label @if(af("logoImgId").hasErrors) {style="color: #E23131;"}>Логотип:</label>
            </td>
            <td class="right">

              <div class="select-file-wrap" id="logoImgInput">
                @defining(af("logoImgId").value) { logoImgIdOpt =>
                  <div class="preview">
                    <img class="image-preview" src="@logoImgIdOpt.filter(!_.isEmpty).map { imgId =>@routes.Img.getImg(imgId) }.getOrElse {/assets/images/market/lk/empty-image.gif}" width="59" />
                  </div>
                  <div class="selectbox">
                    <div class="select-file">
                      @stuff._fileUploadTpl(routes.MarketAd.handleAdTempLogo, relatedFieldId="logoImgInput")
                      <input class="image-key" type="hidden" name="logoImgId" value="@logoImgIdOpt"/>
                      <div class="bg">Выбрать файл для загрузки</div>
                    </div>
                    <div class="descr">
                      Файл должен быть на прозрачном
                      фоне и иметь формат .png
                    </div>
                  </div>
		        }
              </div>
              <a href="#" class="close">&nbsp;</a>
            </td>
          </tr>
          @if(af("logoImgId").hasErrors) {
            <tr>
              <td class="left">&nbsp;</td>
              <td class="err-msg">
                Поле заполнено некорректно!
              </td>
            </tr>
          }
        </table>
        <div class="border-line"></div>
      </div>

      @_adFormPanelColorTpl(af)
    </div>
  </div>
  *@

  <div class="block">
    <div class="border-line"></div>
    <div class="hat">
      <span class="title">Рекламная фотография</span>
      <a class="toggle open" href="#" data-content="ad-photo">Свернуть</a>
    </div>
    <div class="border-line"></div>
    <div class="slide-content" id="ad-photo">
      <table cellpadding="0" cellspacing="0" class="input-wrap big img-with-preview ">
        <tr>
          <td class="left">
            <label>Фотография товара:</label>
          </td>
          <td class="right">
            <div class="select-file-wrap">
              <div class="preview" id="adImagePreview">
                @* Данные по картинке загруженной. *@
                @defining(af("image_key").value) { imgIdOpt =>
                  <input class="image-key" type="hidden" name="image_key" value="@imgIdOpt"/>
                  <img class="image-preview" width="59" src="@imgIdOpt.filter(!_.isEmpty).map { imgId =>@routes.Img.getImg(imgId) }.getOrElse {/assets/images/market/lk/empty-image.gif}" />
                }
              </div>
              <div class="selectbox">
                <div class="select-file">
                  @stuff._fileUploadTpl(routes.Img.handleTempImg, relatedFieldId="adImagePreview")
                  <div class="bg">Выбрать файл для загрузки</div>
                </div>
                <div class="descr">
                  Файл должен быть на прозрачном
                  фоне и иметь формат .png
                </div>
              </div>
            </div>
            <a href="#" class="close">&nbsp;</a>
          </td>
        </tr>
        @if(!af.errors("image_key").isEmpty) {
        <tr>
          <td class="left">&nbsp;</td>
          <td class="err-msg">
            Поле заполнено некорректно!
          </td>
        </tr>
        }
      </table>
    </div>
  </div>

  @* Тут выводится список блоков в виде иконок. При нажатии — производится запрос для рендера нужного редактора блока *@
  <div class="lk-edit-form__block">
    <div class="lk-edit-form__block-title">
      Выбор шаблона
    </div>
    <div class="lk-edit-form__block-body">
      <div class="lk-edit-form__blocks-list-icons" id="adFormBlocksList">
      @BlocksConf.values.map { bc =>
        <div class="blocks-list-icons__single-icon" data-block-id="@bc.id">
          @bc.id
        </div>
      }
      @* TODO: FIXME *@
      <input class="block-id" type="hidden" name="ad.offer.blockId" value="@af("ad.offer.blockId").value.getOrElse(1)"/>
      <input class="block-editor-action" type="hidden" value="@routes.MarketAdPreview.adBlockSwitchEditor(adnNode.id.get)"/>
      <div class="clear"></div>
      </div>

    </div>
  </div>

  @* Для блока : превьюшка + редактор *@
  <div class="lk-edit-form__block">
    <div class="lk-edit-form__block-title">
      Отображение рекламной карточки
    </div>
    <div class="lk-edit-form__block-body">

      <div class="lk-edit-form__block-editor-preview">

        @* Отображение превьюшки *@
        <div class="block-editor-preview__preview"></div>

        @* Отображение нужного редактора *@
        <div class="block-editor-preview__editor" id="adFormBlockEditor">
        @blocks.editor._blockEditorTpl(af)
        </div>

        <div class="clear"></div>

      </div>

    </div>
  </div>

  @* Режим формы (тип рекламного оффера). Должен переключаться при переключении вкладки. *@
  <input id="ad-mode" type="hidden" name="ad.offer.mode" value="@offerType1.toString"/>

}
}

