@(title: String, adnNode: MAdnNode)(content: Html)(implicit ctx: Context)

@* Страница с внешней версткой для формы _adFormTpl. *@

@market.lk.lkBase(
  title         = title,
  nodeOpt       = Some(adnNode),
  leftCurrEl    = Some(LkLeftPanelLinks.LPL_ADS)
) {

  <div class="page-title __without-border">
    <div class="page-title_cnt">
      <a class="back-btn" href="@routes.MarketLkAdn.showNodeAds(adnNode.id.get)" title="Вернуться назад"></a>
      @title.toUpperCase
    </div>
  </div>

  @content

  <script src="@routes.Assets.versioned("javascripts/lib/tinymce/js/tinymce/tinymce.min.js")"></script>

   @* Сразу открываем веб-сокет в фоне. Он нужен для получения асинхронных данных по редактированию.
      TODO Отображать полученную палитру цветов юзеру.
      TODO Выставлять цвет подложки картинки (пока -- поле ad.bgColor в _adFormTpl).
   *@
  <script>
    var ws = new WebSocket("@ctx.wsUrlPrefix@routes.MarketAd.ws(ctx.ctxIdStr)");

    ws.onmessage = function (evt) {
      var received_msg = evt.data;
      $(".js-color-block").remove();
      received_msg = $.parseJSON(received_msg);
      var colors = received_msg["data"];

      $("#adBgColor").val(colors[0]);

      $dom = $("#adFormDescriptionTable td:last");
      for(index in colors) {
        color = colors[index];
        html = "<div class='color-block js-color-block' data-color='"+color+"' style='background-color: #"+color+";'></div>"
        $dom.append(html);
      }
    };

    tinymce.init({
      selector: 'textarea.js-tinymce',
      width: 615,
      height: 300,
      menubar: false,
      statusbar: false,
      plugins: 'link, textcolor, paste, colorpicker',
      toolbar: ["styleselect | fontsizeselect | alignleft aligncenter alignright | bold italic | colorpicker | link | removeformat"],
      content_css: '@routes.Assets.versioned("stylesheets/market/descr.css")',
      fontsize_formats: '@blk.FontSizes.values.iterator.map {fs =>@{fs.size}px@if(!fs.isLast){ }}',
      style_formats: @Html(blk.Fonts.valuesJsonTinyMce.toString),
      language: 'RU_ru',
      font_size_style_values: '1px,2px',
      setup: function(editor) {
        return editor.on('init', function(e) {
          return market.ad_form.set_descr_editor_bg();
        });
      }
    });
  </script>
}
