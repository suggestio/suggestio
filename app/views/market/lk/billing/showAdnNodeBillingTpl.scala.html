@(adnNode: MAdnNode, mmpDailyTariffs: Seq[MBillMmpDaily], mbc: MBillContract, otherRcvrs: Seq[MAdnNode])(implicit ctx: util.Context)

@* Страница с информацией по биллингу для узла рекламной сети. *@
@import ctx._
@import util.TplDataFormatUtil._
@import datetime._

@market.lk.lkBase("Биллинг | " + adnNode.meta.name, adnIdOpt = adnNode.id) {

  <div class="title-wrap">
    <div class="center">
      <a class="back-but" href="@routes.MarketLkAdn.showAdnNode(adnNode.id.get)">&nbsp;</a>
      <div class="title-inner">НАСТРОЙКИ</div>
    </div>
  </div>

  <div class="body billing-page">

    <div class="lk-edit-form__block js-slide-wrap" style="margin-bottom: 0;">

      <div class="lk-edit-form__block_title">
        <div class="border-line"></div>
        <span class="lk-edit-form__block_title_span">
        Биллинг
        </span>
        <a class="js-g-slide-toggle open l-right">Свернуть</a>
        <div class="border-line"></div>
      </div>

      <div class="lk-edit-form__block_body js-slide-content">
        <div class="lk-edit-form__block_body_inner">

          @* Верхняя информация: баланс, тарификация *@
          <table class="siom-table __size-XL">

            @ctx.billBalanceOpt.map { mbb =>
            <tr>
              <td>
                <div class="table-cell-cnt __size-M" style="padding-left: 0;">
                  <span class="prop-title">Доступные средства:</span>
                </div>

                <div class="table-cell-cnt __size-M">
                  <span class="value big">@formatPrice(mbb.amount, mbb.currency)</span>
                </div>

                <br/>

                <div class="table-cell-cnt __size-M" style="padding-left: 0;">
                  <span class="prop-title">Всего денег:</span>
                </div>

                <div class="table-cell-cnt __size-M">
                  <span class="value big">@formatPrice(mbb.amount + mbb.blocked, mbb.currency)</span>
                </div>

                <br/>

                <div class="table-cell-cnt __size-M" style="padding-left: 0;">
                  <span class="prop-title">Заблокиро-<br/>вано:</span>
                </div>

                <div class="table-cell-cnt __size-M">
                  <span class="value big">@formatPrice(mbb.blocked, mbb.currency)</span>
                </div>
              </td>

              <td>
                <div class="border-line __vertical js-vertical-line f-left"></div>
                <div class="table-cell-cnt __size-M">
                  <span class="prop-title">Списание средств:</span>
                </div>
              </td>
              <td>
                <div class="border-line __vertical js-vertical-line f-right"></div>
                <div class="table-cell-cnt __size-M">
                    <span class="value f-left" style="padding-top: 5px;">18.05.2014</span>

                    <span class="gray-but-smallest inline f-left" style="margin-left: 20px;">
                      <a href="transactionsHistory" class="white-border-top js-slide-btn">История операций</a>
                    </span>

                </div>
              </td>

              <td style="vertical-align: top; padding-top: 10px;">
                <div class="table-cell-cnt __size-M" style="padding-top: 0; padding-bottom: 0;">
                  <div class="gray-but-wrap">
                    <div class="white-border-top">
                      <a style="padding: 7px 15px 3px;" href="requisitesContent" class="btn js-slide-btn">РЕКВИЗИТЫ</a>
                    </div>
                  </div>
                </div>
              </td>

            }
          </table>

        </div>
      </div>
    </div><!-- Биллинг end -->

    <div class="lk-edit-form__block js-slide-wrap" id="requisitesContent" style="display: none; margin-bottom: 0;">

      <div class="lk-edit-form__block_title">
        <span class="lk-edit-form__block_title_span">
        Реквизиты платежа:
        </span>
        <a class="js-close-btn f-right"></a>
        <div class="border-line"></div>
      </div>

      <div class="lk-edit-form__block_body js-slide-content">
        <div class="lk-edit-form__block_body_inner">

          @* Реквизиты платежа *@
          @_billPaymentBankTpl(mbc)
          <span class="gray-but-smallest" style="margin-top: 25px;">
            <a class="white-border-top" href="@routes.MarketLkBilling.paymentRequsites(adnNode.id.get)">Распечатать</a>
          </span>

        </div>
      </div>
    </div>


      <div class="lk-edit-form__block js-slide-wrap" id="transactionsHistory" style="display: none; margin-bottom: 0;">

        <div class="lk-edit-form__block_title">
          <span class="lk-edit-form__block_title_span">
          История операций
          </span>
          <a class="js-close-btn f-right"></a>
          <div class="border-line"></div>
        </div>

        <div class="lk-edit-form__block_body js-slide-content">
          <div class="lk-edit-form__block_body_inner">
            @* Тут раньше был список транзакций. *@
              <span class="gray-but-smallest inline f-left" >
                <a href="@routes.MarketLkBilling._txnsList(adnNode.id.get)" class="white-border-top" id="getTransactions" data-init="true">Показать транзакции</a>
              </span>

          </div>
        </div>

        <table class="siom-table __size-XL" id="transactionsList"></table>
      </div>


    @* Посуточная mmp-тарифная сетка этого узла-ресивера. Если не ресивер, то в шаблон придёт пустой список. *@
    @if(!mmpDailyTariffs.isEmpty) {
      <div class="lk-edit-form__block js-slide-wrap" style="margin-top: 10px;">

        <div class="lk-edit-form__block_title">
          <div class="border-line"></div>
          <span class="lk-edit-form__block_title_span">
          Ставка тарифных планов
          </span>
          <a class="js-g-slide-toggle open l-right">Свернуть</a>
          <div class="border-line"></div>
        </div>

        @_dailyMmpTariffPlansTpl(mmpDailyTariffs, adnNode)

      </div>
    }

    @* Если продьюсер, то надо отобразить список узлов-ресиверов, на которые можно разместить рекламную карточку.
       Содержимое узла (тарифная сетка) рендерится асинхронно при нажатии кнопки "развернуть" в списке. *@
    @if(!otherRcvrs.isEmpty) {

      <div class="lk-edit-form__block js-slide-wrap">

        <div class="lk-edit-form__block_title">
          <div class="border-line"></div>
          <span class="lk-edit-form__block_title_span">Ставка тарифных планов рекламного размещения</span>
          <a class="js-g-slide-toggle open l-right">Свернуть</a>
          <div class="border-line"></div>
        </div>

        <div class="lk-edit-form__block_body js-slide-content">
          <div class="lk-edit-form__block_body_inner">
            @* Пока без вкладок, просто сплошным списком. *@
            @otherRcvrs.map { rcvr =>

              @* При развертывании элемента нужно слать запрос по указанной ссылке. При повторном развертывании нужно отображать уже полученную табличку тарифов. *@
              <div class="lk-edit-form__block js-slide-wrap">

                <div class="lk-edit-form__block_title">
                  <div class="border-line"></div>
                  <span class="lk-edit-form__block_title_span">
                   @rcvr.meta.name / @rcvr.meta.town
                  </span>
                  <a class="js-g-slide-toggle l-right" href="@routes.MarketLkBilling._renderNodeMbmds(rcvr.id.get)">Развернуть</a>
                  <div class="border-line"></div>
                </div>

              </div>

            }
          </div>
        </div>
      </div>

    }

  </div>

}
