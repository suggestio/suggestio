@(args: AdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._
@import controllers.MarketAdv.CUSTOM_PERIOD
@import AdnShownTypes._

@* sink show level checkbox - базовая верстка чекбокса уровней отображения по любому из измерений. *@
@sslCheckbox(maybeBusyAdv: Option[MAdvI], mid: Int, fnSuffix: String, label: String)(busyAttrs: => Html) = {
  <label>
    <input type="checkbox" id="node_@{mid}_@fnSuffix"
      @maybeBusyAdv.fold {
        name="node[@mid].@fnSuffix" value="true" checked="checked" data-checked="checked"
      } { busyAdv =>
        disabled="disabled" @busyAttrs
      }
    />
    @label
  </label>
}

@* Генератор чекбоксов, задающих/с заданными уровнями отображения. *@
@slCheckbox(maybeBusyAdv: Option[MAdvI], mid: Int, fnSuffix: String, sl: AdShowLevel, label: String) = {
  @* TODO Генерить label на основе sl. *@
  @sslCheckbox(maybeBusyAdv, mid, fnSuffix, label) {
    @if(maybeBusyAdv.exists(_ hasOnAdSl sl)) {data-checked="checked"}
  }
}

@* Шаблон чекбокса для выбора sink'а вадачи. *@
@sinkCheckbox(maybeBusyAdv: Option[MAdvI], mid: Int, fnSuffix: String, sink: AdnSink) = {
  @sslCheckbox(maybeBusyAdv, mid, fnSuffix, label = Messages("adn.sink." + sink.longName)) {
    @if(maybeBusyAdv.exists(_ hasOnSink sink)) {data-checked="checked"}
  }
}

<hr class="delimiter __light"/>

<div class="adv-management">
    <div class="adv-management_left-bar">
      <h2 class="minor-title">Выбор города/ места</h2>

      @market.lk.lkBlockNewDesign( open = false ) {
        <div class="js-city">
          <span class="checkbox_title __major __no-input">Выберите город</span>
        </div>
      } {
        <div class="adv-management_city-i js-select-city" data-value="1">Санкт-Петербург</div>
        <div class="adv-management_city-i js-select-city" data-value="2">Москва</div>
      }


      <div class="select-tab_lst js-select-type_w" data-city="1">
        <div class="select-tab_i js-select-type" data-value="-1">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Все места</span>
        </div>
        <div class="select-tab_i js-select-type" data-value="1">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Районы</span>
          <span class="js-active-nodes-count"></span>
        </div>
        <div class="select-tab_i js-select-type" data-value="2">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Кинотеатры</span>
          <span class="js-active-nodes-count"></span>
        </div>
      </div>

      <div class="select-tab_lst js-select-type_w" data-city="2">
        <div class="select-tab_i js-select-type" data-value="-1">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Все места</span>
        </div>
        <div class="select-tab_i js-select-type" data-value="1">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Библиотеки</span>
          <span class="js-active-nodes-count"></span>
        </div>
        <div class="select-tab_i js-select-type" data-value="2">
          <input type="checkbox"/>
          <span class="select-tab_i-title">Рестораны</span>
          <span class="js-active-nodes-count"></span>
        </div>
      </div>

      <div class="select-tab_lst js-select-node_w" data-city="1" data-type="1">
        <h3>Районы</h3>
        @market.lk.lkBlockNewDesign( open = false ) {
          <input type="checkbox"/>
          <span class="checkbox_title __major">Московский</span>
        } {
          <div class="advm-node_block">
            <div class="advm-node_left">Размещение</div>
            <div class="advm-node_right">
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Главный экран</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Категории товаров</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Wi-Fi</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">GEO локация</span>
              </label>
            </div>
          </div>
          <hr class="delimiter __light advm-node_delimiter"/>
          <div class="advm-node_block">
            <label class="f-left">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Каталог</span>
            </label>
            <label class="f-right">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Suggest.io</span>
            </label>
          </div>
        }
        @market.lk.lkBlockNewDesign( open = false ) {
          <input type="checkbox"/>
          <span class="checkbox_title __major">Невский</span>
        } {
          <div class="advm-node_block">
            <div class="advm-node_left">Размещение</div>
            <div class="advm-node_right">
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Главный экран</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Категории товаров</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Wi-Fi</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">GEO локация</span>
              </label>
            </div>
          </div>
          <hr class="delimiter __light advm-node_delimiter"/>
          <div class="advm-node_block">
            <label class="f-left">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Каталог</span>
            </label>
            <label class="f-right">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Suggest.io</span>
            </label>
          </div>
        }
      </div>

      <div class="select-tab_lst js-select-node_w" data-city="1" data-type="2">
        <h3>Кинотеатры</h3>
        @market.lk.lkBlockNewDesign( open = false ) {
          <input type="checkbox"/>
          <span class="checkbox_title __major">Московский</span>
        } {
          <div class="advm-node_block">
            <div class="advm-node_left">Размещение</div>
            <div class="advm-node_right">
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Главный экран</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Категории товаров</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Wi-Fi</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">GEO локация</span>
              </label>
            </div>
          </div>
          <hr class="delimiter __light advm-node_delimiter"/>
          <div class="advm-node_block">
            <label class="f-left">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Каталог</span>
            </label>
            <label class="f-right">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Suggest.io</span>
            </label>
          </div>
        }
        @market.lk.lkBlockNewDesign( open = false ) {
          <input type="checkbox"/>
          <span class="checkbox_title __major">Невский</span>
        } {
          <div class="advm-node_block">
            <div class="advm-node_left">Размещение</div>
            <div class="advm-node_right">
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Главный экран</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Категории товаров</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">Wi-Fi</span>
              </label>
              <label class="checkbox_w">
                <input type="checkbox"/><span class="checkbox_title">GEO локация</span>
              </label>
            </div>
          </div>
          <hr class="delimiter __light advm-node_delimiter"/>
          <div class="advm-node_block">
            <label class="f-left">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Каталог</span>
            </label>
            <label class="f-right">
              <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Suggest.io</span>
            </label>
          </div>
        }
      </div>

    </div>
    <div class="adv-management_right-bar">
      <h2 class="minor-title">Выбор даты</h2>
      <div class="adv-management_date-bar">
        <table class="prop">
          <td class="prop_name">Срок размещение</td>
          <td class="prop_value">
            <div class="input __size-S">
              <select>
                <option>Три дня</option>
                <option>Неделя</option>
                <option>Месяц</option>
                <option>Задать интервал</option>
              </select>
            </div>
          </td>
        </table>
        <table class="prop">
          <td class="prop_name">Дата начала</td>
          <td class="prop_value">
            <div class="input __size-S">
              <input type="text"/>
            </div>
          </td>
        </table>
        <table class="prop">
          <td class="prop_name">Дата окончания</td>
          <td class="prop_value">
            <div class="input __size-S">
              <input type="text"/>
            </div>
          </td>
        </table>
        <hr class="delimiter __light"/>
        <div class="adv-management_date-value">
          22 августа 2014  -  22 сентября 2014
        </div>
      </div>
    </div>
</div>


<div class="advs-form-block" id="advsFormBlock">
@form(routes.MarketAdv.advFormSubmit(adId)) {
@*form(routes.MarketAdv.getAdvPriceSubmit(adId)) {*@   @* Сабмит для получения стоимости текущей конфигурации размещения. *@

  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.isSuperuser) {
    <div style="padding: 20px 0px;padding: 20px 17px; font-weight: bold; background: #f5f5f5; margin-bottom: 10px; -webkit-border-radius: 10px;">
      <input type="checkbox" name="@af("freeAdv").name" value="true" /> Размещать бесплатно, без подтверждения?
    </div>
  }

  @defining( adnNodes.groupBy{ n => AdnShownTypes.withName(n.adn.shownTypeId) }.mapValues(_.sortBy(_.meta.name)) )  {  adnNodesMap =>

    @* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
    @af.globalError.map { ge =>
      <p>Возникла проблема: @Messages(ge.message, ge.args : _*)</p>
    }

    @* Рендерим табы по типам узлов. *@
    <div class="advs-form-block__tabs">
      @adnNodesMap.zipWithIndex.map { case ((memberType, _), i) =>
        <div class="advs-form-block__tabs-single-tab mt-tab @if( i == 0 ){ advs-form-block__tabs-single-tab_active }" data-member-type="@memberType">@Messages("amts.of.type." + memberType) <span class="mt-tab-@memberType-counter-c" style="display: none;">(<span class="mt-tab-@memberType-counter">1</span>)</span></div>
      }
      <div class="clear"></div>
    </div>

    @* Рендерим содержимое табов, т.е. таблички в рамках одной категории узла *@
    <div class="advs-form-block__nodes advs-nodes">
      @defining( now.plusDays(1) ) { tomorrow1 =>
      @defining( tomorrow1.plusDays(1) ) { tomorrow2 =>
      @defining( (QuickAdvPeriods.ordered.map(_.isoPeriod) ++ List(CUSTOM_PERIOD)).map(ps => ps -> Messages("adv.period." + ps)) ) { periodOptions =>
      @adnNodesMap.zipWithIndex.map { case ((memberType, adnNodes), i) =>
        <div class="mt-block mt-@memberType-block" @if( i > 0 ){style="display: none;"}>
        @adnNodes.iterator.zipWithIndex.map { case (node, i) =>
          @defining(args.busyAdns.get(node.id.get)) { maybeBusyAdv =>
          @* Более-менее устойчивый числовой id (mid) нужен для использования в list mapping. Из-за вкладок умножаем на номер вкладки (номер типа). *@
          @defining((memberType.id + 1) * (i + 1)) { mid =>
          <div class="advs-nodes__node @if(maybeBusyAdv.isDefined){advs-nodes__node_active} @if( i % 2 == 0 ){ advs-nodes__node_even }" id="advs@mid">

            @* Галочка включения узла в публикацию. Если busy, то уже занято. *@
            @if(maybeBusyAdv.isDefined) {
              @* Узел уже одобрил или рассматривает предложение. Нельзя влиять на галочку. *@
              <input type="checkbox" checked="checked" disabled="disabled" data-checked="checked"/>
            } else {
              @* Узел может принять рекламную карточку. *@
              <input type="hidden" name="node[@mid].adnId" value="@node.id"/>
              @defining( s"node[$mid].advertise" ) { fn =>
                <input data-connected-field="advs@mid" type="checkbox" id="node_@{mid}_onStartPage" name="@fn" value="true" />
              }
            }

            <strong>
              <a class="blue-link js-btn" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(node.id.get)">@node.meta.name</a>
            </strong>@if(node.meta.town.isDefined  &&  node.adn.shownTypeId.showWithTown) {/ @node.meta.town}


            @if(maybeBusyAdv.isDefined) {
            <div class="advs-nodes__node-dates advs-node-dates">
              @maybeBusyAdv.get.dateStart.toLocalDate - @maybeBusyAdv.get.dateEnd.toLocalDate
            </div>
            } else {
            <div class="advs-nodes__node-dates advs-nodes__node-dates_hidden advs-node-dates">
                @select(
                  af(s"node[$mid].period.period"),
                  options = periodOptions,
                  '_label -> "Срок размещения:"
                )

              <label class="advs-node-dates__elt">Дата начала</label>
              <input class="advs-node-dates__elt js-datepicker advs-node-dates__input" type="text" name="node[@mid].period.date.start" value="@formatDateDeficedYYYYmmDD(tomorrow1)"/>
              <label class="advs-node-dates__elt"><strong>&mdash;</strong></label>
              <label class="advs-node-dates__elt">Дата конца</label>
              <input class="advs-node-dates__elt js-datepicker advs-node-dates__input" type="text" name="node[@mid].period.date.end" value="@formatDateDeficedYYYYmmDD(tomorrow2)"/>
              <div class="clear"></div>
            </div>
            }

            @* Перечисление уровней отображения: главный экран, категории и т.д. *@
            <div class="advs-nodes__node-options @if(maybeBusyAdv.isEmpty) { advs-nodes__node-options_hidden }">
              <div><input type="checkbox" id="node_@{mid}_inCatalog" name="" data-checked="checked" disabled="disabled" value="true"/> Каталог</div>
              <div>@slCheckbox(maybeBusyAdv, mid, "showLevel.onRcvrCat", AdShowLevels.LVL_CATS, "Категории товаров и услуг")</div>
              <div>@slCheckbox(maybeBusyAdv, mid, "showLevel.onStartPage", AdShowLevels.LVL_START_PAGE, "Главный экран")</div>
            </div>

            @* Перечисление доступных на узле размещений: geo, wifi, etc *@
            @node.adn.sinks.map { sink =>
              @sinkCheckbox(maybeBusyAdv, mid, "sink." + sink.longName, sink)
            }
          }
          }
          </div>
        }
        </div>
      }
      } @* periodOptions *@
      }
      }
    </div>

  }

  @* Рендерим url для подсчета цены для дальнейшего использования в js *@
  <input type="hidden" id="advsPriceUpdateUrl" value="@routes.MarketAdv.getAdvPriceSubmit(adId)">

  <div class="paragraph __size-L __text-1">
    <div>Стоимость согласно ставке тарифных планов</div>
    <div class="g-price adv-submit-block__price js-pre-price">0 р.</div>
  </div>

  <div class="submit-w __size-M">
    <a class="siom-ac-btn __color-1 __size-M __ft-XM js-submit-btn">Отправить запрос</a>
  </div>

}


</div>
