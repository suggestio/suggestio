@(args: AdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой. *@

@import ctx._
@import helper._
@import util.FormHelpers._
@import args._

@periodOption(isoPeriod: String, text: String, maybeCurrIsoPeriod: Option[String]) = {
  <option value="@isoPeriod" @if(maybeCurrIsoPeriod.exists(_ == isoPeriod)) {selected}>@text</option>
}

@form(routes.MarketAdv.advFormSubmit(adId)) {

  @defining( adnNodes.groupBy(_.adn.memberType).mapValues(_.sortBy(_.meta.name)) )  {  adnNodesMap =>

    @* Рендерим табы по типам узлов. *@
    @adnNodesMap.map { case (memberType, _) =>
      <div>@Messages("amts.of.type." + memberType)</div>
    }

    @* Рендерим содержимое табов, т.е. таблички в рамках одной категории узла *@
    @adnNodesMap.map { case (memberType, adnNodes) =>
      <table>
        @adnNodes.iterator.zipWithIndex.map { case (node, i) =>
          @* числовой id нужен для использования list mapping, хотя в нашем случае вообще не обязателен. *@
          @defining(args.busyAdns.get(node.id.get)) { maybeBusyAdv =>
          @defining(memberType.id * i) { mid =>
            @if(maybeBusyAdv.isEmpty) {
              <input type="hidden" name="node[@mid].adnId" value="@node.id"/>
            }
            <tr>
              @* Галочка включения узла в публикацию. Если busy, то уже занято. *@
              <td>@if(maybeBusyAdv.isDefined) {
                  @* Узел уже одобрил или рассматривает предложение. Нельзя влиять на галочку. *@
                  <input type="checkbox" checked disabled/>
                } else {
                  @* Узел может принять рекламную карточку. *@
                  @checkbox(af(s"node[$mid].advertise"), '_label -> "")
                }</td>
              <td>@node.meta.name / @node.meta.town</td>
              @* Далее, селект длительности и галочка появляются при выставлении первой галочки. *@
              <td>
                <select @if(maybeBusyAdv.isEmpty) {name="node[@mid].period"}>
                  @defining(maybeBusyAdv.map(_.isoPeriod)) { maybeCurrIsoPeriod =>
                    @periodOption("P1D", "На 1 день", maybeCurrIsoPeriod)
                    @periodOption("P3D", "На 3 дня", maybeCurrIsoPeriod)
                    @periodOption("P1W", "На неделю", maybeCurrIsoPeriod)
                    @periodOption("P1M", "На месяц", maybeCurrIsoPeriod)
                  }
                </select>
              </td>
              <td>@if(maybeBusyAdv.isDefined) {
                  <label>
                    На главном экране
                    <input type="checkbox" disabled @if(maybeBusyAdv.get.onStartPage) {checked}/>
                  </label>
                } else {
                  @checkbox(af(s"node[$mid].onStartPage"), '_label -> "На главном экране")
                }
              </td>
            </tr>
          }
          }
        }
      </table>
    }

  }


  <input type="submit" value="Отправить запрос"/>
}
