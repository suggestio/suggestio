@(args: AdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._

@* Генератор чекбоксов, задающих/с заданными уровнями отображения. *@
@slCheckbox(maybeBusyAdv: Option[MAdvI], mid: Int, fnSuffix: String, sl: AdShowLevel) = {
  <input type="checkbox" id="node_@{mid}_@fnSuffix"
    @maybeBusyAdv.fold {
      name="node[@mid].@fnSuffix" value="true" checked="checked" data-checked="checked"
    } { busyAdv =>
      disabled="disabled" @if(busyAdv.showLevels contains sl) {data-checked="checked"}
    }
  />
}

<div class="advs-form-block" id="advsFormBlock">
@form(routes.MarketAdv.advFormSubmit(adId)) {
@*form(routes.MarketAdv.getAdvPriceSubmit(adId)) {*@   @* Сабмит для получения стоимости текущей конфигурации размещения. *@

  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.isSuperuser) {
    <div style="padding: 20px 0px;padding: 20px 17px; font-weight: bold; background: #f5f5f5; margin-bottom: 10px; -webkit-border-radius: 10px;">
      <input type="checkbox" name="af("freeAdv")" /> Размещать бесплатно, без подтверждения?
    </div>
  }

  @defining( adnNodes.groupBy(_.adn.memberType).mapValues(_.sortBy(_.meta.name)) )  {  adnNodesMap =>

    @* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
    @af.globalError.map { ge =>
      <p>Возникла проблема: @Messages(ge.message, ge.args : _*)</p>
    }

    @* Рендерим табы по типам узлов. *@
    <div class="advs-form-block__tabs">
      @adnNodesMap.zipWithIndex.map { case ((memberType, _), i) =>
        <div class="advs-form-block__tabs-single-tab mt-tab @if( i == 0 ){ advs-form-block__tabs-single-tab_active }" data-member-type="@memberType">@Messages("amts.of.type." + memberType) <span class="mt-tab-@memberType-counter-c" style="display: none;">(<span class="mt-tab-@memberType-counter">1</span>)</span></div>
      }
      <div class="clear"></div>
    </div>

    @* Рендерим содержимое табов, т.е. таблички в рамках одной категории узла *@
    <div class="advs-form-block__nodes advs-nodes">
      @defining( now.plusDays(1) ) { tomorrow1 =>
      @defining( tomorrow1.plusDays(1) ) { tomorrow2 =>
      @adnNodesMap.zipWithIndex.map { case ((memberType, adnNodes), i) =>
        <div class="mt-block mt-@memberType-block" @if( i > 0 ){style="display: none;"}>
        @adnNodes.iterator.zipWithIndex.map { case (node, i) =>
          @defining(args.busyAdns.get(node.id.get)) { maybeBusyAdv =>
          @* Более-менее устойчивый числовой id (mid) нужен для использования в list mapping. Из-за вкладок умножаем на номер вкладки (номер типа). *@
          @defining((memberType.id + 1) * (i + 1)) { mid =>
          <div class="advs-nodes__node @if(maybeBusyAdv.isDefined){advs-nodes__node_active} @if( i % 2 == 0 ){ advs-nodes__node_even }" id="advs@mid">

            @* Галочка включения узла в публикацию. Если busy, то уже занято. *@
            @if(maybeBusyAdv.isDefined) {
              @* Узел уже одобрил или рассматривает предложение. Нельзя влиять на галочку. *@
              <input type="checkbox" checked="checked" disabled="disabled" data-checked="checked"/>
            } else {
              @* Узел может принять рекламную карточку. *@
              <input type="hidden" name="node[@mid].adnId" value="@node.id"/>
              @defining( s"node[$mid].advertise" ) { fn =>
                <input data-connected-field="advs@mid" type="checkbox" id="node_@{mid}_onStartPage" name="@fn" value="true" />
              }
            }

            <a class="advs-nodes__node-link advs-nodes__node-link_show-popup" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(node.id.get)">@node.meta.name</a> / @node.meta.town

            @if(maybeBusyAdv.isDefined) {
            <div class="advs-nodes__node-dates advs-node-dates">
              @maybeBusyAdv.get.dateStart.toLocalDate - @maybeBusyAdv.get.dateEnd.toLocalDate
            </div>
            } else {
            <div class="advs-nodes__node-dates advs-nodes__node-dates_hidden advs-node-dates">
              @* Тут должен быть, селект-календарь длительности и галочка появляются при выставлении первой галочки. *@
              <label class="advs-node-dates__elt">Дата начала</label>
              <input class="advs-node-dates__elt js-datepicker advs-node-dates__input" type="text" name="node[@mid].dateStart" value="@formatDateDeficedYYYYmmDD(tomorrow1)"/>
              <label class="advs-node-dates__elt"><strong>&mdash;</strong></label>
              <label class="advs-node-dates__elt">Дата конца</label>
              <input class="advs-node-dates__elt js-datepicker advs-node-dates__input" type="text" name="node[@mid].dateEnd" value="@formatDateDeficedYYYYmmDD(tomorrow2)"/>
              <div class="clear"></div>
            </div>
            }

            <div class="advs-nodes__node-options @if(maybeBusyAdv.isEmpty) { advs-nodes__node-options_hidden }">
              <div><input type="checkbox" id="node_@{mid}_inCatalog" name="" data-checked="checked" disabled="disabled" value="true"/> Каталог</div>
              <div>@slCheckbox(maybeBusyAdv, mid, "onRcvrCat", AdShowLevels.LVL_MEMBERS_CATALOG) Категории товаров и услуг</div>
              <div>@slCheckbox(maybeBusyAdv, mid, "onStartPage", AdShowLevels.LVL_START_PAGE) Главный экран</div>
            </div>

          }
          }
          </div>
        }
        </div>
      }
      }
      }
    </div>

  }

  @* Рендерим url для подсчета цены для дальнейшего использования в js *@
  <input type="hidden" id="advsPriceUpdateUrl" value="@routes.MarketAdv.getAdvPriceSubmit(adId)">

  <div class="adv-submit-block">
    <div>Стоимость согласно ставке тарифных планов</div>
    <div class="g-price adv-submit-block__price js-pre-price">0 р.</div>
    <a class="green-but-big adv-submit-block__button" id="advsSubmitButton">Отправить запрос</a>
  </div>

}


</div>