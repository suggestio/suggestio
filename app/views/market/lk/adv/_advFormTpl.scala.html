@(args: AdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой. *@

@import ctx._
@import helper._
@import util.FormHelpers._
@import args._

<div class="advs-form-block">
@form(routes.MarketAdv.advFormSubmit(adId)) {

  @defining( adnNodes.groupBy(_.adn.memberType).mapValues(_.sortBy(_.meta.name)) )  {  adnNodesMap =>

    @* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
    @af.globalError.map { ge =>
      <p>Возникла проблема: @Messages(ge.message, ge.args : _*)</p>
    }

    @* Рендерим табы по типам узлов. *@
    <div class="advs-form-block__tabs">
    @adnNodesMap.zipWithIndex.map { case ((memberType, _), i) =>
      <div class="advs-form-block__tabs-single-tab @if( i == 0 ){ advs-form-block__tabs-single-tab_active }">@Messages("amts.of.type." + memberType)</div>
    }
      <div class="clear"></div>
    </div>

    @* Рендерим содержимое табов, т.е. таблички в рамках одной категории узла *@
    <div class="advs-form-block__nodes">
      @adnNodesMap.map { case (memberType, adnNodes) =>
        @adnNodes.iterator.zipWithIndex.map { case (node, i) =>
          <div class="advs-form-block__nodes-node">
          @* числовой id нужен для использования list mapping, хотя в нашем случае вообще не обязателен. *@
          @defining(args.busyAdns.get(node.id.get)) { maybeBusyAdv =>
          @defining((memberType.id + 1) * (i + 1)) { mid =>

            @* Галочка включения узла в публикацию. Если busy, то уже занято. *@
            @if(maybeBusyAdv.isDefined) {
              @* Узел уже одобрил или рассматривает предложение. Нельзя влиять на галочку. *@
              <input type="checkbox" checked disabled/>
            } else {
              @* Узел может принять рекламную карточку. *@
              <input type="hidden" name="node[@mid].adnId" value="@node.id"/>
              <input type="checkbox" id="node_@{mid}_onStartPage" name="node[@mid].advertise" value="true">
            }

            <a href="@routes.MarketLkBilling._renderNodeMbmdsWindow(node.id.get)">@node.meta.name</a> / @node.meta.town

            @if(maybeBusyAdv.isDefined) {
              @maybeBusyAdv.get.dateStart.toLocalDate - @maybeBusyAdv.get.dateEnd.toLocalDate
            } else {
              @* Тут должен быть, селект-календарь длительности и галочка появляются при выставлении первой галочки. *@
              <input type="hidden" name="node[@mid].dateStart" value="2014-05-28"/>
              <input type="hidden" name="node[@mid].dateEnd" value="2014-05-29"/>
            }

            @if(maybeBusyAdv.isDefined) {
            <label>
              На главном экране
              <input type="checkbox" disabled @if(maybeBusyAdv.get.onStartPage) {checked}/>
            </label>
            } else {
              <input type="checkbox" id="node_@{mid}_onStartPage" name="node[@mid].onStartPage" value="true">
            }

          }
          }
          </div>
        }
      }
    </div>

  }


  <input type="submit" value="Отправить запрос"/>
}

</div>