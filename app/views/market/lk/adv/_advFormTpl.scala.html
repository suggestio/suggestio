@(args: AdvFormTplArgs)(implicit ctx: Context)

@* Форма для размещения рекламы (ADVertising) на узлах-получателях рекламной сети.
   Отображается на странице управления рекламной карточкой.
   TODO form unapply не работает из-за использования list mapping. *@

@import ctx._
@import helper._
@import util.FC.tdFc
@import util.DateTimePrettyPrinter._
@import args._
@import controllers.MarketAdv.{CUSTOM_PERIOD, NODES_KM}
@import AdnShownTypes._


@* sink show level checkbox - базовая верстка чекбокса уровней отображения по любому из измерений. *@
@sslCheckbox(maybeBusyAdv: Option[MAdvI], midOpt: Option[Int], fnSuffix: String, label: String)(busyAttrs: => Html) = {
  <label class="block">
    <input type="checkbox"
      @maybeBusyAdv.fold {
        @* Рендер аттрибутов инпута когда существующего размещения ещё нет (т.е. всё можно размещать). *@
        name="@{NODES_KM}[@midOpt].@fnSuffix"
        value="false"
      } { busyAdv =>
        @* Рендер атрибутов инпута, если размещение уже было сделано ранее. *@
        value="true"
        disabled="disabled" @busyAttrs
      }
    /><span class="checkbox_title">@label</span>
  </label>
}

@* Генератор чекбоксов, задающих/с заданными уровнями отображения. *@
@slCheckbox(maybeBusyAdv: Option[MAdvI], midOpt: Option[Int], fnSuffix: String, sl: AdShowLevel, label: String) = {
  @* TODO Генерить label на основе sl. *@
  @sslCheckbox(maybeBusyAdv, midOpt, fnSuffix, label) {
    @if(maybeBusyAdv.exists(_ hasOnAdSl sl)) {data-checked="checked"}
  }
}

@* Шаблон чекбокса для выбора sink'а вадачи. *@
@sinkCheckbox(maybeBusyAdv: Option[MAdvI], midOpt: Option[Int], sink: AdnSink) = {
  @sslCheckbox(maybeBusyAdv, midOpt, "sink." + sink.longName, label = Messages("adn.sink." + sink.longName)) {
    @if(maybeBusyAdv.exists(_ hasOnSink sink)) {data-checked="checked"}
  }
}

<hr class="delimiter __light"/>

<div class="adv-management" id="advsFormBlock">

@* Глобальная ошибка в форме проявляется, если например недостаточно денег на счете. *@
@af.globalError.map { ge =>
  <p>Возникла проблема: @Messages(ge.message, ge.args : _*)</p>
}

@form(routes.MarketAdv.advFormSubmit(adId)) {
@*form(routes.MarketAdv.getAdvPriceSubmit(adId)) *@   @* Сабмит для получения стоимости текущей конфигурации размещения. *@
  @* Суперюзерам доступно беплатное размещение на любом узле. *@
  @if(ctx.isSuperuser) {
    <div style="padding: 20px 0px;padding: 20px 17px; font-weight: bold; background: #f5f5f5; margin-bottom: 10px; -webkit-border-radius: 10px;">
      <label>
        <input type="checkbox" name="@af("freeAdv").name" value="true" />
        Размещать бесплатно, без подтверждения?
      </label>
    </div>
  }

  <div class="adv-management_left-bar">
    <h2 class="minor-title">Выбор города/ места</h2>

      @* Список городов. *@
      @market.lk.lkBlockNewDesign( open = false ) {
        <div class="js-city">
          <span class="checkbox_title __major __no-input">Выберите город</span>
        </div>
      } {
        @args.cities.map { city =>
          <div class="adv-management_city-i js-select-city" data-value="@city.i">@city.node.meta.name</div>
        }
      }

      @* Списки-вкладки категорий в городах. *@
      @args.cities.map { city =>
        <div class="select-tab_lst js-select-type_w" data-city="@city.i">
          <div class="select-tab_i js-select-type" data-value="-1">
            <input type="checkbox"/>
            <span class="select-tab_i-title">Все места</span>
          </div>
          @city.cats.map { cat =>
            <div class="select-tab_i js-select-type" data-value="@cat.i">
              <input type="checkbox"/>
              <span class="select-tab_i-title">@cat.name</span>
              <span class="js-active-nodes-count"></span>
            </div>
          }
        </div>
      }

      @* Рендер списков узлов в городах. *@
      @args.cities.map { city =>
        @city.cats.map { cat =>
          <div class="select-tab_lst js-select-node_w" data-city="@city.i" data-type="@cat.i">
            <h3 class="adv-management_cat-title">@cat.name</h3>
            @cat.nodes.map { an =>
              @defining( an.node.id.get ) { adnId =>
              @defining( args.adnId2formIndex.get(adnId) ) { midOpt =>
              @defining( args.busyAdvs get adnId ) { maybeBusyAdv =>
                @if(maybeBusyAdv.isEmpty) {
                  @market.lk.lkBlockNewDesign( open = false ) {
                    <input type="checkbox" name="@{NODES_KM}[@midOpt].advertise" value="false"/>
                    <input type="hidden" name="@{NODES_KM}[@midOpt].adnId" value="@adnId"/>
                    <span class="checkbox_title __major">
                      <a class="link js-btn" href="@routes.MarketLkBilling._renderNodeMbmdsWindow(adnId)">
                        @an.node.meta.name
                      </a>
                    </span>
                  } {
                    <div class="advm-node_block">
                      <div class="advm-node_left">
                        <p class="block">Отображение</p>
                        <div class="block __margin-XS">
                          <hr class="delimiter __light"/>
                        </div>
                        @* Галочки уровней отображения. *@
                        @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onStartPage", AdShowLevels.LVL_START_PAGE, "Главный экран")
                        @slCheckbox(maybeBusyAdv, midOpt, "showLevel.onRcvrCat", AdShowLevels.LVL_CATS, "Категории товаров")
                        <label class="block">
                          <input type="checkbox" disabled="disabled" checked="checked"/><span class="checkbox_title __disabled">Каталог</span>
                        </label>
                      </div>
                      <div class="advm-node_right">
                        <p class="block">Таргетинг</p>
                        <div class="block __margin-XS">
                          <hr class="delimiter __light"/>
                        </div>
                        @* Галочки sink'ов выдачи. *@
                        @an.node.adn.sinks.iterator.map { sink =>
                          @sinkCheckbox(maybeBusyAdv, midOpt, sink)
                        }
                      </div>
                    </div>
                  }
                } else {
                  <div class="slide-block_title">
                    <span class="checkbox_title __major">
                      <a href="#" class="link">@an.node.meta.name</a>
                    </span>
                    <span class="ft-S light-gray"> (размещено)</span>
                  </div>
                }
              } @* lkBlockNewDesign cnt *@
              } @* mid *@
              } @* adnId *@
            } @* node in cat *@
          </div>
        } @* cat in city *@
      } @* city *@

    </div> @* adv-management_left-bar *@


    <div class="adv-management_right-bar">
      <h2 class="minor-title">Выбор даты</h2>

      <div class="date-widget">
        <table class="prop">
          <td class="prop_name">Срок размещение</td>
          <td class="prop_value">
            <div class="input __size-S" >
              <select data-interval="true" data-widget-id="advManagementDateWidget" name="period.period">
                @defining( args.af("period.period").value ) { currPeriod =>
                  @args.advPeriodsAvail.map { case (v, msg) =>
                    <option value="@v" @if(currPeriod.exists(_ equalsIgnoreCase v)) {selected="selected"}>@msg</option>
                  }
                }
              </select>
            </div>
          </td>
        </table>
        <table class="prop" id="advManagementDateStart">
          <td class="prop_name">Дата начала</td>
          <td class="prop_value">
            <div class="input __size-S">
              <input class="js-datepicker" type="text" data-start="true" data-widget-id="advManagementDateWidget" name="period.start" value="@args.af("period.start").value"/>
            </div>
          </td>
        </table>
        <table class="prop" id="advManagementDateEnd">
          <td class="prop_name">Дата окончания</td>
          <td class="prop_value">
            <div class="input __size-S">
              <input class="js-datepicker" type="text" data-end="true" data-widget-id="advManagementDateWidget" name="period.end" value="@args.af("period.start").value"/>
            </div>
          </td>
        </table>
        <hr class="delimiter __light"/>
        <div class="date-widget_result">
          <span id="advManagementDateStartValue"></span>&nbsp;-&nbsp;<span id="advManagementDateEndValue"></span>
        </div>
      </div>

  </div>
}
</div>

