@(node: MAdnNode, mads: Seq[MAd], slaves: Seq[MAdnNode], advertisers: Seq[MAdnNode], isMyNode: Boolean,
  povAdnIdOpt: Option[String], advReqsCount: Long, canAdv: Boolean, ad2advMap: Map[String, MAdvI], showBackBtn: Boolean,
  showAdvsBtn: Boolean)(implicit ctx: Context)

@* Заглавная страница узла рекламной сети в личных кабинетах.
   Если isMyNode, то идёт рендер управляемого узла, и povAdnIdOpt игнорируется.
   Если !isMyNode, то юзер смотрит чужой нередактируемый узел. *@

@import ctx._
@import controllers.adn.AdnShowTypes._
@import _node._


@* Обладают выдачей только ресиверы, поэтому окно с кодом рендерится только для них. *@
@popupContent = {

  @if(isMyNode && node.adn.isReceiver) {
    @_installScriptPopupTpl(node)
  }

}


@market.lk.lkBase(node.meta.name, adnIdOpt = node.id, popupContent = Some(popupContent)) {

  @if(isMyNode) {
    @helper.javascriptRouter("jsRoutes")(
      routes.javascript.MarketAd.updateShowLevelSubmit
    )
  }

  @* Верхняя строка. *@
  <div class="page-title">
    <div class="page-title_cnt">

      @* TODO Надо бы объеденить map и defining, но почему-то не работает оно. *@
      @if(showBackBtn) {
        @defining( if(isMyNode) Some(routes.MarketLk.lkList) else povAdnIdOpt.map(routes.MarketLkAdn.showAdnNode(_)) ) { backCallOpt =>
          @backCallOpt.map { backCall =>
            <a class="back-btn" href="@backCall"></a>
          }
        }
      } else {
        <a class="back-btn __hidden"></a>
      }


      @if(isMyNode) {ЛИЧНЫЙ КАБИНЕТ} else {РЕКЛАМОДАТЕЛЬ}

      @* У узла-приемника/супервизора есть доступ к списку входных продьюсеров рекламы и доступ к коду установки. *@
      @if(isMyNode) {
        @defining(node.adn.isReceiver) { isRcvr =>
          @if(isRcvr || showAdvsBtn || node.adn.isSupervisor) {
            <div class="adn-title-buttons">

              @* Кнопку "рекламодатели" отображать только ресиверу, и только если он не делегировал adv-функции другому узлу. *@
              @if(showAdvsBtn) {

                    <a class="siom-link-btn __size-M __ft-L __color-5 f-right" href="@routes.MarketAdv.showNodeAdvs(node.id.get)">
                      @if(advReqsCount > 0L) {<span class="lk-adv-reqs-count attention-icon">@advReqsCount</span>}
                      РЕКЛАМОДАТЕЛИ
                    </a>

              } @* showAdsvBtn? *@

              @if(isRcvr) {

                <a class="siom-link-btn __size-M __ft-L __color-5 __list-element f-right js-btn" href="#installScriptPopup">СКРИПТ на САЙТ</a>

              } @* isRcvr? *@

            </div>
          }
        }
      }
    </div>
  </div>

  <div class="body_cnt">

      <div class="paragraph __size-M">
        <span class="ft-L node-name">@node.meta.name</span>
        @if(isMyNode) {
          <a class="edit-btn __color-1 __ft-XS" href="@routes.MarketLkAdnEdit.editAdnNode(node.id.get)">
            @Messages("Edit")
          </a>

          <span class="sm-note">
            <span class="sm-note__q-mark">?</span>
            <span class="sm-note__message">
              Подсказка: в редактировании вы можете указать информацию о вашем магазине и загрузить основной логотип, который будет отображаться на всех рекламных карточках.
            </span>
          </span>


          @if(isSuperuser) {
            <a class="superuser-link" href="@routes.SysMarket.showAdnNode(node.id.get)">/sys</a>
          }
        }
      </div>

      <div class="border-line"></div>

      @if(node.meta.town.isDefined) {
        <div class="paragraph __size-M">
          @node.meta.town@if(node.meta.address.isDefined) {, @node.meta.address}
        </div>
        <div class="border-line"></div>
      }

      @if(node.meta.description.isDefined) {
        <p class="paragraph __size-M">
            @_nodeDescrTdTpl(node, style = "border-left: none; padding-left: 0;")
        </p>
        <div class="border-line"></div>
      }

    @* Если указаны этаж/секция, то их напечатать таблицей. *@
    @if(node.meta.floor.isDefined || node.meta.section.isDefined) {
      @_floorSectionTableTpl(node)
      <div class="border-line"></div>
    }

    @* Для тех, кто может создавать свою рекламу, рисуем список своих рекламных карточек с галочками. *@
    @if(node.adn.isProducer) {
      @if(isMyNode) {
        @_myAdsTpl(node, mads, canAdv, ad2advMap)
      } else {
        @_readOnlyAdsListTpl(mads, povAdnIdOpt, ad2advMap)
      }

      @* Ссылка на demo web site. *@
      @if(isMyNode) {
        <div class="sm-note">
          @node.adn.memberType.nodeAdmSiteCall(node).map { siteCall =>
            Вы можете посмотреть, как выглядят ваши к карточки в <a class="blue-link" target="_blank" href="@siteCall">рекламной выдаче</a>
          }
        </div>
      }
    }


    @* Ресиверу надо отрендерить список его рекламодателей, если они есть. *@
    @if(isMyNode && !advertisers.isEmpty) {
      @_advertisersListTpl(advertisers, povAdnIdOpt = node.id)
    }


    @* Супервизору надо отрендерить табличку подчиненых узлов: для реализации надзорных полномочий.
       Если этот узел не может супервайзить, то slaves должен быть пустым. *@
    @if(isMyNode && !slaves.isEmpty) {
      @_supShowNodesTpl(node, slaves)
    }

  </div>


}
