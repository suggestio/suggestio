@(node: MAdnNode, mads: Seq[MAd] = Nil, canAdv: Boolean, ad2advMap: Map[String, MAdvI])(implicit ctx: Context)

@* Список рекламных карточек для создателя рекламы. В нём галочки есть. *@
@import market.lk.ad._
@import ctx._

@* Флаг single переименовывает единственную галочку "Выводить". *@
@defining(node.adn.showLevelsInfo.out4render) { outLvlMap =>

  @* Раскрыть для скриптов текущую информацию о лимитах по кол-ву объяв на доступных уровнях отображения. *@
  @outLvlMap.map { case (sl, (slAllowed, slMax)) =>
    <input id="maxShownAds_@sl" type="hidden" value="@slMax"/>
  }

  @_adsListOuterTpl {

    @helper.javascriptRouter("jsRoutes")(
      routes.javascript.MarketAd.updateShowLevelSubmit
    )


    <a class="add-adv-btn f-left" href="@routes.MarketAd.createAd(node.id.get)">
      <span>Создать<br/>карточку</span>
    </a>

    @defining(outLvlMap.size == 1) { isSingleOutLvl =>
      @_adsListTpl(mads, coverDisableReason = true) { mad =>

        <div class="js-equal-height">
        @ad2advMap.get(mad.id.get).fold {
          <a class="adv-item_edit-btn" href="@routes.MarketAd.editAd(mad.id.get)">
            <span></span>
          </a>
        } { adv =>
            @adv match {
              case advReq: MAdvReq => {
                <a class="adv-item_status __request js-btn" href="@routes.MarketAdv.advFullWnd(mad.id.get, advId = adv.id, r = ctx.r)"></a>
              }
              case advOk: MAdvOk => {
                <a class="adv-item_status __ok js-btn" href="@routes.MarketAdv.advFullWnd(mad.id.get, advId = adv.id, r = ctx.r)"></a>
              }
              case advRefused: MAdvRefuse => {
                @* Этот код по идее никогда не должен выполняться: *@
                Отказано<br/>в размещении
              }
            }
            @* Суперюзеры могут редактировать даже опубликованные карточки. *@
            @if(ctx.isSuperuser) {
              <a class="adv-item_edit-btn" href="@routes.MarketAd.editAd(mad.id.get)">@Messages("Edit")</a>
            }
        }

        @* Галочки для управления отображением рекламной карточки магазина.
           Отображаются, если модератор не запретил бесплатное размещение этой карточки. *@
        @mad.moderation.freeAdv.filter(!_.isAllowed).fold {

          @* Бесплатное размещение не запрещено. *@
          <div class="ads-list-block__controls">
            @defining( mad.receivers.get(node.id.get).map(_.allShowLevels).getOrElse(Set.empty) ) { adSls =>
              @* Обходим карту уровней, переводя её в список галочек. *@
              @outLvlMap.map { case (sl, (slAllowed, slMax)) =>
                @defining(node.adn.canOutAtLevel(sl)) { hl =>
                  <label class="@sl.checkboxCssClass@if(!slAllowed){ inactive}">
                    <input class="@if(slMax == 1){js-one-}checkbox" type="checkbox"
                           data-level="@sl" data-adid="@mad.id" data-name="@sl.checkboxCssClass"
                           @if(!slAllowed) {disabled="disabled"} @if(adSls contains sl) {data-checked="checked"}
                           />
                          <span class="styled-checkbox"><span>&nbsp;@Messages(if(isSingleOutLvl) "lk.sl.enable_ad" else "lk.sl." + sl.name)
                  </label>
                }
              }
            }
          </div><!-- .ads-list-block__controls end -->
        } { faMdr =>
          @* Модератор запретил бесплатное размещение указанное карточки. *@
          @faMdr.reason
        }
        </div><!-- .js-equal-height end -->
          @if(canAdv) {
              <a class="btn __size-XM __radial-major" href="@routes.MarketAdv.advForAd(mad.id.get)">
                Управление
              </a>
          }


      } @* ads list*@
    }

    <div class="clear"></div>
  }
}
