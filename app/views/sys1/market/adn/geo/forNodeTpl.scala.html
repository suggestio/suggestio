@(adnNode: MAdnNode, geos: Seq[MAdnNodeGeo], parentsMap: Map[String, MAdnNode])(implicit ctx: Context)

@* Вывод гео-информации по узлу. *@

@import ctx._
@import datetime._
@import stuff._

@* Отрендерить список нод на основе списка id нод. Используется карта parentsMap для доступа к инфе по узлу. *@
@_renderNodes(nodesIds: Traversable[String]) = {
  @nodesIds.map { parentId =>
    <a href="@routes.SysMarket.showAdnNode(parentId)">
      @parentsMap.get(parentId).fold {
        @parentId
      } { parentNode =>
        <span title="@parentNode.meta.town / @parentId">@parentNode.meta.name</span>
      }
    </a>
  }
}


@* Рендер самой страницы. *@
@geoBase("География узла", nodeOpt = Some(adnNode)) {

  <h1>География узла <a href="@routes.SysMarket.showAdnNode(adnNode.id.get)">@adnNode.meta.name</a></h1>

  @if(geos.nonEmpty) {
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>URL</th>
          <th>Level</th>
          <th>Shape</th>
          <th>Last-Modified</th>
          <th>version</th>
          <th>Другое</th>
        </tr>
      </thead>
      <tbody>
        @geos.map { geo =>
          <tr>
            <td><span title="@geo.id">@geo.id.get.substring(0, 4)...</span></td>
            <td>@geo.url.map { url =><a href="@url" target="_blank">Go</a>}</td>
            <td>@geo.glevel.precision</td>
            <td>
              <a href="@routes.SysAdnGeo.showGeoJson(geo.id.get, geo.adnId)">
                <span title='@geo.shape'>@geo.shape.getClass.getSimpleName</span>
              </a>
            </td>
            <td>@_prettyDate(geo.lastModified)</td>
            <td>@geo.versionOpt</td>
            <td>
              <a href="@if(geo.isCircle){@routes.SysAdnGeo.editCircle(geo.id.get, geo.adnId)} else {@routes.SysAdnGeo.editNodeOsm(geo.id.get, geo.adnId)}">@Messages("Edit")</a>
            </td>
          </tr>
        }
      </tbody>
    </table>
  }

  <p>
    <a href="@routes.SysAdnGeo.createForNodeOsm(adnNode.id.get)">Добавить OSM-контур к этому узлу...</a>
  </p>

  <p>
    <a href="@routes.SysAdnGeo.createCircle(adnNode.id.get)">Добавить круг...</a>
  </p>

  <p>
    <a href="http://geojsonlint.com/">Визуальная проверка GeoJSON.</a>
  </p>


  <br/><br/>
  <h1>Геоданные узла</h1>
  @if(adnNode.geo.isEmpty) {
    Отсутствуют.
    <a href="@routes.SysAdnGeo.editAdnNodeGeodataPropose(adnNode.id.get)">Попробовать автозаполнение геоданных...</a>
  } else {
    @adnNode.geo.point.map { point =>
      Точка: lat=@point.lat lon=@point.lon<br/>
    }

    @if(adnNode.geo.directParentIds.nonEmpty) {
      <p>
        Геородительские узлы:
        @_renderNodes(adnNode.geo.directParentIds)
      </p>
    }

    @if(adnNode.geo.allParentIds.nonEmpty) {
      <p>
        Все геородительские узлы:
        @_renderNodes(adnNode.geo.allParentIds)
      </p>
    }
  }

  <a href="@routes.SysAdnGeo.editAdnNodeGeodata(adnNode.id.get)">Редактировать...</a>

}
