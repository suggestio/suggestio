@(mads: Seq[MAd], nodeOpt: Option[MAdnNode], adFreqs: AdFreqs_t, rcvrs: Seq[MAdnNode], a: AdSearch, ad2advMap: Map[String, Traversable[MAdvI]])(implicit ctx: util.Context)

@* Список реклам и сервисных функций. *@

@import util.TplDataFormatUtil._
@import AdStatActionsTpl._
@import ctx._
@import helper._
@import market.lk.ad._
@import datetime._


@hPathAfter1 = {
  / Реклама
}

@headAfter = {
  <link rel="stylesheet" type="text/css" href='@routes.Assets.at("stylesheets/market/lk/ads-list.css")'/>
  <link rel="stylesheet" type="text/css" href='@routes.Assets.at("stylesheets/market/showcase.css")'/>
}

@defining( nodeOpt.orElse(rcvrs.headOption) ) { thisNode =>
@adnBase(
  title = "Рекламные карточки",
  headAfter = Some(headAfter),
  hPathAfter = Some(hPathAfter1),
  nodeOpt = thisNode
) {

  <div class="ovh">
    @_adsListTpl(mads, coverDisableReason = false, startIndex = 0, itemsInLine = 4) { mad =>
      <a class="siom-ac-btn __color-2 __size-XL __ft-XM __list-vertical" href="@routes.MarketAd.editAd(mad.id.get)">Редактор карточки</a>
      <a class="siom-link-btn __color-3 __size-XL __ft-XM __list-vertical" href="@routes.MarketLkAdn.showAdnNode(mad.producerId)">ЛК создателя карточки</a>
      <p>Отобразить email-сообщение о деактивации:
        @Seq(true -> "HTML", false -> "TXT").map { case (isHtml, linkText) =>
          <a class="blue-link" href="@routes.SysMarket.showShopEmailAdDisableMsg(mad.id.get, isHtml = isHtml)">@linkText</a>
        }
      </p>

      @nodeOpt.map { adnNode =>
        @* Вывод статистики для узла-продьюсера. *@
        <p>Stat:
          @adFreqs.get(mad.id.get).map { freqs =>
            За последние @MAdStat.TTL_DAYS_DFLT дней:
            @freqs.map { case (action, freq) =>
              @action: @freq
            }
          }
        </p>
        @adStatActionsSeq.map { case (asa, txt) =>
          @adnNode.adn.supId.orElse(adnNode.id).map { adnNodeId =>
            @form( routes.Market.adStats(adnNodeId, adId = mad.id.get, action = asa.toString) ) {
              <a class="siom-ac-btn __color-3 __size-XL __ft-XM __list-vertical js-submit-btn">Имитировать @Messages(txt)</a>
            }
          }
        }
      }

      @if(rcvrs.nonEmpty) {
        <br/>
        @rcvrs.map { rcvr =>
          @form( routes.SysMarket.removeAdRcvr(adId = mad.id.get, rcvrId = rcvr.id.get) ) {
            <a class="siom-ac-btn __color-3 __size-XL __ft-XM __list-vertical js-submit-btn">Убрать из выдачи<br/>на узле<br/><strong>&laquo;@rcvr.meta.name / @rcvr.meta.town &raquo;</strong></a>
          }
        }
      }

      @if( thisNode.flatMap(_.id) exists { adnId => mad.receivers.get(adnId).exists(_.slsPub.nonEmpty)} ) {
        <p>Саморазмещение</p>
      }

      @mad.id.flatMap(ad2advMap.get).map { advs =>
        @advs.map { adv =>
          <p>
            @adv.mode match {
              case MAdvModes.OK         => { Принятое }
              case MAdvModes.REQ        => { Запрошенное }
              case MAdvModes.REFUSED    => { Отклонённое }
            }
            @adv.maybeOk.map { advOk =>
              @if(advOk.isAuto) {авто}
            }размещение
            c [@_prettyDate(adv.dateStart, withSpan = true)]
            по [@_prettyDate(adv.dateEnd, withSpan = true)]
            <a class="blue-link" href="@routes.SysMarket.showAdnNode(adv.prodAdnId)">узел</a>
            =&gt;
            <a class="blue-link" href="@routes.SysMarket.showAdnNode(adv.rcvrAdnId)">узел</a>
            @adv.maybeOk.map { advOk =>
              @if(advOk.isPartner) {по-партнёрски}
            }
            за @formatPrice(adv.amount, adv.currency)
            @adv.comission.map { c =>
              с комиссией @formatPercent(c)
            }
          </p>
        }
      }
      <br/><br/>
    }
  </div>

  <br/><br/>

  @* Рендерим переключение страниц. *@
  Страницы:
  @if( a.offsetOpt.exists(_ > 0) ) {
    <a class="blue-link" href="@routes.SysMarket.showAdnNodeAds(a.copy(offsetOpt = None))">Первая</a>
  }
  @if(a.offsetOpt.isDefined) {
    <a class="blue-link" href="@routes.SysMarket.showAdnNodeAds( a.copy(offsetOpt = a.offsetOpt.map {_ - a.maxResults}) )">Предыдущая</a>
  }
  <strong class="color-strong">@(a.offset / a.maxResults)</strong>
  <a class="blue-link" href="@routes.SysMarket.showAdnNodeAds( a.copy(offsetOpt = Some(a.offsetOpt.getOrElse(0) + a.maxResults) ))">Следующая</a>
}
}

