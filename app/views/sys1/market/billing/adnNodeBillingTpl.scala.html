@(adnNode: MAdnNode, args: SysAdnNodeBillingArgs)(implicit ctx: util.Context)

@* Страница с информацией по биллингу указанного узла рекламной сети. *@
@import datetime._
@import ctx._
@import stuff._
@import args._
@import util.TplDataFormatUtil._
@import AdStatActionsTpl._

@billingBase("Биллинг", Some(adnNode)) {

  @balanceOpt.map { balance =>
    <p>Текущий баланс: @balance.amount @balance.currencyCode</p>
  }

  <h2>Контракты (@contracts.size)</h2>
  <a href="@routes.SysMarketBilling.createContractForm(adnNode.id.get)">Создать контракт...</a>
  @if(contracts.isEmpty) {
    <p>Пока нет заключенных договоров.</p>
  } else {
    @contracts.map { contract =>
      <h3>Договор № @contract.legalContractId</h3>
      <a href="@routes.SysMarketBilling.editContractForm(contract.id.get)">Изменить...</a>
      <br/>Дата заключения договора:
          @contract.printContractDate
          (@_prettyDate(contract.contractDate, withSpan = true))
      <p>Добавлен в sio: @_prettyDate(contract.dateCreated, withSpan = true)</p>
      @if(!contract.isActive) {
        <br/><b>Не активен</b>.
      }
      @contract.hiddenInfo.map { hiddenInfo =>
        <br/>Служебная информация:
        <pre>@hiddenInfo</pre>
      }


      @defining(feeTariffsMap.get(contract.id.get).getOrElse(Nil)) { tariffs =>
        @if( !tariffs.isEmpty ) {
          <h4 title="Тарифы абон.платы используются для периодического списания денег со счета по договору.">
            Абон.плата по договору @contract.legalContractId (@tariffs.size)
          </h4>
          <table>
            <tr>
              <th>#</th>
              <th>Активен?</th>
              <th>Имя</th>
              <th>Интервал</th>
              <th>Абон.плата</th>
              <th>Старт</th>
              <th>Действия</th>
            </tr>
            @tariffs.map { tariff =>
              @defining(contract.isActive && tariff.isEnabled) { te =>
              <tr>
                <td>@tariff.id</td>
                <td>@tariff.isEnabled</td>
                <td>@tariff.name</td>
                <td>@_maybeTagged("strike", !te) {@tariff.tintervalPretty}</td>
                <td>@tariff.fee @tariff.feeCC</td>
                <td>@_maybeTagged("strike", !te) {@datetime._prettyDate(tariff.dateFirst, withSpan = true)}</td>
                <td>
                  <a href="@routes.SysMarketBillingTariff.editFeeTariffForm(tariff.id.get)">@Messages("Edit")</a>
                </td>
              </tr>
              }
            }
          </table>
        }
      } @* defining tariffs *@
      <a href="@routes.SysMarketBillingTariff.addFeeTariffForm(contract.id.get)">Добавить абонплату...</a>

      @defining( statTariffsMap.getOrElse(contract.id.get, Nil) ) { tariffs =>
        @if( !tariffs.isEmpty ) {
          <h4 title="Схемы тарификации по просмотрам/переходам используются для освоения денег на балансе в ~реальном времени.">
            Тарификация просмотров/переходов по договору @contract.legalContractId (@tariffs.size)
          </h4>
          <table>
            <tr>
              <th>#</th>
              <th>Активен?</th>
              <th>Имя</th>
              <th>Старт</th>
              <th>Стоимость</th>
              <th>Списано</th>
              <th>Действия</th>
            </tr>
            @tariffs.map { tariff =>
              @defining(contract.isActive && tariff.isEnabled) { te =>
                <tr>
                  <td>@tariff.id</td>
                  <td>@tariff.isEnabled</td>
                  <td>@tariff.name</td>
                  <td>@_maybeTagged("strike", !te) {@datetime._prettyDate(tariff.dateFirst, withSpan = true)}</td>
                  <td>@_maybeTagged("strike", !te) {@formatPrice(tariff.debitAmount, tariff.currency) за @Messages(adStatActionI18N(tariff.debitFor))}</td>
                  <td>@tariff.debitCount.toInt / @tariff.debitedTotal @tariff.currencyCode</td>
                  <td>
                    <a href="@routes.SysMarketBillingTariff.editStatTariff(tariff.id.get)">@Messages("Edit")</a>
                  </td>
                </tr>
              }
            }
          </table>
        }
      }
      <a href="@routes.SysMarketBillingTariff.addStatTariff(contract.id.get)">Добавить тарификацию за просмотры/переходы...</a>

    } @* contract *@

  }

  <br/><br/>
  <h2>Транзакции (@txns.size)</h2>
  @if(!txns.isEmpty) {
    <table>
      <tr>
        <th>id</th>
        <th>Оплачен</th>
        <th>Обработан</th>
        <th>Сумма</th>
        <th>Комментарий</th>
      </tr>
      @txns.map { txn =>
        <tr>
          <td>@txn.txnUid</td>
          <td>@_prettyDate(txn.datePaid, withSpan = true)</td>
          <td>@_prettyDate(txn.dateProcessed, withSpan = true)</td>
          <td>@txn.amount @txn.currencyCode</td>
          <td>@txn.paymentComment</td>
        </tr>
      }
    </table>
  } else {
    Нет транзакций.
  }
  <p><a href="@routes.SysMarketBilling.incomingPaymentForm">Провести платёж...</a></p>

}
