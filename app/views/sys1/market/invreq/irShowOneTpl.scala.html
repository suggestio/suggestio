@(mir: MInviteRequest, mcOpt: Option[MCompany], nodeOpt: Option[MAdnNode], eactOpt: Option[usr.EmailActivation])(implicit ctx: Context)

@* Отображение одного реквеста. *@
@import ctx._
@import stuff.{_yesNoTpl => yn, _deleteSmthFormBtnTpl}
@import helper._
@import sys1.market.adn._
@import sys1.market.company._

@btn(btnText: String, to: Call) = {
  @form(to) {
    <input type="submit" value="@btnText"/>
  }
}

@irBase(title = mir.name) {

  @form( routes.SysMarketInvReq.deleteIR(mir.id.get) ) {
    <input type="submit" value="Удалить этот запрос"/>
  }

  <br/><br/>
  <h3>@Messages("mir.type." + mir.reqType)</h3>


  @* Ответы на вопросы по поводу wi-fi, если есть. *@
  @mir.joinAnswers.map { ja =>
    @ja.haveWifi.map { hw =>
      <p>Wi-Fi оборудование: @yn(hw)</p>
    }
    @ja.fullCoverage.map { fc =>
      <p>Полное покрытие помещения: @yn(fc)</p>
    }
    @ja.knownEquip.map { ke =>
      <p>Известное оборудование: @yn(ke)</p>
    }
    @ja.altFw.map { altFw =>
      <p>Альтернативная прошивка на wi-fi оборудовании: @yn(altFw)</p>
    }
    @ja.isWrtFw.map { isWrt =>
      <p>dd-wrt/openwrt/routerOS: @yn(isWrt)</p>
    }
    @ja.landlineInet.map { llInet =>
      <p>Стационарный интернет: @yn(llInet)</p>
    }
    @ja.smallRoom.map { sr =>
      <p>Малое помещение: @yn(sr)</p>
    }
    @ja.audienceSz.map { auSz =>
      <p>Кол-во пользователей: @Messages("join.qsn.audienceSz." + auSz)</p>
    }
  }

  @defining( mir.company.isRight ) { mcInstalled =>
  @defining( mir.adnNode.exists(_.isRight) ) { nodeInstalled =>

    @* Блок компании. *@
    <br/><br/>
    <div>
      @mcOpt.fold {
        <p>Ошибка доступа к данным компании.</p>
        TODO Нужна кнопка восстановления в шаблон.
      } { mc =>
        <h3>@if(mcInstalled) {@Messages("Company")} else {Шаблон компании}</h3>
        @_companyMetaTpl(mc.meta)
        @if(mcInstalled) {
          Эта компания сейчас <a href="@routes.SysMarket.companyShow(mc.id.get)">существует</a> в системе.
        }
        <a href="@if(mcInstalled) {@routes.SysMarket.companyEditForm(mc.id.get)} else {@routes.SysMarketInvReq.companyEdit(mir.id.get)}">@Messages("Edit")</a>
        @if(mcInstalled) {
          @btn("Деинсталлировать компанию назад в заготовку", routes.SysMarketInvReq.companyUninstallSubmit(mir.id.get))
        } else {
          @if(!nodeInstalled) {
            @btn("Установить компанию в систему", routes.SysMarketInvReq.companyInstallSubmit(mir.id.get))
          }
        }
        @* TODO Нужна замена компании на существующую. *@
      }
    </div>


    @* Блок рекламного узла. *@
    <br/><br/>
    <div>
      @nodeOpt.fold {
        <p>
          Узел не существует даже в виде заготовки.
          <a href="@routes.SysMarketInvReq.nodeEdit(mir.id.get)">Создать заготовку...</a>
        </p>
      } { node =>
        <h3>@if(nodeInstalled) {Узел} else {Шаблон узла}</h3>
        @_nodeMetaTpl(node.meta)
        @if(nodeInstalled) {
          Этот узел сейчас <a href="@routes.SysMarket.showAdnNode(node.id.get)">существует</a> в системе.
        }
        <a href="@if(nodeInstalled) {@routes.SysMarket.editAdnNode(node.id.get)} else {@routes.SysMarketInvReq.nodeEdit(mir.id.get)}">@Messages("Edit")</a>
        @if(mcInstalled) {
          @if(nodeInstalled) {
            @btn("Деинсталировать узла назад в заготовку", routes.SysMarketInvReq.nodeUninstallSubmit(mir.id.get))
          } else {
            @btn("Установить узел в систему", routes.SysMarketInvReq.nodeInstallSubmit(mir.id.get))
          }
        }
      }
    </div>


    @* Блок инвайта на управление узлом. *@
    <br/><br/>
    <div>
      @eactOpt.fold {
        <p>Кажется, инвайт уже использован или был удалён.</p>
        @mir.adnNode.map { adnNodeEith =>
          @adnNodeEith.right.map { adnId =>
            <a href="@routes.SysMarket.nodeOwnerInviteForm(adnId)">Инвайты на управление узлом</a>
          }.right.getOrElse {}
        }
      } { eact =>
        <h3>Инвайт на управление узлом</h3>
        Указанный email: <a href="mailto:@eact.email">@eact.email</a>
        @if(nodeInstalled) {
          @if(mir.emailAct.exists(_.isLeft)) {
            @btn("Выслать инвайт", routes.SysMarketInvReq.eactInstallSubmit(mir.id.get))
          } else {
            @* TODO Кнопка деинсталляция запроса на активацию. *@
          }
          @if(nodeInstalled) {
            <a href="@routes.SysMarket.nodeOwnerInviteForm(mir.adnNode.get.right.get)">Смотреть инвайты на управление узлом...</a>
          }
        }
      }
    </div>

  }
  }


  @* Нарисовать на экране заданные в инвайте платёжные реквизиты. *@
  @mir.payReqsRaw.map { prr =>
    <br/><br/>
    <div>
      <h3>Указаны платёжные реквизиты:</h3>
      <pre>@prr</pre>
    </div>
  }

}
